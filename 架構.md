---

# SaaS 外部 Event-Sourced, Causality-Driven System 架構（含施工日記 FieldLog）

## 1. 外部層：SaaS

* 提供用戶訪問接口
* 功能：

  * 登入 / 認證
  * 用戶界面 (Web / Mobile)
  * API 訪問
* 與系統核心解耦：SaaS 只是部署與使用方式

---

## 2. 系統核心層：Event-Sourced, Causality-Driven System

* **核心架構理念**：

  * Event-Sourced：所有狀態由事件生成，事件不可變
  * Causality-Driven：事件之間有因果關係，可追蹤流程
  * 支援無限子任務拆分
  * 支援現場施工日記（FieldLog）

### 2.1 唯一業務實體：容器 (Aggregate)

* 代表完整業務單位（專案 / 合約 / 訂單）
* 功能：

  * 聚合內所有事件
  * 管理內部狀態一致性
  * 支持多次請款、任務變更、日誌追蹤
  * 支援施工日記 + 日誌

#### 容器內結構

* **任務 (Task)**

  * 狀態：Todo / In Progress / Done
  * 事件：

    * TaskCreated
    * TaskUpdated
    * TaskCompleted
  * 可拆子任務（無限向下）
* **請款 (Invoice / Billing)**

  * 多次請款操作
  * 事件：

    * InvoiceRequested
    * InvoiceApproved
    * InvoicePaid
  * 可附加子任務或審核流程
* **施工日記 FieldLog**

  * 記錄現場每日進度、備註、檢查項目
  * 可附加多媒體（照片 / 文件）
  * 支持每天一條 FieldLog
  * **附加 Log**：

    * TaskStatusChanged
    * InvoiceStatusChanged
    * FieldLogStatusChanged
    * AggregateStateChanged

---

### 2.2 事件流 (Event Stream)

* 每個容器管理自己的事件序列
* 事件順序保證因果：

  ```
  TaskCreated → 子任務 TaskCreated → TaskCompleted 
  → FieldLogCreated + Log → InvoiceRequested → InvoiceApproved → InvoicePaid → 下一天 FieldLog
  ```
* Saga / Process Manager 管理跨 Aggregate / 任務 / 請款 / 日誌因果
* Projection / Read Model 支援：

  * 任務樹狀查詢
  * 多天 FieldLog 查詢與統計
  * 多次請款統計
  * 專案總覽

---

## 3. 外部與內部交互

* SaaS 層調用系統核心：

  * 創建容器 / 任務 / FieldLog / 請款
  * 查詢容器狀態 / 任務列表 / FieldLog / 請款紀錄
* 核心層事件會同步更新：

  * Aggregate 狀態
  * 任務進度
  * FieldLog 日誌
  * 請款狀態

---

## 4. 架構概念圖（文字示意）

SaaS (外部服務)
│
└── Event-Sourced, Causality-Driven System (核心系統)
│
└── 容器 Aggregate (唯一業務實體)
│
├── 任務 Task
│     ├─ TaskCreated
│     ├─ TaskUpdated
│     └─ TaskCompleted
│
├── 請款 Invoice
│     ├─ InvoiceRequested
│     ├─ InvoiceApproved
│     └─ InvoicePaid
│
└── 施工日記 FieldLog + Log
├─ FieldLogCreated
├─ FieldLogUpdated
├─ FieldLogReviewed
├─ TaskStatusChanged
├─ InvoiceStatusChanged
└─ AggregateStateChanged

---

# Event-Sourced, Causality-Driven System 架構圖（文字版流程圖）

SaaS 層 (外部服務)
┌───────────────────────────────┐
│ Web / Mobile / API Interface   │
└───────────────┬───────────────┘
                │
                ▼
核心系統層：Event-Sourced, Causality-Driven System
┌───────────────────────────────┐
│ Aggregate 容器 (唯一業務實體) │
└───────────────┬───────────────┘
                │
                ├─────────────────────────────┐
                │                             │
                ▼                             ▼
           任務 Task                       請款 Invoice
┌─────────────────────┐         ┌────────────────────────┐
│ TaskCreated         │         │ InvoiceRequested       │
│ TaskUpdated         │         │ InvoiceApproved        │
│ TaskCompleted       │         │ InvoicePaid            │
└─────────┬───────────┘         └─────────┬──────────────┘
          │                                │
          │                                │
          ▼                                ▼
       日誌 Log                        多次請款事件序列
┌──────────────────────────────┐   ┌─────────────────────┐
│ TaskStatusChanged             │   │ Invoice#1 Requested │
│ TaskAssigned                  │   │ Invoice#1 Approved  │
│ InvoiceStatusChanged          │   │ Invoice#1 Paid      │
│ AggregateStateChanged         │   │ Invoice#2 Requested │
└──────────────────────────────┘   │ Invoice#2 Approved  │
                                   │ Invoice#2 Paid      │
                                   └─────────────────────┘

事件因果流 (示意)
TaskCreated → TaskCompleted → InvoiceRequested → InvoiceApproved → InvoicePaid
TaskCompleted / InvoicePaid → 日誌 Log 更新

# SaaS 外部 Event-Sourced, Causality-Driven System 完整事件流示意

時間軸 →  

─────────────────────────────
日 期：2026-01-01
─────────────────────────────
任務 Task
├─ Task1 Created
├─ Task1 Started
├─ Task1 Completed
│
施工日記 FieldLog#2026-01-01 + Log
├─ TaskStatusChanged (Task1 Completed)
├─ InvoiceStatusChanged (無)
└─ FieldLogStatusChanged
│
請款 Invoice
└─ Invoice#1 Requested

事件因果箭頭：
Task1 Created → Task1 Started → Task1 Completed → FieldLog#2026-01-01 Created + Log → Invoice#1 Requested

─────────────────────────────
日 期：2026-01-02
─────────────────────────────
任務 Task
├─ Task1.1 Created
├─ Task1.1 Started
│
施工日記 FieldLog#2026-01-02 + Log
├─ TaskStatusChanged (Task1.1 Started)
├─ InvoiceStatusChanged (Invoice#1 Approved)
└─ FieldLogStatusChanged
│
請款 Invoice
├─ Invoice#1 Approved
└─ Invoice#2 Requested

事件因果箭頭：
Task1.1 Created → Task1.1 Started → FieldLog#2026-01-02 Created + Log → Invoice#1 Approved → Invoice#2 Requested

─────────────────────────────
日 期：2026-01-03
─────────────────────────────
任務 Task
├─ Task1.1 Completed
├─ Task2 Started
│
施工日記 FieldLog#2026-01-03 + Log
├─ TaskStatusChanged (Task1.1 Completed)
├─ TaskStatusChanged (Task2 Started)
├─ InvoiceStatusChanged (Invoice#2 Approved)
└─ FieldLogStatusChanged
│
請款 Invoice
├─ Invoice#2 Approved
└─ Invoice#2 Paid

事件因果箭頭：
Task1.1 Completed → Task2 Started → FieldLog#2026-01-03 Created + Log → Invoice#2 Approved → Invoice#2 Paid

─────────────────────────────
日 期：2026-01-04
─────────────────────────────
任務 Task
├─ Task1.1.1 Created
├─ Task1.1.1 Started
│
施工日記 FieldLog#2026-01-04 + Log
├─ TaskStatusChanged (Task1.1.1 Started)
├─ InvoiceStatusChanged (無)
└─ FieldLogStatusChanged
│
請款 Invoice
├─ Invoice#3 Requested
└─ Invoice#3 Approved

事件因果箭頭：
Task1.1.1 Created → Task1.1.1 Started → FieldLog#2026-01-04 Created + Log → Invoice#3 Requested → Invoice#3 Approved

─────────────────────────────
無限延伸
─────────────────────────────
- 任務子任務可無限向下拆
- 每天 FieldLog 附當天 Log
- 多次請款事件可累積
- Saga / Process Manager 管理跨 Task / FieldLog / Invoice 因果
- Projection / Read Model 支援快速查詢任務樹、施工日記、請款統計、專案總覽
