# PRD: ng-lin 事件驅動任務管理系統

## 1. 產品概述

### 1.1 文檔標題和版本

- PRD: ng-lin 事件驅動任務管理系統
- 版本: 1.0

### 1.2 產品摘要

ng-lin 是一個受 GitHub 啟發的學習型專案，旨在通過四層事件模型（L-1、L0、L1、L2）實現事件驅動的任務管理系統。該專案鏡像 GitHub 的通用功能架構，但專注於文檔和事件處理而非程式碼管理。

系統核心採用事件總線架構，結合智能決策引擎，實現任務的自動排程和派發。通過審計日誌和即時洞察功能，用戶可以全面掌握系統運行狀態和任務執行情況。

專案將 GitHub 的通用系統（如審計日誌、事件總線）直接對齊使用，同時將與編碼相關的功能（如儲存庫）映射為合約庫（L-1層），實現概念轉換和功能適配。

## 2. 目標

### 2.1 業務目標

- 構建一個功能完整的事件驅動任務管理系統 MVP
- 實現與 GitHub 母體功能相當的通用系統能力
- 建立清晰的四層事件架構模型，支持靈活擴展
- 提供完整的審計追蹤和系統可觀測性
- 打造個人學習和實踐事件驅動架構的平台

### 2.2 用戶目標

- 理解和掌握事件驅動系統的設計和實現
- 學習如何將成熟平台（GitHub）的架構理念應用於不同領域
- 建立可追蹤、可審計的任務管理流程
- 通過即時洞察了解系統運行狀況和任務執行效率
- 實現自動化的任務派發和智能決策

### 2.3 非目標

- 不實現任何程式碼相關的功能（版本控制、代碼審查等）
- 不提供商業化服務或收費功能
- 不追求生產環境級別的高可用性和容錯能力

## 3. 用戶角色

### 3.1 主要用戶類型

- 系統管理員/學習者（個人使用）
- 組織成員（團隊協作）
- 外部協作者（跨組織協作）

### 3.2 帳號類型（Account 層級）

- **個人帳號（Personal Account）**: 個人用戶的獨立帳號，擁有個人資源和設定
- **組織帳號（Organization Account）**: 組織層級的帳號，管理團隊資源和成員（後續版本推出）
- **BOT 帳號（自動化代理）**: 用於自動化任務和系統整合的特殊帳號（後續版本推出）

### 3.3 協作層級（Collaboration Layer）

- **團隊（Team）**: 組織內的群組單位，方便管理和權限分配（後續版本推出）
- **夥伴（Partner）**: 具有協作權限的角色，可跨組織合作（後續版本推出）
- **協作者（Collaborator）**: 專案層級的參與者，具有特定權限

### 3.4 初期版本支援範圍

初期版本（MVP）支援：
- 個人帳號的獨立使用
- 基礎的多用戶協作（協作者角色）
- 組織層級功能（組織帳號、團隊、夥伴）將在後續版本推出

### 3.5 基於角色的訪問

- **系統管理員**: 完全訪問權限，包括系統配置、事件發布訂閱、合約管理、任務調度、審計日誌查詢、規則配置和系統監控
- **協作者**: 受限訪問權限，可查看和操作被授權的合約和任務

## 4. 功能需求

### 4.1 四層事件模型架構（優先級：高）

- **L-1 層（合約層）**: 定義和管理系統合約，類似 GitHub 儲存庫的概念映射
  - 支持合約的創建、更新、刪除和查詢
  - 合約可轉換為任務模板
  - 提供合約版本管理
  - 每個合約擁有唯一的命名空間識別（namespace）

- **L0 層（基礎事件層）**: 處理原始事件的發布和訂閱
  - 事件總線實現發布-訂閱模式
  - 支持事件的持久化存儲
  - 提供事件查詢和檢索功能
  - 事件採用二層識別結構：命名空間 + 遞增序列（namespace#sequence）

- **L1 層（事件轉換層）**: 對 L0 事件進行轉換和豐富
  - 事件聚合和關聯分析
  - 事件數據轉換和標準化
  - 觸發規則引擎進行決策
  - 添加業務語義（Business Semantic）到事件識別

- **L2 層（智能決策層）**: 基於轉換後的事件進行智能決策
  - 任務自動生成和派發
  - 優先級計算和資源分配
  - 即時洞察生成
  - 策略/自動化/審計（Policy/Automation/Audit）層級的事件追蹤

### 4.2 二層識別系統架構（優先級：高）

#### 核心設計理念

遵循 GitHub 的設計哲學：**命名空間（Namespace）+ 遞增序列（Sequence）**

完整識別格式：`<namespace>#<sequence>`

實際範例：`owner/repo#issue_number`（例如：`openai/chatgpt#1287`）

#### 為什麼需要二層結構？

| 維度 | 只有 #1287 | namespace#1287 |
|------|-----------|----------------|
| **唯一性** | ❌ 每個資源都會衝突 | ✅ 全域唯一 |
| **治理性** | ❌ 無法做權限隔離 | ✅ 天然支援 multi-tenant |
| **可擴展性** | ❌ 高耦合 | ✅ 可獨立擴展 |
| **分散式** | ❌ 需要全域協調 | ✅ 去中心化自治 |

#### 架構層級職責分工

**① 命名空間（Namespace / Scope）**

解決問題：
- 這是誰的資源？
- 屬於哪個系統邊界？
- 如何做權限控制？

實作範例：
```
層級式命名空間
namespace = "tenant.context.aggregate"

例如：
"qrl.trading.order"
"acme.project-alpha.issue"
```

**② 遞增序列（Sequence / Order）**

解決問題：
- 事件發生順序
- 人類可讀的引用方式
- Timeline / Event Replay

特性：
```
在命名空間內遞增
qrl.trading.order#1
qrl.trading.order#2
qrl.trading.order#3

不同命名空間獨立計數
acme.project-alpha.issue#1  // 與上面的 #1 不衝突
```

#### 為什麼不使用全域遞增 ID？

| 特性 | 全域遞增 ID | 命名空間內遞增 |
|------|-----------|---------------|
| **耦合度** | 高耦合 | 低耦合 |
| **自治性** | 不可分割 | 可拆分資源 |
| **多租戶** | 難實現 | 天然支援 |
| **分散式** | 需中心協調 | 完全自治 |
| **治理性** | 困難 | 自然邊界 |

**結論：** 採用「去中心化但可治理」的架構模式

#### 應用於 ng-lin 系統的識別格式

**方案 A：路徑式（簡潔）**
```
"trading-bot/order#1024"
```

**方案 B：點記法（結構化）**
```json
{
  "namespace": "qrl.trading.order",
  "seq": 1024,
  "fullId": "qrl.trading.order#1024"
}
```

**方案 C：完整語義**
```json
{
  "tenant": "qrl",
  "context": "trading",
  "aggregate": "order",
  "sequence": 1024,
  "reference": "qrl/trading/order#1024"
}
```

#### 事件層級的識別應用

```typescript
// L-1: 原始序列（Raw Sequence）
rawSeq: 1024

// L0: 命名空間 + 序列（Namespace + Seq）
eventId: "qrl.trading.order#1024"

// L1: 業務語義（Business Semantic）
eventType: "OrderPlaced"
eventId: "qrl.trading.order#1024"

// L2: 策略/自動化/審計（Policy / Automation / Audit）
policyRule: "RiskControl.OrderLimit"
triggeredBy: "qrl.trading.order#1024"
action: "SendAlert"
```

#### 關鍵設計原則

✅ **必須遵循的原則**

1. **永遠使用二層結構**：`namespace#sequence`
2. **命名空間解決邊界問題**：權限、隔離、治理
3. **序列解決順序問題**：Timeline、Audit、引用
4. **兩者缺一不可**：單獨的 #1287 無法工作

### 4.3 事件總線（優先級：高）

- 實現可靠的發布-訂閱機制
- 支持事件的異步處理
- 提供事件重放功能用於調試和恢復
- 事件持久化和歷史查詢

### 4.3 事件總線（優先級：高）

- 實現可靠的發布-訂閱機制
- 支持事件的異步處理
- 提供事件重放功能用於調試和恢復
- 事件持久化和歷史查詢
- 所有事件遵循二層識別結構（namespace#sequence）

### 4.4 任務調度和派發系統（優先級：高）

- 基於合約自動生成任務
- 支持任務優先級和截止日期
- 實現任務狀態管理（待處理、進行中、已完成、已取消）
- 提供任務查詢和篩選功能
- 任務使用命名空間識別，確保全域唯一性

### 4.5 審計日誌（優先級：中）

- 記錄所有系統操作和事件
- 提供詳細的查詢和篩選功能
- 支持日誌導出和分析
- 實現日誌保留策略
- 審計日誌包含完整的事件識別資訊（namespace#sequence）

### 4.6 合約庫（L-1 層）（優先級：高）

- 管理系統合約定義
- 支持合約模板和實例化
- 合約到任務的映射規則
- 提供合約搜索和分類功能
- 每個合約擁有獨立的命名空間

### 4.7 智能決策引擎（優先級：中）

- 基於規則的決策系統
- 支持自定義決策規則
- 提供決策歷史和分析
- 實現決策結果的可追溯性
- 決策事件遵循二層識別結構

### 4.8 系統文檔和幫助（優先級：低）

- 提供完整的系統使用指南
- GitHub 概念映射說明文檔
- API 文檔和示例
- 故障排除指南
- 二層識別系統使用說明和最佳實踐

## 5. 用戶體驗

### 5.1 入口點和首次用戶流程

- 系統初始化配置向導
- 四層事件模型概念介紹
- 創建第一個合約的引導流程
- 發布第一個事件的示例

### 5.2 核心體驗

- **事件發布**: 簡潔的事件發布界面，支持結構化數據輸入
  - 通過直觀的界面快速發布事件，減少學習成本

- **任務管理**: 清晰的任務列表視圖，支持狀態篩選和優先級排序
  - 提供高效的任務追蹤和管理體驗

- **審計查詢**: 強大的日誌查詢功能，支持多維度篩選
  - 確保系統操作的完全可追溯性

- **即時洞察**: 實時展示系統運行指標和任務執行統計
  - 幫助用戶快速了解系統狀態

### 5.3 高級功能和邊界情況

- 事件重放功能用於系統調試
- 複雜規則的配置和測試
- 批量任務操作
- 數據導出和備份

### 5.4 UI/UX 亮點

- 清晰的四層架構可視化展示
- 事件流動的實時追蹤視圖
- 任務和合約的關聯關係圖
- 響應式設計，支持不同屏幕尺寸

## 6. 敘述

用戶作為系統管理員和學習者，通過 ng-lin 系統深入理解事件驅動架構和 SaaS 多租戶設計。他們首先在 L-1 層定義合約（類似 GitHub 儲存庫的概念），每個合約擁有獨立的命名空間識別。然後通過事件總線發布基礎事件（L0 層），每個事件自動生成唯一的識別碼（namespace#sequence），確保全域唯一性和可追蹤性。系統自動在 L1 層進行事件轉換和豐富，添加業務語義，最終在 L2 層生成智能決策，自動創建和派發任務。整個過程遵循二層識別系統架構，通過審計日誌完整記錄每個事件和操作的識別資訊，用戶可以隨時基於識別碼查詢歷史和獲取即時洞察，從而掌握系統運行的全貌。

## 7. 成功指標

### 7.1 以用戶為中心的指標

- 完成首次合約創建到任務生成的時間 < 5 分鐘
- 事件發布到任務派發的端到端延遲 < 10 秒
- 審計日誌查詢響應時間 < 2 秒
- 用戶能夠理解和使用四層事件模型

### 7.2 業務指標

- MVP 功能完整度達到 90% 以上
- 系統核心功能（事件總線、任務調度、審計日誌）穩定運行
- 文檔完整性覆蓋所有主要功能

### 7.3 技術指標

- 事件處理成功率 > 99%
- 系統正常運行時間 > 95%
- 單日可處理事件數量 > 10,000
- 審計日誌數據完整性 100%

## 8. 技術考量

### 8.1 集成點

- 事件總線與四層架構的集成
- 合約庫與任務系統的映射
- 審計日誌與所有系統組件的集成
- 決策引擎與規則配置的集成
- 二層識別系統與所有資源的集成（事件、任務、合約、審計日誌）
- 命名空間管理服務與權限控制系統的集成

### 8.2 數據存儲和隱私

- 所有數據本地存儲，無外部數據傳輸
- 事件和任務數據結構化存儲，包含完整的命名空間和序列資訊
- 審計日誌採用時序數據庫，支持基於識別碼的快速查詢
- 合約和規則配置採用文檔數據庫
- 命名空間索引確保唯一性和查詢效率
- 序列號生成器確保命名空間內的順序性

### 8.3 可擴展性和性能

- 支持異步事件處理，避免系統阻塞
- 實現事件隊列緩衝機制
- 優化審計日誌查詢索引
- 支持任務批量操作
- 命名空間隔離支持分散式擴展
- 序列號生成採用高效能算法，支持高並發場景

### 8.4 識別系統技術實現

- **命名空間管理**：
  - 支持層級式命名空間（tenant.context.aggregate）
  - 命名空間唯一性驗證
  - 命名空間權限控制和隔離
  
- **序列號生成**：
  - 命名空間內的自增序列
  - 高並發下的序列號一致性保證
  - 序列號持久化和恢復機制
  
- **識別碼解析**：
  - 支持多種格式的識別碼（路徑式、點記法、完整語義）
  - 快速的識別碼到資源的映射
  - 跨層級的識別碼追蹤

### 8.5 潛在挑戰

- 四層事件模型的複雜性可能增加學習曲線
- 事件重放功能需要謹慎設計，避免數據不一致
- 決策引擎的規則配置需要平衡靈活性和易用性
- 審計日誌的長期存儲和查詢性能優化
- 二層識別系統的命名空間設計需要前期規劃
- 高並發場景下序列號生成的性能和一致性挑戰

## 9. 里程碑和排序

### 9.1 專案規模估計

- **規模**: 中型專案
- **時間估計**: 3-6 個月完成 MVP

### 9.2 團隊規模和組成

- **團隊規模**: 個人專案（1 人）
- **角色**: 全棧開發 + 系統設計 + 文檔撰寫

### 9.3 建議階段

- **階段 1: 基礎和核心事件基礎設施**（6-8 週）
  - 關鍵交付成果:
    - 四層事件模型架構設計
    - 二層識別系統架構設計（namespace#sequence）
    - 命名空間管理服務實現
    - 序列號生成器實現
    - 事件總線實現（發布-訂閱機制）
    - L0 層基礎事件處理（含識別碼生成）
    - 基本的審計日誌功能
    - 系統初始化和配置

- **階段 2: 合約和任務系統**（4-6 週）
  - 關鍵交付成果:
    - L-1 層合約庫實現（含命名空間管理）
    - 合約到任務的映射邏輯
    - 任務調度和派發系統（含識別碼生成）
    - 任務狀態管理
    - 基本的任務查詢和篩選（支持識別碼查詢）
    - 基礎多用戶協作功能（協作者角色）

- **階段 3: 智能決策層**（4-6 週）
  - 關鍵交付成果:
    - L1 層事件轉換實現（含業務語義識別）
    - L2 層智能決策引擎（含策略識別）
    - 規則配置系統
    - 即時洞察生成
    - 事件重放功能（基於識別碼）
    - 跨層級識別碼追蹤功能

- **階段 4: 完善和 MVP 完成**（2-4 週）
  - 關鍵交付成果:
    - 完整的系統文檔
    - GitHub 概念映射說明
    - 二層識別系統使用指南
    - 性能優化和監控
    - 用戶界面優化
    - 集成測試和系統驗證

## 10. 用戶故事

### 10.1. 系統初始化和配置

- **ID**: NGLIN-001
- **描述**: 作為系統管理員，我希望能夠初始化系統並完成基礎配置，以便開始使用 ng-lin 事件驅動任務管理系統。
- **驗收標準**:
  - 系統提供初始化向導，引導完成配置
  - 能夠設定系統基本參數（事件保留期限、任務優先級規則等）
  - 四層事件模型架構正確初始化
  - 系統配置可以保存和重新加載
  - 提供配置驗證和錯誤提示

### 10.2. 二層識別系統實現

- **ID**: NGLIN-002
- **描述**: 作為系統管理員，我希望系統能夠實現基於命名空間和序列的二層識別結構，以便確保所有資源的全域唯一性、可追蹤性和可治理性。
- **驗收標準**:
  - 實現命名空間管理服務，支持層級式命名空間創建和驗證
  - 實現序列號生成器，確保命名空間內的遞增序列
  - 所有事件、任務、合約都擁有唯一的識別碼（namespace#sequence）
  - 支持多種識別碼格式（路徑式、點記法、完整語義）
  - 提供識別碼解析和驗證功能
  - 支持基於識別碼的快速查詢和追蹤
  - 命名空間權限隔離機制正常運作
  - 高並發場景下序列號生成的一致性保證
  - 識別系統文檔完整，包含設計原則和使用範例

### 10.3. 合約管理（L-1 層）

- **ID**: NGLIN-003
- **描述**: 作為系統管理員，我希望能夠創建、更新、刪除和查詢合約，以便定義系統的業務規則和任務模板。
- **驗收標準**:
  - 支持創建新合約，包含名稱、描述和任務映射規則
  - 每個合約擁有唯一的命名空間識別
  - 能夠更新現有合約的屬性
  - 支持刪除不再使用的合約
  - 提供合約列表查詢和詳細信息查看
  - 合約變更記錄在審計日誌中
  - 支持合約版本管理

### 10.4. 事件總線發布和訂閱

- **ID**: NGLIN-004
- **描述**: 作為系統管理員，我希望能夠發布事件到事件總線並訂閱感興趣的事件，以便實現系統各組件的解耦通信。
- **驗收標準**:
  - 支持發布結構化事件到事件總線
  - 每個事件自動生成二層識別碼（namespace#sequence）
  - 能夠訂閱特定類型或主題的事件
  - 事件異步處理，不阻塞發布者
  - 事件成功發布後返回確認（含識別碼）
  - 訂閱者能夠接收到發布的事件
  - 事件發布和訂閱操作記錄在審計日誌中

### 10.5. 事件流經四層架構

- **ID**: NGLIN-005
- **描述**: 作為系統管理員，我希望事件能夠按照設計流經 L-1、L0、L1、L2 四層架構，以便實現從合約到任務的自動化處理。
- **驗收標準**:
  - 事件在 L0 層正確接收和存儲（含識別碼）
  - L1 層對事件進行轉換和豐富（添加業務語義）
  - L2 層基於轉換後的事件生成決策（添加策略識別）
  - 每層處理結果記錄在審計日誌中（含完整識別碼追蹤）
  - 支持查看事件在各層的處理狀態
  - 異常情況有明確的錯誤處理和記錄

### 10.6. 任務調度和派發

- **ID**: NGLIN-006
- **描述**: 作為系統管理員，我希望系統能夠基於合約和事件自動生成任務並進行調度派發，以便實現任務的自動化管理。
- **驗收標準**:
  - 根據合約定義自動生成任務
  - 每個任務擁有唯一的識別碼（namespace#sequence）
  - 任務包含優先級、截止日期等屬性
  - 支持任務狀態管理（待處理、進行中、已完成、已取消）
  - 提供任務列表查詢和篩選功能（支持識別碼查詢）
  - 任務創建和狀態變更記錄在審計日誌中
  - 支持手動調整任務優先級和狀態

### 10.7. 審計日誌查詢和分析

- **ID**: NGLIN-007
- **描述**: 作為系統管理員，我希望能夠查詢和分析審計日誌，以便了解系統操作歷史和排查問題。
- **驗收標準**:
  - 所有系統操作和事件記錄在審計日誌中（含完整識別碼）
  - 支持按時間範圍、操作類型、事件類型、識別碼等條件查詢
  - 查詢結果按時間倒序排列
  - 提供日誌詳細信息查看
  - 查詢響應時間 < 2 秒
  - 支持日誌導出功能
  - 支持基於識別碼的完整追蹤鏈查詢

### 10.8. 事件驅動規則配置

- **ID**: NGLIN-007
- **描述**: 作為系統管理員，我希望能夠配置事件驅動的決策規則，以便自定義系統的智能決策行為。
- **驗收標準**:
  - 提供規則配置界面
  - 支持定義規則的觸發條件和執行動作
  - 規則可以啟用或禁用
  - 支持規則的優先級設定
  - 規則配置變更記錄在審計日誌中
  - 提供規則測試功能

### 10.8. 即時洞察生成

- **ID**: NGLIN-009
- **描述**: 作為系統管理員，我希望系統能夠生成即時洞察，以便快速了解系統運行狀況和任務執行情況。
- **驗收標準**:
  - 實時展示系統關鍵指標（事件處理量、任務完成率等）
  - 提供任務執行統計（按狀態、優先級分組）
  - 展示事件流經四層架構的統計信息
  - 洞察數據自動刷新，延遲 < 5 秒
  - 支持自定義洞察的時間範圍
  - 洞察結果支持圖表可視化
  - 支持基於命名空間的統計分組

### 10.9. 事件重放和調試

- **ID**: NGLIN-010
- **描述**: 作為系統管理員，我希望能夠重放歷史事件，以便進行系統調試和問題排查。
- **驗收標準**:
  - 支持選擇特定時間範圍或特定事件（基於識別碼）進行重放
  - 重放過程不影響當前系統狀態（沙箱模式）
  - 重放結果詳細記錄，便於比對分析
  - 提供重放進度追蹤
  - 重放操作記錄在審計日誌中
  - 支持重放結果的導出
  - 支持基於識別碼的事件鏈重放

### 10.10. GitHub 概念映射文檔

- **ID**: NGLIN-011
- **描述**: 作為系統管理員，我希望有清晰的文檔說明 GitHub 概念如何映射到 ng-lin 系統，以便更好地理解系統設計理念。
- **驗收標準**:
  - 文檔詳細說明每個 GitHub 概念的映射關係
  - 提供映射的原因和設計考量
  - 包含具體的使用示例
  - 文檔結構清晰，易於查找
  - 涵蓋所有主要的概念映射（審計日誌、事件總線、儲存庫→合約庫、識別系統等）
  - 說明二層識別系統與 GitHub 識別系統的對應關係

### 10.11. 系統文檔和使用指南

- **ID**: NGLIN-012
- **描述**: 作為系統管理員，我希望有完整的系統文檔和使用指南，以便快速上手和深入學習系統功能。
- **驗收標準**:
  - 提供系統架構說明文檔
  - 包含完整的功能使用教程
  - 提供常見問題解答（FAQ）
  - 包含故障排除指南
  - 文檔包含截圖和示例
  - 文檔結構合理，支持快速檢索
  - 包含二層識別系統的詳細說明和使用範例

### 10.12. 系統性能和健康監控

- **ID**: NGLIN-013
- **描述**: 作為系統管理員，我希望能夠監控系統性能和健康狀況，以便及時發現和解決潛在問題。
- **驗收標準**:
  - 實時顯示系統運行狀態（正常、警告、錯誤）
  - 監控事件處理成功率和延遲
  - 追蹤任務調度和執行性能
  - 監控審計日誌查詢性能
  - 提供性能趨勢分析
  - 異常情況自動告警
  - 監控識別系統的性能（序列號生成速度、命名空間查詢效率）