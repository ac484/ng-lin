# Task 階層化系統：Event-Sourced 架構完整指南

> 本文件說明如何在 Event Sourcing 系統中實現階層化任務管理,包含拆分、協作、驗收與金流等完整流程

---

# 一、基礎概念與架構

## 1.1 Task 的樹狀結構與階層模型

### 概念模型

```
Contract Item (合約項次)
  項次 110: Frontend 機櫃 16 SET
  ↓
Parent Task (父任務)
  Task-110: Frontend 機櫃安裝工程
  金額: 2,639,062 元
  ↓
Child Tasks (子任務 - 第一層)
  ├─ Task-110-A: SS-A 區機櫃 (4 SET)
  │   金額: 659,765 元
  │   ↓
  │   Grandchild Tasks (孫任務 - 第二層)
  │   ├─ Task-110-A-01: 機櫃搬運定位
  │   ├─ Task-110-A-02: 內部設備組裝
  │   ├─ Task-110-A-03: 配線施工
  │   ├─ Task-110-A-04: 測試調試
  │   └─ Task-110-A-05: 驗收交付
  │
  ├─ Task-110-B: SS-B 區機櫃 (6 SET)
  │   金額: 989,647 元
  │   ↓
  │   ├─ Task-110-B-01: 機櫃搬運定位
  │   ├─ Task-110-B-02: 內部設備組裝
  │   └─ ... (同上結構)
  │
  └─ Task-110-C: SS-C 區機櫃 (6 SET)
      金額: 989,650 元
      ↓
      └─ ... (同上結構)
```

### 為什麼需要拆分?

**管理粒度的需求**:
```
不拆分的問題:
  Task-110: Frontend 機櫃 16 SET
  → 太大,無法追蹤細節
  → 不知道哪個區域卡住
  → 不知道哪個步驟有問題
  → 難以分配給不同團隊

拆分後的好處:
  ├─ 可以按區域分配
  ├─ 可以按工序分配
  ├─ 可以細緻追蹤進度
  └─ 可以明確責任歸屬
```

**協作的需求**:
```
Task-110-A-01: 機櫃搬運定位
  → 指派給: 吊裝專業團隊

Task-110-A-02: 內部設備組裝
  → 指派給: 機電專業團隊

Task-110-A-03: 配線施工
  → 指派給: 配線專業團隊

不同專業,不同團隊,需要拆分才能管理
```


## 1.2 Task 的重量級特性

### Task 不只是「待辦事項」,而是「工作合約的最小執行單位」

Task 的完整生命週期:

建立 Task
  ↓
指派協作者 (承包商/下包/人員)
  ↓
執行工作
  ↓
完成自檢
  ↓
質檢 (QC)
  ↓
驗收 (業主/監造)
  ↓
請款 (可能多次,按百分比)
  ↓
收款
```

這跟我之前理解的「輕量 Task」完全不同!

### Task 與金流的綁定關係

因為 **Task 是請款的依據**:

```
合約層:
項次 110: Frontend機櫃 16 SET = 2,639,062 元

Work 層:
SS-A 區 Frontend 機櫃 4 SET = 659,765 元

Task 層:
Task-001: SS-A01 機櫃安裝 
  ├─ 預算: 164,941 元
  ├─ 指派: 宏林工程 (下包商)
  ├─ 協作者: 張三、李四
  ├─ 執行狀態: 已完成
  ├─ 質檢: 通過 (QC-王工 3/20)
  ├─ 驗收: 通過 (ABB-William 3/22)
  └─ 請款記錄:
      ├─ 第一次: 50% = 82,470 元 (材料進場)
      ├─ 第二次: 30% = 49,482 元 (安裝完成)
      └─ 第三次: 20% = 32,988 元 (驗收完成)
```


### 協作者的分層架構


從這份合約看,宏林工程本身就是 ABB 的承包商,但宏林可能還有下包:

```
ABB (業主)
  ↓ 合約 73,840,106
宏林工程 (總包)
  ↓ 
  ├─ 自有施工團隊 (直接雇用)
  ├─ 下包商 A (機櫃安裝專業)
  ├─ 下包商 B (配線專業)
  └─ 臨時工 (支援性工作)
```

每個 Task 可能指派給不同的協作者,而且:
- **不同協作者的成本不同**
- **不同協作者的請款方式不同**
- **不同協作者的驗收標準可能不同**


# 二、核心設計 - Task 系統

## 2.1 Task 拆分的 Event 設計

### 拆分動作本身就是 Events

```
Event: TaskCreated
  taskId: "task-110"
  parentTaskId: null  // 頂層任務
  taskType: "Parent"
  title: "Frontend 機櫃安裝工程"
  contractItemId: "item-110"
  totalAmount: 2,639,062
  totalQuantity: 16
  unit: "SET"
  status: "Created"
  timestamp: "2024-03-01 10:00:00"

↓

Event: TaskSplit
  parentTaskId: "task-110"
  splitStrategy: "ByLocation"  // 按區域拆分
  childTasks: [
    {
      taskId: "task-110-A",
      title: "SS-A 區機櫃",
      quantity: 4,
      amount: 659,765
    },
    {
      taskId: "task-110-B", 
      title: "SS-B 區機櫃",
      quantity: 6,
      amount: 989,647
    },
    {
      taskId: "task-110-C",
      title: "SS-C 區機櫃", 
      quantity: 6,
      amount: 989,650
    }
  ]
  splitBy: "PM-王經理"
  timestamp: "2024-03-05 14:30:00"

↓

Event: TaskCreated (自動產生 3 個)
  taskId: "task-110-A"
  parentTaskId: "task-110"
  taskType: "Child"
  ...

Event: TaskCreated
  taskId: "task-110-B"
  parentTaskId: "task-110"
  ...

Event: TaskCreated
  taskId: "task-110-C"
  parentTaskId: "task-110"
  ...

↓

Event: TaskSplit (第二層拆分)
  parentTaskId: "task-110-A"
  splitStrategy: "ByPhase"  // 按工序拆分
  childTasks: [
    { taskId: "task-110-A-01", title: "機櫃搬運定位" },
    { taskId: "task-110-A-02", title: "內部設備組裝" },
    { taskId: "task-110-A-03", title: "配線施工" },
    { taskId: "task-110-A-04", title: "測試調試" },
    { taskId: "task-110-A-05", title: "驗收交付" }
  ]
  timestamp: "2024-03-10 09:00:00"
```

### 拆分的規則與限制

```
拆分規則:

1. 金額守恆
   父任務金額 = 所有子任務金額之和
   2,639,062 = 659,765 + 989,647 + 989,650 ✓

2. 數量守恆 (如果是數量計價)
   父任務數量 = 所有子任務數量之和
   16 SET = 4 + 6 + 6 ✓

3. 只能拆分 Pending/Created 狀態的任務
   如果已經開始執行,不能拆分 (避免混亂)

4. 拆分後父任務變成「容器」
   - 父任務不能直接執行
   - 只能追蹤子任務的總進度
   - 父任務的完成 = 所有子任務完成

5. 可以隨時合併回去
   如果發現拆分不合適,可以 TaskMerge
```


## 2.2 父子任務的狀態聯動


```
子任務狀態變化 → 自動更新父任務狀態

範例:
Task-110 (父)
  ├─ Task-110-A (子): Completed ✓
  ├─ Task-110-B (子): In Progress (80%)
  └─ Task-110-C (子): Pending

父任務的狀態計算:
  狀態: In Progress
  進度: (100% + 80% + 0%) / 3 = 60%

當所有子任務都 Completed:
  → Event: TaskCompleted (task-110)
  → 父任務自動標記為完成
```

### 向下傳遞 (Top-Down)

```
父任務的某些變更 → 影響所有子任務

範例 1: 父任務取消
  Event: TaskCancelled (task-110)
  原因: "業主取消此項工程"
  
  → 自動產生子任務取消 Events:
    Event: TaskCancelled (task-110-A)
    Event: TaskCancelled (task-110-B)
    Event: TaskCancelled (task-110-C)
  
  → 子任務的子任務也遞迴取消

範例 2: 父任務期限調整
  Event: TaskDeadlineChanged (task-110)
  原期限: 2024-06-30
  新期限: 2024-07-15
  
  → 子任務期限自動順延
  
範例 3: 父任務預算調整
  Event: TaskBudgetAdjusted (task-110)
  原預算: 2,639,062
  新預算: 2,900,000
  增加: 260,938
  
  → 需要決定如何分配到子任務
    選項 A: 平均分配
    選項 B: 按比例分配
    選項 C: 手動指定分配
```


## 2.3 Process 對階層化 Task 的支持


```
Process: Frontend 機櫃標準安裝流程

Tier 1: 總體流程 (對應父任務)
  Step 1: 規劃與準備
  Step 2: 區域拆分
  Step 3: 各區域執行
  Step 4: 整體驗收

Tier 2: 區域流程 (對應子任務)
  Step 1: 現場勘查
  Step 2: 材料進場
  Step 3: 工序拆分
  Step 4: 各工序執行
  Step 5: 區域驗收

Tier 3: 工序流程 (對應孫任務)
  根據不同工序有不同的詳細步驟
```

### Process 觸發 Task 拆分

```
當父任務到達某個節點時,Process 建議拆分:

Event: TaskCreated (task-110)
  ↓
Process 判斷:
  "這是 Frontend 機櫃安裝,數量 > 10 SET"
  → 建議按區域拆分
  ↓
系統提示專案經理:
  "建議將此任務拆分為 3 個區域任務?"
  [SS-A: 4 SET] [SS-B: 6 SET] [SS-C: 6 SET]
  ↓
專案經理確認或調整
  ↓
產生 TaskSplit Event
  ↓
自動建立子任務
  ↓
每個子任務套用「區域安裝流程」Process
```

### Process 的階層模板

```
TemplateProcess: 機櫃安裝總流程
  適用於: 父任務 (數量 > 5)
  
  階段 1: 規劃
    → 建議拆分策略
    → 等待確認
  
  階段 2: 執行
    → 監控子任務進度
    → 子任務異常時預警
  
  階段 3: 整合
    → 所有子任務完成後
    → 進行整體驗收

TemplateProcess: 單區機櫃安裝流程
  適用於: 子任務 (區域級別)
  
  階段 1: 準備
    → 現場勘查
    → 材料進場
  
  階段 2: 拆分工序
    → 建議拆分為 5 個工序任務
  
  階段 3: 執行
    → 監控工序任務進度
  
  階段 4: 驗收
    → 區域驗收

TemplateProcess: 機櫃搬運定位流程
  適用於: 孫任務 (工序級別)
  
  詳細步驟:
    1. 路線勘查
    2. 吊裝準備
    3. 搬運作業
    4. 定位校正
    5. 固定確認
```


## 2.4 資料結構設計


```typescript
// 概念模型 (TypeScript 風格)

interface Task {
  // 基本資訊
  taskId: string;
  title: string;
  description: string;
  
  // 階層關係 (關鍵!)
  parentTaskId: string | null;  // null = 頂層任務
  childTaskIds: string[];        // 子任務列表
  taskLevel: number;             // 0=頂層, 1=子任務, 2=孫任務...
  taskPath: string;              // "task-110/task-110-A/task-110-A-01"
  
  // 狀態
  status: TaskStatus;
  isDecomposed: boolean;         // 是否已拆分
  canBeExecuted: boolean;        // 能否直接執行 (有子任務就不能)
  
  // 金額與數量
  totalAmount: number;
  allocatedAmount: number;       // 已分配給子任務的金額
  remainingAmount: number;       // 尚未分配的金額
  quantity?: number;
  unit?: string;
  
  // 進度 (自動計算)
  progress: number;              // 0-100
  progressCalculationMethod: 'Manual' | 'FromChildren';
  
  // 其他欄位...
}
```

### Event Store 查詢

```
查詢 1: 取得任務的所有子任務
  Query: 
    SELECT * FROM events 
    WHERE eventType = 'TaskCreated' 
    AND data.parentTaskId = 'task-110'
  
  Result: [task-110-A, task-110-B, task-110-C]

查詢 2: 取得任務的完整階層樹
  遞迴查詢:
    1. 取得 task-110
    2. 取得 task-110 的所有子任務
    3. 對每個子任務重複步驟 2
  
  Result: 完整的樹狀結構

查詢 3: 取得任務的所有祖先
  向上追溯:
    task-110-A-02 
    → parentTaskId = task-110-A
    → parentTaskId = task-110
    → parentTaskId = null (到頂)
  
  Result: [task-110, task-110-A]

查詢 4: 計算父任務進度
  聚合查詢:
    1. 取得所有子任務
    2. 取得每個子任務的最新進度
    3. 計算平均或加權平均
  
  Result: 父任務進度 = XX%
```

## 8. 拆分策略的預設模板

## 2.5 拆分策略的預設模板


```
策略 1: 按區域拆分 (ByLocation)
  適用: 跨多個區域的重複性工作
  範例:
    Parent: 機櫃安裝 16 SET
    → Child: SS-A 區 4 SET
    → Child: SS-B 區 6 SET
    → Child: SS-C 區 6 SET

策略 2: 按工序拆分 (ByPhase)
  適用: 單一位置的多階段工作
  範例:
    Parent: SS-A01 機櫃安裝
    → Child: 搬運定位
    → Child: 內部組裝
    → Child: 配線施工
    → Child: 測試調試
    → Child: 驗收交付

策略 3: 按數量拆分 (ByQuantity)
  適用: 大批量的相同工作
  範例:
    Parent: 配線 200 條
    → Child: 第 1-50 條
    → Child: 第 51-100 條
    → Child: 第 101-150 條
    → Child: 第 151-200 條

策略 4: 按專業拆分 (ByDiscipline)
  適用: 需要不同專業協作的工作
  範例:
    Parent: 變電站整合工程
    → Child: 土建工程
    → Child: 電氣工程
    → Child: 儀控工程
    → Child: 通訊工程

策略 5: 按時間拆分 (ByTime)
  適用: 長期持續性工作
  範例:
    Parent: 監工服務 (6 個月)
    → Child: 第 1 個月
    → Child: 第 2 個月
    → ...
    → Child: 第 6 個月
```


# 三、協作者管理

## 3.1 協作者的類型與權限


```typescript
// 概念模型

Collaborator {
  type: 'Company' | 'Team' | 'Individual'
  
  // 公司層級
  if type === 'Company':
    - 下包商資訊
    - 合約關係
    - 統一發票資訊
    - 保險證明
  
  // 團隊層級  
  if type === 'Team':
    - 班組長
    - 成員清單
    - 專長領域
  
  // 個人層級
  if type === 'Individual':
    - 個人資料
    - 證照資訊
    - 勞健保狀態
}
```

### Task 的指派邏輯

```
建立 Task 時:

1. 選擇主要負責方:
   □ 自有團隊
   □ 下包商 A
   □ 下包商 B

2. 指派具體人員/團隊:
   - 如果是自有: 選擇班組 (張三組)
   - 如果是下包: 選擇下包的負責人

3. 定義協作關係:
   - 主責: 張三組 (宏林自有)
   - 協作: 李四 (下包商 A 的吊裝專家)
   - 監督: 王工 (宏林品管)

4. 定義成本分配:
   - 人工成本: 50,000
   - 外包成本: 80,000  
   - 材料成本: 34,941
   - 總計: 164,941
```

## 4. Task 的驗收與請款流程

### 多階段驗收

```
Task-001: SS-A01 機櫃安裝

階段 1: 材料進場驗收
  ├─ 材料清點 (倉管)
  ├─ 規格確認 (工程師)
  ├─ 照片記錄
  └─ 可請款 50%

階段 2: 安裝完成自檢
  ├─ 施工團隊自檢表
  ├─ 照片記錄
  └─ 通知 QC 來檢

階段 3: 質檢 (QC)
  ├─ QC 工程師現場檢查
  ├─ 檢查項目打勾
  ├─ 缺失記錄 (如果有)
  ├─ 照片記錄
  └─ QC 通過 → 可請款 30%

階段 4: 業主驗收
  ├─ 通知業主 (ABB-William)
  ├─ 業主現場驗收
  ├─ 驗收文件簽署
  ├─ 照片記錄
  └─ 驗收通過 → 可請款 20%
```

### 請款與收款追蹤

```
Task-001 的金流狀態:

預算: 164,941 元

請款記錄:
├─ Invoice-001: 82,470 (50%) 
│   ├─ 請款日期: 3/15
│   ├─ 發票號碼: AB12345678
│   ├─ 依據: 材料進場驗收單
│   ├─ 狀態: 已收款
│   └─ 收款日期: 4/20 (月結 90天)
│

## 3.2 協作者的分支架構

### 分支隔離的視覺設計

```
業主視角 (ABB William)
  ├─ 看到整個專案的全局
  ├─ 看到所有 Contract Items
  ├─ 看到總包 (宏林) 的執行狀況
  └─ 不需要看到下包的細節 (除非出問題)

總包視角 (宏林工程)
  ├─ 看到自己負責的所有 Work
  ├─ 看到每個 Work 的 Tasks
  ├─ 看到下包的執行狀況
  └─ 管理請款與金流

下包視角 (專業團隊)
  ├─ 只看到指派給自己的 Tasks
  ├─ 不看到其他團隊的任務
  ├─ 不看到整體金額 (只看到自己的部分)
  └─ 專注於執行與回報
```

## 3.3 協作者介面設計


```
【下包商 A 登入後的首頁】

頂部資訊:
  歡迎回來,下包商 A (光明機電)
  合約編號: SUB-2024-001
  合約金額: 5,000,000 元
  
我的儀表板:
  ┌─────────────────┐
  │ 待處理 Tasks     │ 8 個
  │ 進行中 Tasks     │ 5 個  
  │ 等待驗收        │ 3 個
  │ 已完成          │ 12 個
  └─────────────────┘
  
  ┌─────────────────┐
  │ 本月已請款      │ 1,200,000
  │ 待收款          │ 800,000
  │ 可請款 (待驗收)  │ 500,000
  └─────────────────┘
```

### Task 列表視圖

```
【我的 Tasks】

篩選: [全部] [待執行] [進行中] [等待驗收] [已完成]
排序: [截止日期] [優先級] [金額]

┌──────────────────────────────────────┐
│ Task-020: SS-A01 機櫃安裝              │
│ 狀態: 🟡 等待驗收                      │
│ 截止: 2024-03-25                      │
│ 金額: 400,000 元                      │
│ ├─ 已請款: 200,000 (50%)              │
│ ├─ 待驗收: 200,000 (50%)              │
│ └─ [查看詳情] [上傳照片]               │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ Task-025: SS-A02 配線施工              │
│ 狀態: 🟢 進行中 (65%)                  │
│ 截止: 2024-03-28                      │
│ 金額: 350,000 元                      │
│ ├─ 已請款: 175,000 (材料到場)         │
│ ├─ 進度: 預計明天完成                  │
│ └─ [更新進度] [上傳照片] [提交自檢]    │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ Task-030: SS-A03 光纖熔接              │
│ 狀態: ⚪ 待執行                        │
│ 截止: 2024-04-05                      │
│ 金額: 450,000 元                      │
│ └─ [開始執行]                          │
└──────────────────────────────────────┘
```

### Task 詳情頁面

```
【Task-020 詳情】

基本資訊:
  Task ID: Task-020
  工作內容: SS-A01 機櫃安裝
  工作地點: SS-A 電氣室
  負責人: 張三 (我方班組長)
  
進度時間軸:
  ✓ 2024-03-10: Task 建立並指派
  ✓ 2024-03-12: 材料進場驗收 → 已請款 50%
  ✓ 2024-03-15: 開始施工
  ✓ 2024-03-18: 安裝完成
  ✓ 2024-03-19: 提交自檢表
  🟡 2024-03-20: 等待專案經理驗收 ← 目前狀態
  
可執行動作:
  [上傳補充照片]
  [查看自檢表]
  [聯繫專案經理]
  
金額資訊:
  合約金額: 400,000
  ├─ 第一次請款 (材料): 200,000 ✓ 已收款
  └─ 第二次請款 (完工): 200,000 🟡 等待驗收
  
施工記錄:
  - 投入人力: 4 人 × 3 天
  - 使用材料: [材料清單]
  - 施工照片: [12 張照片]
  - 自檢表: [查看]
```

### 功能限制與開放

```
下包商 A 可以做的:
  ✓ 查看自己的 Tasks
  ✓ 更新 Task 進度
  ✓ 上傳照片/文件
  ✓ 提交自檢表
  ✓ 提交部分驗收文件 (材料清單、進度報表)
  ✓ 查看自己的請款記錄
  ✓ 與專案經理溝通 (留言功能)

下包商 A 不能做的:
  ✗ 看到其他下包商的 Tasks
  ✗ 看到主合約的金額與細節
  ✗ 看到宏林的成本結構
  ✗ 核准驗收 (只能提交)
  ✗ 直接請款 (需要主包核准)
  ✗ 修改 Task 基本資訊
```

### 通知機制

```
下包商 A 會收到的通知:

即時通知:
  - 新 Task 指派給你
  - 你的 Task 被退回 (驗收失敗)
  - 你的請款已核准
  - 專案經理有留言給你

每日摘要 (早上 8:00):
  - 今日需要執行的 Tasks
  - 逾期或即將逾期的 Tasks
  - 等待你提交文件的 Tasks

每週報告 (週一早上):
  - 上週完成狀況
  - 本週計畫
  - 財務狀況 (請款/收款)
```

---


# 四、驗收與金流管理

## 4.1 驗收單範本系統


```
概念:
  Task 建立時,根據「工作類型」自動套用對應的驗收範本

工作類型分類:
  ├─ 材料進場類
  ├─ 機櫃安裝類
  ├─ 配線施工類
  ├─ 測試調試類
  ├─ 光纖熔接類
  └─ 其他類
```

### 範本 A: 材料進場驗收單

```
【材料進場驗收單】

Task: Task-010 機櫃材料進場
驗收日期: 2024-03-12
驗收人: 王工

一、數量清點
  項目                預計    實際    結果
  ├─ Frontend 機櫃    10      10      ✓
  ├─ 配件包          10      10      ✓
  └─ 說明書          10      10      ✓

二、外觀檢查
  □ 包裝完整,無破損
  □ 無碰撞、刮傷痕跡
  □ 標籤清晰可讀

三、規格確認
  □ 型號: XXX-2024 ✓ 符合
  □ 尺寸: 800×900×2000 ✓ 符合
  □ 顏色: RAL7035 ✓ 符合

四、文件檢查
  □ 出貨單
  □ 保固書
  □ 檢驗報告
  □ 產地證明 (進口貨)

五、照片記錄
  [6 張照片]

驗收結論:
  ☑ 通過,可入庫
  ☐ 部分通過,缺失: _______
  ☐ 不通過,原因: _______

驗收人簽名: ___________
日期: 2024-03-12
```

### 範本 B: 機櫃安裝驗收單

```
【機櫃安裝驗收單】

Task: Task-020 SS-A01 機櫃安裝
驗收日期: 2024-03-20
驗收人: 王經理

一、定位檢查
  □ 位置符合圖面
  □ 水平度: ±2mm ✓
  □ 垂直度: ±2mm ✓
  □ 間距: 符合規範

二、固定檢查
  □ 地腳螺栓: 已鎖緊
  □ 機櫃連結: 已固定
  □ 防震墊片: 已安裝

三、內部檢查
  □ 設備安裝位置正確
  □ 走線整齊
  □ 接地良好
  □ 無雜物

四、外觀檢查
  □ 表面無刮傷
  □ 門鎖正常
  □ 標示清晰

五、功能測試
  □ 電源測試: 正常
  □ 接地測試: <1Ω
  □ 絕緣測試: >5MΩ

六、安全檢查
  □ 重心標示清楚
  □ 警告標籤完整
  □ 無尖銳邊緣

七、照片記錄
  - 整體照片 [4 張]
  - 內部配置 [3 張]
  - 測試數據 [2 張]

缺失項目 (如有):
  1. _______
  2. _______

驗收結論:
  ☑ 通過,可請款 30%
  ☐ 部分通過,限期改善
  ☐ 不通過,需返工

專案經理簽名: ___________
日期: 2024-03-20

註: 本驗收單視同專案經理承擔責任
```

### 範本 C: 配線施工驗收單

```
【配線施工驗收單】

Task: Task-035 SS-A01 配線施工

一、線路檢查
  迴路            起點    終點    線徑    結果
  ├─ AC-110V-1    RCP     FE01    2.0mm²  ✓
  ├─ DC-110V-1    DC      FE01    2.0mm²  ✓
  ├─ COM-1        RTU     FE01    0.75mm²  ✓
  └─ ...

二、標示檢查
  □ 線路兩端標示清晰
  □ 標示內容正確
  □ 標示材質耐久

三、固定檢查
  □ 配線整齊
  □ 固定牢靠
  □ 轉角圓滑

四、接線檢查
  □ 端子壓接牢固
  □ 極性正確
  □ 無裸露導線

五、測試記錄
  - 導通測試: ✓ 通過
  - 絕緣測試: ✓ >5MΩ
  - 接地測試: ✓ <1Ω

六、照片記錄
  [8 張照片]

驗收結論: ___________
```

### 範本管理機制

```
系統設定:

管理員可以:
  - 建立新範本
  - 修改現有範本
  - 設定範本適用條件
  - 預覽範本效果

範本欄位類型:
  - 文字輸入
  - 數字輸入
  - 勾選框
  - 下拉選單
  - 照片上傳
  - 檔案上傳
  - 簽名欄

範本版本控制:
  - 每次修改都保留歷史版本
  - 舊的 Tasks 使用舊版本
  - 新的 Tasks 使用新版本
```

---

## 5. 請款計算引擎 - 複雜的計價規則

### 基本計價模式

```
模式 A: 數量計價
  公式: 單價 × 數量 = 金額
  
  例如:
  Task: Frontend 機櫃安裝
  單價: 164,941 元/SET
  合約數量: 4 SET
  已完成: 3 SET
  進行中: 0.5 SET
  
  可請款 = (3 + 0.5) × 164,941 = 577,293 元

模式 B: 總價計價
  公式: 總價 × 完成百分比 = 金額
  
  例如:
  Task: 光纖佈建
  總價: 5,000,000 元
  完成進度: 65%
  
  可請款 = 5,000,000 × 65% = 3,250,000 元

模式 C: 工時計價
  公式: 人時單價 × 工時 = 金額
  
  例如:
  Task: 監工服務
  單價: 1,500 元/人時
  本月工時: 160 小時
  
  可請款 = 1,500 × 160 = 240,000 元
```

### 分階段請款規則

```
規則設定:

Task-020 的請款階段:
  階段 1: 材料進場
    ├─ 觸發條件: MaterialReceived Event
    ├─ 請款比例: 50%
    ├─ 需要文件: 材料進場單、照片
    └─ 計算: 總金額 × 50%
    
  階段 2: 安裝完成
    ├─ 觸發條件: InternalAcceptancePassed Event
    ├─ 請款比例: 30%
    ├─ 需要文件: 驗收單、照片
    └─ 計算: 總金額 × 30%
    
  階段 3: 業主驗收
    ├─ 觸發條件: ClientApproved Event
    ├─ 請款比例: 20%
    ├─ 需要文件: 業主驗收單
    └─ 計算: 總金額 × 20%

累計請款限制:
  - 不能超過 100%
  - 每次請款都記錄 Invoice Number
  - 追蹤實際收款狀態
```

### 複雜場景處理

#### 場景 1: 部分驗收的計價

```
Task-110: Frontend 機櫃 16 SET
單價: 164,941 元/SET
總金額: 2,639,056 元

分批驗收:
  第一批: 5 SET 驗收通過
    → 可請款 = 5 × 164,941 = 824,705 元
    
  第二批: 3 SET 驗收通過 (1 SET 退件)
    → 可請款 = 3 × 164,941 = 494,823 元
    
  第三批: 8 SET 驗收通過 (含前次退件)
    → 可請款 = 8 × 164,941 = 1,319,528 元

累計請款: 2,639,056 元 ✓
```

#### 場景 2: 進度型計價 + 預付款

```
Task-200: 光纖佈建 8500M
總金額: 5,911,217 元

特殊條款:
  預付款: 20% = 1,182,243 元 (簽約時)
  
進度請款:
  10% 完成: 5,911,217 × 10% - 預付 = 0 (已預付)
  30% 完成: 5,911,217 × 30% - 已請 = 591,122
  50% 完成: 5,911,217 × 50% - 已請 = 1,182,243
  100% 完成: 5,911,217 × 100% - 已請 = 2,955,609
  
規則:
  - 預付款抵扣前期進度款
  - 需扣除預付後才能再請款
```

#### 場景 3: 主包下包的差價管理

```
Task-070: 光纖熔接

主包視角 (宏林 vs ABB):
  合約金額: 500,000
  已請款: 250,000 (50%)
  待請款: 250,000 (50%)

下包視角 (下包商 C vs 宏林):
  合約金額: 300,000
  已請款: 150,000 (50%)
  待請款: 150,000 (50%)

差價管理:
  宏林利潤: 500,000 - 300,000 = 200,000
  利潤率: 40%
  
注意事項:
  - 主包收到款才付給下包
  - 如果業主不付,下包也收不到
  - 需追蹤兩條金流
```

### 請款狀態追蹤

```
Task-020 的請款記錄:

Invoice-001:
  ├─ 請款日期: 2024-03-12
  ├─ 請款金額: 200,000
  ├─ 發票號碼: AB12345678
  ├─ 依據: 材料進場驗收單
  ├─ 狀態: ✓ 已收款
  ├─ 收款日期: 2024-06-10 (90天後)
  └─ 實收金額: 200,000

Invoice-002:
  ├─ 請款日期: 2024-03-20
  ├─ 請款金額: 120,000
  ├─ 發票號碼: AB12345679
  ├─ 依據: 內部驗收單
  ├─ 狀態: 🟡 待收款
  ├─ 預計收款: 2024-06-18
  └─ 備註: 等待 ABB 付款

Invoice-003:
  ├─ 請款條件: 等待業主驗收
  ├─ 預估金額: 80,000
  ├─ 狀態: ⚪ 尚未請款
  └─ 預計請款: 待驗收通過後

財務總覽:
  合約總額: 400,000
  已請款: 320,000 (80%)
  已收款: 200,000 (50%)
  待收款: 120,000 (30%)
  未請款: 80,000 (20%)
```

### 計價引擎的自動化

```
系統自動觸發請款提醒:

當 Event 發生時:
  MaterialReceived → 檢查階段 1 條件
  InternalAcceptancePassed → 檢查階段2 條件
  ClientApproved → 檢查階段 3 條件

如果條件滿足:
  1. 計算可請款金額
  2. 產生請款通知
  3. 提醒專案經理核准
  4. 準備請款文件清單
  5. 記錄請款申請 Event

防呆機制:
  - 檢查累計請款不超過 100%
  - 檢查必要文件是否齊全
  - 檢查前一階段是否已請款
  - 檢查是否有未解決的缺失
```

---

## 6. 異常處理流程 - 驗收失敗、返工、變更

### 驗收失敗的標準流程

```
Step 1: 驗收不通過
  Event: InternalAcceptanceFailed
  記錄:
    - 驗收人: PM-王經理
    - 驗收日期: 2024-03-20
    - 不通過原因: [詳細描述]
    - 缺失照片: [附件]
    - 要求改善期限: 2024-03-22
    
Step 2: 系統自動動作
  - Task 狀態 → Rework Required
  - 通知執行方 (下包商或自有團隊)
  - 凍結請款 (不能請該階段的款)
  - 記錄到異常清單
  
Step 3: 建立返工 Task (可選)
  選項 A: 在原 Task 上標記返工
  選項 B: 建立新的 Rework Task
    → Task-020-RW: SS-A01 缺失改善
    → 關聯到原 Task-020
    → 指派給原執行方
    → 期限: 2024-03-22
    
Step 4: 返工完成
  - 執行方完成改善
  - 提交改善照片與說明
  - Event: ReworkCompleted
  
Step 5: 重新驗收
  - 專案經理重新檢查
  - 如果通過:
    → Event: InternalAcceptancePassed
    → Task 狀態 → 恢復正常流程
    → 可以請款
  - 如果仍不通過:
    → 重複 Step 1-5
    
Step 6: 記錄與分析
  - 返工次數: 1 次
  - 延誤天數: 2 天
  - 額外成本: (如有)
  - 責任歸屬: 施工方
```

### 業主驗收失敗的處理

```
更嚴重的情況:

Step 1: 業主不接受
  Event: ClientRejected
  影響:
    - 宏林已經內部驗收通過
    - 甚至可能已付款給下包商
    - 但業主不付款給宏林
    
Step 2: 責任判定
  系統追溯:
    - 誰內部驗收的? PM-王經理
    - 驗收時間? 2024-03-20
    - 驗收依據? [查看驗收單]
    
  分析原因:
    □ 驗收標準不一致
    □ 執行品質確實有問題
    □ 業主臨時提高標準
    □ 溝通不足
    
Step 3: 處理策略
  策略 A: 宏林自行處理
    - 不找下包商 (自己吸收)
    - 派自有人力改善
    - 記錄為管理成本
    
  策略 B: 要求下包商改善
    - 如果是下包責任

## 4.2 金流綁定與請款機制

### 金流計算原則

```
金流計算的核心原則:

1. Task 完成才能請款
   - 必須通過驗收
   - 驗收單必須有業主簽名
   - 質檢必須先通過

2. 分期請款機制
   - 材料進場: 30-50%
   - 施工完成: 30-40%
   - 驗收完成: 20-30%
   - 保固金: 5-10%

3. 金額守恆
   - 所有子任務的請款總和 ≤ 父任務預算
   - 跨層級金額追蹤
   - 自動預警超支

4. 協作者分配
   - 下包商請款必須與 Task 綁定
   - 每個 Task 可指定多個協作者
   - 按比例分配金額
```

### 驗收失敗的金流影響


```
Task-040: SS-A05 配線 (下包商 A 執行)

3/15: 下包商 A 完成,提交自檢
  → Event: TaskSelfInspectionSubmitted

3/16: 專案經理驗收
  → 決定: 通過 ✓
  → Event: TaskInternalAcceptancePassed
  → 宏林付款給下包商 A: 300,000

3/20: 宏林向業主請款
  → Event: PaymentRequested

3/25: 業主現場驗收
  → 發現: 線路標示不符規範
  → 決定: 拒絕 ✗
  → Event: ClientRejected
  → 要求: 重新標示

結果:
  - 宏林已經付給下包商 A
  - 但業主不付款給宏林
  - 宏林自己吸收損失
  - 專案經理被檢討: 為什麼沒發現?

3/26: 重新標示
  → 宏林自己派人處理 (不能再請下包商)
  → 額外成本: 50,000

4/01: 業主重新驗收
  → 決定: 通過 ✓
  → 宏林才能收到款

這個案例的教訓:
  → 專案經理要更謹慎
  → 驗收標準要對齊業主
  → 下包商管理要加強
```

## 8. 核心設計原則

基於你的說明,Task 系統的設計原則是:

### 1. 分層可見性
- 每個分支只看得到自己的 Tasks
- 主包看得到全部
- 權限向下遞減

### 2. 責任可追溯
- 每個決策都有記錄
- 誰核准的?什麼時候?為什麼?
- 出問題能找到負責人

### 3. 金流可計算
- 數量 × 單價 = 金額
- 分批驗收 = 分批請款
- 主包與下包的差價管理

### 4. 驗收分階段
- 自檢 (執行方)

# 五、功能模塊


### 核心概念
**日報 = 當日所有 Task Events 的結構化摘要 + 人工補充**

### 自動彙整機制

```
每日 23:50 系統自動執行:

Step 1: 收集當日所有 Events
  - 篩選條件: eventDate = Today
  - 事件類型: Task 相關的所有 Events

Step 2: 按類別分組統計
  ├─ 新建 Tasks: 5 個
  ├─ 完成 Tasks: 3 個
  ├─ 驗收通過: 2 個
  ├─ 驗收失敗: 1 個
  ├─ 阻擋中: 1 個
  └─ 進度更新: 8 個

Step 3: 按工區/分支彙總
  ├─ SS-A 區:
  │   ├─ 進行中: 3 Tasks
  │   ├─ 完成: 1 Task
  │   └─ 人力投入: 12 人 × 8 小時
  ├─ SS-B 區:
  │   ├─ 進行中: 5 Tasks
  │   └─ 人力投入: 8 人 × 8 小時
  └─ 下包商 A:
      ├─ 完成: 2 Tasks
      └─ 等待驗收: 1 Task

Step 4: 計算關鍵指標
  - 總人工: 96 人時
  - 完成工作量: 3,500,000 元
  - 累計完成率: 45.2%
  - 今日完成率: +2.3%

Step 5: 標註異常事項
  - Task-040: 驗收失敗 (需返工)
  - Task-055: 材料延遲 (阻擋中)
  - SS-C 區: 今日無進度 (待查)
```

### 日報的結構

```
工程日誌 - 2024年3月20日 (星期三)

【天氣】晴 23°C
【出工狀況】
  - 宏林自有: 20 人
  - 下包商 A: 12 人
  - 下包商 B: 8 人
  - 總計: 40 人

【今日完成】(系統自動彙整)
  ✓ Task-020: SS-A01 機櫃安裝完成
  ✓ Task-025: SS-A02 配線完成
  ✓ Task-030: SS-A03 測試通過

【今日進度】(系統自動彙整)
  • Task-040: SS-B01 機櫃安裝 (80%)
  • Task-045: SS-B02 配線施工 (50%)
  • Task-050: SS-B03 光纖熔接 (30%)

【驗收記錄】(系統自動彙整)
  ✓ Task-020: 專案經理驗收通過
  ✗ Task-035: 驗收不通過 - 線路標示不清

【異常事項】(系統自動標註 + 人工補充)
  ! Task-055: 材料延遲,預計明日到貨
  ! Task-035: 需返工,已安排明日處理
  ! SS-C 區: 等待業主放行,暫停施工

【主管說明】(人工補充)
  今日 SS-A 區進度良好,預計本週五完成所有安裝。
  SS-B 區受材料延遲影響,整體進度延後一天。
  SS-C 區因業主臨時要求調整設計,等待確認中。

【明日計畫】(人工補充 或 系統建議)
  - 完成 SS-B01, SS-B02
  - 處理 Task-035 返工
  - 材料到貨後立即開始 SS-B03
  - 協調業主確認 SS-C 區設計

【照片記錄】(系統自動附加當日上傳的照片)
  [8 張照片]

【附件文件】
  - Task-020 驗收單
  - Task-035 缺失照片
```

### 特殊日報類型

**周報**: 自動彙整本週 5 天的日報
**月報**: 自動彙整本月所有日報 + 財務數據
**專項報告**: 針對特定工區或里程碑的進度報告

---

## 2. 里程碑機制 - 從 Tasks 推算達成率

### 里程碑的定義

```
Milestone: SS-A 區完工驗收
  
  達成條件:
  ├─ 必須完成的 Tasks (強制):
  │   ├─ Task-001~010: 機櫃安裝 (10個)
  │   ├─ Task-011~020: 配線施工 (10個)
  │   ├─ Task-021~025: 測試驗收 (5個)
  │   └─ 條件: 所有 Tasks 狀態 = Fully Accepted
  │
  ├─ 品質要求:
  │   ├─ 所有 Tasks 驗收通過率 = 100%
  │   └─ 無未解決的缺失項目
  │
  ├─ 文件要求:
  │   ├─ 竣工圖 (1 份)
  │   ├─ 測試報告 (25 份)
  │   └─ 驗收照片 (完整)
  │
  └─ 時間要求:
      └─ 目標日期: 2024-04-15
```

### 達成率計算

```
Milestone 進度計算公式:

進度 = (已完成 Tasks / 總 Tasks) × 權重係數

例如:
SS-A 區完工里程碑
  ├─ 機櫃安裝 (10 Tasks): 
  │   ├─ 已完成: 8 
  │   ├─ 權重: 40%
  │   └─ 貢獻: 8/10 × 40% = 32%
  │
  ├─ 配線施工 (10 Tasks):
  │   ├─ 已完成: 5
  │   ├─ 權重: 40%  
  │   └─ 貢獻: 5/10 × 40% = 20%
  │
  └─ 測試驗收 (5 Tasks):
      ├─ 已完成: 0
      ├─ 權重: 20%
      └─ 貢獻: 0/5 × 20% = 0%

總進度: 32% + 20% + 0% = 52%
```

### 智能預警機制

```
系統每日自動檢查:

預警 Level 1 (黃色):
  - 條件: 進度落後 > 5%
  - 例如: 目標 60%,實際 54%
  - 動作: 通知專案經理

預警 Level 2 (橘色):
  - 條件: 進度落後 > 10% 或 距離目標日期 < 7天
  - 動作: 通知專案經理 + 主管

預警 Level 3 (紅色):
  - 條件: 進度落後 > 15% 或 已逾期
  - 動作: 通知所有相關人員 + 啟動應變計畫

範例:
Milestone: SS-B 區完工
  目標日期: 2024-04-20
  今天: 2024-04-15
  剩餘天數: 5 天
  
  當前進度: 65%
  需要進度: 80% (才能準時完工)
  落後: 15%
  
  系統判斷: 🔴 紅色警示
  建議: 增加人力或調整範圍
```

### 里程碑的依賴關係

```
Milestone A: SS-A 區機櫃安裝完成
  ↓ (依賴)
Milestone B: SS-A 區配線完成
  ↓ (依賴)  
Milestone C: SS-A 區測試驗收
  ↓ (依賴)
Milestone D: SS-A 區整體完工

規則:
- Milestone A 未達成,B 不能開始
- 如果 A 延遲,系統自動推算 B、C、D 的影響
- 關鍵路徑標註 (Critical Path)
```

### 責任追溯

```
如果 Milestone 延誤:

追溯路徑:
Milestone 延誤
  ↓ 查詢
哪些 Tasks 延誤?
  ├─ Task-015: 延誤 3 天
  ├─ Task-018: 延誤 2 天
  └─ Task-022: 阻擋中 5 天
  ↓ 查詢
為什麼延誤?
  ├─ Task-015: 
  │   └─ 原因: 材料延遲 (供應商責任)
  ├─ Task-018:
  │   └─ 原因: 人力不足 (管理責任)  
  └─ Task-022:
      └─ 原因: 業主未放行 (外部因素)
  ↓ 分析
責任歸屬:
  - 供應商責任: 30%
  - 管理責任: 20%
  - 外部因素: 50%
```

---


# 六、因果關係追蹤


```
Cause: 專案經理決定拆分任務
  Event: TaskSplit (task-110)
  
Effect 1: 建立子任務
  Event: TaskCreated (task-110-A)
  Event: TaskCreated (task-110-B)
  Event: TaskCreated (task-110-C)

Effect 2: 父任務狀態變更
  Event: TaskStatusChanged (task-110)
  from: "Created"
  to: "Decomposed"  // 已拆解,等待子任務執行

Effect 3: 觸發指派流程
  因為有了具體的子任務
  → 可以指派給不同團隊
  Event: TaskAssigned (task-110-A) → Team-A
  Event: TaskAssigned (task-110-B) → Team-B
  Event: TaskAssigned (task-110-C) → Team-C
```

### 子任務執行的因果鏈

```
Cause: 子任務 A 完成
  Event: TaskCompleted (task-110-A)

Effect 1: 更新父任務進度
  Event: TaskProgressUpdated (task-110)
  progress: 0% → 25%  // 假設等權重

Effect 2: 觸發下一步驟
  如果 Process 定義了順序依賴:
  "Task-110-A 完成後才能開始 Task-110-B"
  → Event: TaskUnblocked (task-110-B)
  → 通知 Team-B 可以開始

Effect 3: 檢查里程碑
  如果 Task-110-A 是某個 Milestone 的一部分
  → 更新 Milestone 進度
  → Event: MilestoneProgressUpdated
```

### 異常的因果傳遞

```
Cause: 孫任務驗收失敗
  Event: InternalAcceptanceFailed (task-110-A-02)
  原因: "內部配線不符規範"

Effect 1: 子任務阻擋
  Event: TaskBlocked (task-110-A)
  原因: "等待 task-110-A-02 返工"

Effect 2: 父任務預警
  Event: TaskRiskDetected (task-110)
  風險: "子任務 110-A 阻擋,可能影響整體進度"

Effect 3: 通知相關人員
  → 通知 Team-A: 你的任務有問題
  → 通知專案經理: Task-110 有風險
  → 更新日誌: 記錄異常事件

Effect 4: 觸發應變流程
  Process 判斷:
    "如果阻擋超過 2 天,啟動緊急處理"
  → 安排額外資源
  → 調整後續任務時程
```


# 七、實務場景與案例


```
Day 1: 建立父任務
  Event: TaskCreated (task-110)
  title: "Frontend 機櫃 16 SET"
  amount: 2,639,062
  status: "Created"

Day 3: 現場勘查後決定拆分
  專案經理: "三個區域分開做"
  
  Event: TaskSplit (task-110)
  strategy: "ByLocation"
  children: [110-A, 110-B, 110-C]
  
  Event: TaskStatusChanged (task-110)
  to: "Decomposed"

Day 5: 進一步拆分 SS-A 區
  現場主管: "SS-A 區按工序拆分"
  
  Event: TaskSplit (task-110-A)
  strategy: "ByPhase"
  children: [110-A-01, 110-A-02, 110-A-03, 110-A-04, 110-A-05]

Day 7: 開始執行最底層任務
  Event: TaskStarted (task-110-A-01)
  assignee: "張三組 - 吊裝專業"
  
Day 9: 第一個孫任務完成
  Event: TaskCompleted (task-110-A-01)
  
  → 自動觸發:
    Event: TaskProgressUpdated (task-110-A)
    progress: 0% → 20%
    
    Event: TaskProgressUpdated (task-110)
    progress: 0% → 1.25%  // 1/16 的 1/5
    
Day 10: 開始第二個孫任務
  Event: TaskStarted (task-110-A-02)
  assignee: "李四組 - 機電專業"

... (依序執行)

Day 30: SS-A 區所有孫任務完成
  最後一個:
    Event: TaskCompleted (task-110-A-05)
  
  → 自動觸發:
    Event: TaskCompleted (task-110-A)
    reason: "所有子任務已完成"
    
    Event: TaskProgressUpdated (task-110)
    progress: 25% → 50%  // 假設 A 和 B 都完成

Day 60: 所有區域完成
  Event: TaskCompleted (task-110-C)
  
  → 自動觸發:
    Event: TaskCompleted (task-110)
    reason: "所有子任務已完成"
    
  → 觸發里程碑:
    Event: MilestoneAchieved (Frontend 機櫃安裝完成)
```


## 7.2 SCADA 工程合約實例分析


## 1. 合約結構的層次性

```
合約總價: 73,840,106 TWD
  ├─ 工項 (一): SCADA站內工程
  │   ├─ 項次 10: 既設161kv RTU (618,530)
  │   ├─ 項次 20: 既設EH盤22.8KV (134,015)
  │   ├─ 項次 30: 新設EH盤22.8KV (134,015)
  │   └─ ...更多細項
  ├─ 工項 (壹): 傳統配電盤搬運定位工程
  ├─ 工項 (貳): 配電盤盤間連結
  └─ ...等等
```

每個項次下還有更細的實際作業內容

## 2. 現場不確定性的本質

你提到「一開始不會知道現場空間」,這很關鍵。這代表:

### 計畫階段的抽象性
- 合約簽訂時只知道「要做什麼」(What)
- 不知道「怎麼做」(How) 的細節
- 不知道「在哪裡做」(Where) 的具體位置

### 執行階段的具象化
- 到現場後才知道實際配置
- 可能發現「喔,原來這個位置這麼窄」
- 可能發現「原來隔壁還有其他廠商在施工」
- 可能發現「原來這個設備已經老舊需要額外處理」

## 3. 對 Task 設計的啟示

基於這份合約,我認為你的 Task 系統應該有這樣的特性:

### 三層架構

**Layer 1: Contract Level (合約層)**
- 對應合約的工項和項次
- 這層是「承諾要交付什麼」
- 金額、交期都在這層定義
- 這層幾乎不會變動(除非正式變更設計)

**Layer 2: Work Package Level (工作包層)**
- 對應實際要執行的工作包
- 例如「項次 10」可能拆成:
  - 現場勘查與測量
  - 材料備料與檢驗
  - 機櫃搬運與定位
  - FrontEnd 配線
  - FO box 安裝
  - Relay 配置
  - 測試與驗收
- 這層是「規劃怎麼做」
- 可能在開工前才確定,也可能邊做邊調整

**Layer 3: Task Level (任務層)**
- 對應現場實際的待辦事項
- 例如「今天要在 SS-A01 安裝 Frontend 機櫃」
- 這層是「今天誰做什麼」
- 完全動態產生,每天都不同

### Task 的動態生成機制

我認為你的系統需要這樣的彈性:

**階段 1: 合約簽訂**
```
系統狀態:
- 有 Contract Items (項次清單)
- 沒有 Work Packages
- 沒有 Tasks
```

**階段 2: 施工規劃**
```
工地經理根據:
- 現場勘查結果
- 施工順序邏輯
- 人力資源配置

手動或半自動產生 Work Packages:
- WP-001: SS-A 區域機櫃安裝
- WP-002: SS-B 區域配線施工
- WP-003: 跨棟光纖佈建
...

每個 WP 關聯到一個或多個 Contract Items
```

**階段 3: 每日執行**
```
根據 Work Package 的進度和現場狀況,
系統或現場主管產生當日 Tasks:

2026-03-15:
- Task-001: [張三] SS-A01 機櫃定位
- Task-002: [李四] SS-A01 配線準備
- Task-003: [王五] 材料搬運至 SS-A

2026-03-16:
- Task-004: [張三] SS-A01 FO box 安裝
- Task-005: [李四] SS-A01 Relay 配置
...
```

## 4. 進度追蹤的關鍵點

從這份合約看,管理層關心的是:

### 對客戶(ABB)的承諾
- 「項次 10 做到哪裡了?」
- 「6/19 交期趕得上嗎?」
- 「如果延誤,罰款是多少?」(千分之五/天)

### 對內部的掌控
- 「SS-A 區域進度多少?」
- 「張三這週做了哪些工作?」
- 「這個月請款能請到多少?」

### 對異常的應變
- 「發現既設設備有問題怎麼辦?」
- 「業主臨時要求調整順序怎麼辦?」
- 「人力不足怎麼調配?」

## 5. 我的建議架構

### Process 定義的是「標準流程」
```
標準 SCADA 安裝流程:
1. 現場勘查
2. 材料進場檢驗
3. 機櫃搬運定位
4. 內部設備組裝
5. 配線施工
6. 測試驗收
```

### Work Package 是「具體實例」
```
WP-SS-A01: SS-A區01號機櫃安裝
- 套用標準流程
- 但根據現場狀況調整:
  - 因為空間狹窄,需要額外吊裝設備
  - 因為電源未就緒,暫時跳過測試階段
```

### Task 是「可執行動作」
```
Task-12345:
- 標題: SS-A01 機櫃定位
- 所屬 WP: WP-SS-A01
- 對應合約項次: 項次 110 (Frontend機櫃)
- 指派給: 張三
- 狀態: In Progress
- 現場照片: [附件]
- 異常記錄: 地板不平,需要墊片
```

## 6. 關鍵問題

基於這份合約,我想確認幾件事:

### 關於規劃彈性
你們的實務上:
- **Work Package 是在開工前就全部規劃好?** 還是邊做邊規劃?
- **現場主管有多少自主權調整?** 還是要回報總部批准?
- **如果發現問題需要變更,流程是什麼?**

### 關於進度回報
- **客戶(ABB)要求什麼頻率回報?** 每週?每月?
- **回報的粒度是什麼?** 報到工項?還是要細到每個機櫃?
- **請款是按什麼方式?** 實際完工量?還是時間進度?

### 關於責任追溯
合約上有很多罰款條款:
- **如果延誤,需要追究到「誰」的責任嗎?**
- **還是只要知道「哪個環節」卡住就好?**
- **驗收文件要詳細到什麼程度?**

這些會影響 Task 系統要記錄多少細節。

## 7. 我的觀察

這種合約最大的特色是:

**「上層很清楚,下層很模糊」**

- 合約金額、交期、罰則 → 非常明確
- 工項、設備規格 → 相對明確
- 但實際「怎麼做、誰來做、什麼時候做」→ 完全不確定

所以你的 Task 系統需要:
- **往上能對應合約項次**(追蹤承諾)
- **往下能靈活調整執行細節**(適應現場)
- **中間有彈性的協調機制**(Work Package)

這樣設計合理嗎?還是你們有其他考量?

# 八、總結與最佳實踐

## 8.1 Event-Sourced 系統如何支持階層化 Task


**1. 拆分本身就是 Event**
```
TaskSplit Event 記錄:
  - 誰拆分的
  - 什麼時候拆分
  - 為什麼拆分
  - 怎麼拆分的
  
完整可追溯,可重播
```

**2. 父子關係透過 Events 建立**
```
不是在資料庫建立外鍵關係
而是透過 TaskCreated Event 的 parentTaskId 欄位
  → Event Sourcing 的優勢:
    - 可以重播歷史
    - 可以看到拆分的演變過程
```

**3. 狀態聚合透過 Events 計算**
```
父任務的進度不是直接儲存
而是透過讀取所有子任務的 Events 計算出來
  → 保證資料一致性
  → 永遠能回溯計算
```

**4. Causality 自然體現**
```
Event 之間的因果關係清晰:
  TaskSplit → TaskCreated (子任務)
  TaskCompleted (子) → TaskProgressUpdated (父)
  TaskBlocked (孫) → TaskRiskDetected (父)
```

**5. Process 協調階層流程**
```
不同層級的 Task 套用不同的 Process
Process 可以建議拆分時機與策略
Process 監控整體執行狀態
```

這樣的設計讓你的系統能夠:
- ✓ 支持任意深度的任務拆分
- ✓ 保持完整的歷史記錄
- ✓ 自動聚合狀態與進度
- ✓ 靈活應對現場變化
- ✓ 清晰追溯因果關係


## 8.2 系統設計的關鍵決策

### 設計原則總結

1. **Event First**: 一切變更都是 Event
   - Task 拆分、狀態變更、請款記錄都是 Event
   - Event Store 作為唯一真相來源
   - 支持完整的審計追蹤

2. **階層化管理**: 支持多層級拆分
   - Contract → Work → Task → SubTask
   - 自動聚合統計
   - 異常向上傳遞

3. **因果完整性**: 建立清晰的因果鏈
   - 每個 Event 都有 causedBy
   - 支持追溯決策過程
   - 便於問題排查

4. **金流綁定**: Task 與金流一體化
   - 請款必須基於已驗收的 Task
   - 支持分期請款
   - 自動計算可請款金額

5. **協作者隔離**: 不同角色看到不同視圖
   - 業主看全局
   - 總包看執行
   - 下包看自己的任務
   - 保護商業機密

## 8.3 實施建議

### 階段性實施路徑

**Phase 1: 核心 Task 系統**
- 實現 Task CRUD 與狀態管理
- 實現 Event Store 基礎設施
- 實現簡單的階層拆分

**Phase 2: 協作者與權限**
- 實現多租戶架構
- 實現角色權限系統
- 實現分支視圖

**Phase 3: 驗收與金流**
- 實現驗收單系統
- 實現金流計算引擎
- 實現請款流程

**Phase 4: 進階功能**
- 實現自動日誌彙整
- 實現里程碑追蹤
- 實現智能預警

