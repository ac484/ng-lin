# 架構分層與治理

## 總體分層結構

本系統採用嚴格的分層架構，確保關注點分離與依賴方向的單向性。

```text
┌────────────────────────────────────┐
│            UI / Pages               │
│  (ui-composition / shared UI)       │
└───────────────▲────────────────────┘
                │ orchestration only
┌───────────────┴────────────────────┐
│            Features                 │
│  ├─ domains (BC, 真實業務)           │
│  ├─ processes (Saga / Workflow)     │
│  ├─ capabilities (平台能力)         │
│  └─ contracts (Feature Boundary)    │
└───────────────▲────────────────────┘
                │ depends-on
┌───────────────┴────────────────────┐
│               Core                  │
│  policy / contract / authz / error  │
│  result / events / audit / identity │
└───────────────▲────────────────────┘
                │ implements
┌───────────────┴────────────────────┐
│         Infrastructure / Adapter    │
│   firebase / supabase / external    │
└────────────────────────────────────┘
```

### 依賴方向規則

```
UI → Feature → Core → Infrastructure (實作)
Infrastructure ──implements──▶ Core Interface
```

❌ **任何反向都是架構違規**

## Core 層：治理中樞

### 1. Policy（決策中心）

**設計原則**：
- Feature 不得自行判斷權限
- 不准在 domain entity 寫 if (role === ...)
- 所有授權透過 policy-engine

> **Policy 是法律，不是建議**

### 2. Contract（跨邊界接口）

**職責**：
- DTO 結構定義
- Event schema 規範
- 版本相容性維護

❌ Feature 之間不得直接 import domain model
✅ 只能透過 contract 溝通

### 3. Error & Result

**鐵律**：
- ❌ 禁止 `throw new Error`
- ❌ 禁止隱性失敗（null / undefined）
- ✅ 所有失敗透過 `Result.Err`
- ✅ 錯誤必須可被 audit

### 4. Audit & Events

**原則**：audit 不是 log，是治理證據

## Feature 層：業務所在

### 1. Domain

**限制**：
- ❌ domain 不知道 UI
- ❌ domain 不知道 Firebase
- ❌ domain 不直接用 policy-engine

### 2. Application

**職責**：
- 調用 policy
- 調用 repo
- 組合流程

### 3. Process（Saga）

**職責**：
- ❌ 不擁有資料
- ❌ 不寫 domain rule
- ✅ 只負責跨 domain 協調

### 4. Capability

**原則**：永遠被動，不可反向影響 domain

### 5. Contract

❌ UI 直碰 domain = 越權

## Infrastructure 層

**三不原則**：
- ❌ 不寫 business rule
- ❌ 不判斷 policy
- ❌ 不定義 schema

## 架構約束（ESLint）

```text
domain        ❌ import process/ui/firebase
process       ❌ import ui
capability    ❌ import domain private model
ui            ❌ import domain
infrastructure❌ import feature
```

## 各層職責

* **Core**：法律與語言
* **Domain**：真實世界規則
* **Application**：怎麼做
* **Process**：跨界協調
* **Capability**：平台反射
* **UI**：呈現與編排
* **Infrastructure**：接線盒

---

**版本**: 1.0  
**來源**: 0-架構線條說明書.md
