# 合約財務結構

## 合約項次與金額

### SCADA 工程合約範例

```
合約總價: 73,840,106 TWD

工項結構:
├─ 工項 (一): SCADA 站內工程
│   ├─ 項次 10: 既設161kv RTU (618,530)
│   ├─ 項次 20: 既設EH盤22.8KV (134,015)
│   ├─ 項次 110: Frontend機櫃 16 SET (2,639,062)
│   └─ ... 更多項次
├─ 工項 (壹): 傳統配電盤搬運
├─ 工項 (貳): 配電盤盤間連結
└─ ... 更多工項
```

## 金額的階層對應

```
Contract Item (合約項次)
  項次 110: 2,639,062 TWD
    ↓ 拆分到
  Work Packages
    WP-SS-A: 659,765 TWD (4 SET)
    WP-SS-B: 989,647 TWD (6 SET)
    WP-SS-C: 989,650 TWD (6 SET)
    ↓ 細分到
  Tasks
    Task-110-A-01: 搬運定位
    Task-110-A-02: 內部組裝
    Task-110-A-03: 配線施工
    ... (每個 Task 分配對應金額)
```

## 進度計價方式

### 方式 A: 實作完工比例計價

**基於實際完成的工作量:**
```
項次 110: Frontend機櫃 16 SET
  合約金額: 2,639,062 TWD
  單價: 164,941 TWD/SET
  
  已完成: 12 SET
  完成比例: 12/16 = 75%
  可請款金額: 2,639,062 × 75% = 1,979,296 TWD
```

**Event 記錄:**
```
Event: ProgressPaymentCalculated
  contractItemId: "item-110"
  totalAmount: 2,639,062
  completedQuantity: 12
  completedPercentage: 75
  payableAmount: 1,979,296
  calculationBasis: "ActualCompletion"
  timestamp: "2024-04-30"
```

### 方式 B: 時間進度計價

**基於合約約定的時間進度:**
```
合約期間: 2024-03-01 ~ 2024-06-30 (4個月)
已經過: 2個月 (50%)

月份分配:
  3月: 20% → 14,768,021 TWD
  4月: 30% → 22,152,032 TWD
  5月: 30% → 22,152,032 TWD
  6月: 20% → 14,768,021 TWD
```

### 方式 C: 里程碑計價

**基於合約約定的里程碑:**
```
Milestone 1: 材料進場 (10%)
  金額: 7,384,010 TWD
  完成日: 2024-03-15
  
Milestone 2: SS區完工 (40%)
  金額: 29,536,042 TWD
  預計: 2024-04-30
  
Milestone 3: 測試完成 (30%)
  金額: 22,152,032 TWD
  預計: 2024-05-31
  
Milestone 4: 驗收通過 (20%)
  金額: 14,768,021 TWD
  預計: 2024-06-30
```

## 財務 Event 模型

### 進度計算

```
Event: ProgressCalculated
  period: "2024-04"
  items: [
    {
      contractItemId: "item-110",
      plannedProgress: 50,
      actualProgress: 75,
      variance: +25,
      amount: 2,639,062,
      earnedValue: 1,979,296
    }
  ]
  totalPlanned: 36,920,053
  totalActual: 45,000,000
  overallProgress: 61
```

### 請款計算

```
Event: PaymentRequestCalculated
  requestId: "PAY-2024-04"
  period: "2024-04"
  previousPayment: 14,768,021
  currentProgress: 61
  currentAmount: 45,024,064
  retentionRate: 10
  retention: 4,502,406
  netPayable: 40,521,658
  previousRetained: 1,476,802
  totalRetained: 5,979,208
```

## 保留款管理

### 保留款計算

```
工程保留款通常為 10%

範例:
  本期請款: 45,024,064 TWD
  保留率: 10%
  保留款: 4,502,406 TWD
  實付金額: 40,521,658 TWD
```

**保留款 Event:**
```
Event: RetentionCalculated
  paymentRequestId: "PAY-2024-04"
  grossAmount: 45,024,064
  retentionRate: 0.10
  retentionAmount: 4,502,406
  netPayable: 40,521,658
  cumulativeRetention: 5,979,208
```

### 保留款釋放

```
保留款釋放時機:
1. 驗收合格後釋放 50%
2. 保固期滿釋放剩餘 50%

Event: RetentionReleased
  releaseId: "REL-001"
  releaseType: "AcceptanceRelease" | "WarrantyRelease"
  originalRetention: 5,979,208
  releasePercentage: 50
  releaseAmount: 2,989,604
  releaseDate: "2024-07-01"
  approvedBy: "業主代表"
```

## 變更設計財務處理

### 合約變更

```
Event: ContractChangeApproved
  changeId: "CHG-001"
  changeType: "AddItem" | "RemoveItem" | "ModifyQuantity"
  affectedItems: [
    {
      itemId: "item-110",
      originalQuantity: 16,
      newQuantity: 14,
      unitPrice: 164,941,
      originalAmount: 2,639,062,
      newAmount: 2,309,174,
      difference: -329,888
    }
  ]
  totalImpact: -329,888
  approvedBy: "業主"
  effectiveDate: "2024-04-01"
```

## 總結

財務管理的關鍵:
1. **階層對應** - Contract → WP → Task
2. **多種計價** - 實作/時間/里程碑
3. **保留款管理** - 計算與釋放
4. **變更處理** - 金額調整記錄
5. **Event 記錄** - 完整財務歷史
