# 請款流程

## 請款週期

### 月結請款模式

**典型的月結流程:**
```
每月 25 日: 統計本月完成工作
每月 28 日: 提交請款資料
次月 5 日: 業主審核
次月 10 日: 核發付款
```

## 請款資料準備

### 必要文件清單

```
□ 請款單 (Payment Request)
□ 進度報表 (Progress Report)
□ 完工證明 (Completion Certificate)
□ 施工照片 (Photos)
□ 測試報告 (Test Reports)
□ 材料證明 (Material Certificates)
□ 變更記錄 (Change Orders)
```

### 自動產生請款資料

```
Event: PaymentDocumentsGenerated
  requestId: "PAY-2024-04"
  period: "2024-04"
  generatedDocuments: [
    {
      type: "ProgressReport",
      file: "progress-2024-04.pdf",
      pages: 15
    },
    {
      type: "CompletionCertificate",
      file: "completion-2024-04.pdf",
      items: ["WP-SS-A", "WP-SS-B"]
    },
    {
      type: "Photos",
      file: "photos-2024-04.zip",
      count: 156
    }
  ]
  generatedBy: "系統自動"
  generatedAt: "2024-04-25"
```

## 請款計算邏輯

### 基於 Task 完成度

```
流程:
1. 統計本期完成的 Tasks
2. 計算每個 Task 對應的金額
3. 加總得到本期完成金額
4. 扣除已請款金額
5. 計算保留款
6. 得出本期可請款淨額
```

**範例計算:**
```
項次 110 本期完成:
  Task-110-A-01: 完成 (100%) → 164,941 TWD
  Task-110-A-02: 完成 (100%) → 164,941 TWD
  Task-110-A-03: 進行中 (70%) → 115,458 TWD
  Task-110-A-04: 未開始 (0%) → 0 TWD
  
  本期小計: 445,340 TWD
  累計完成: 1,979,296 TWD
  前期已請: 1,533,956 TWD
  本期可請: 445,340 TWD
  保留 10%: 44,534 TWD
  本期淨額: 400,806 TWD
```

### Event 記錄

```
Event: PaymentCalculationCompleted
  requestId: "PAY-2024-04"
  period: "2024-04"
  breakdown: [
    {
      contractItemId: "item-110",
      tasksCompleted: ["task-110-A-01", "task-110-A-02"],
      tasksPartial: [
        { taskId: "task-110-A-03", percentage: 70 }
      ],
      periodAmount: 445,340,
      cumulativeAmount: 1,979,296,
      previousPayment: 1,533,956,
      currentPayable: 445,340,
      retention: 44,534,
      netPayable: 400,806
    }
  ]
  totalNetPayable: 5,234,567
  calculatedBy: "系統自動"
  calculatedAt: "2024-04-25"
```

## 請款審核流程

### 內部審核

```
Event: InternalReviewStarted
  requestId: "PAY-2024-04"
  reviewers: [
    { role: "專案經理", name: "王經理" },
    { role: "財務主管", name: "李主管" },
    { role: "QC主管", name: "陳主管" }
  ]
  reviewDeadline: "2024-04-27"
```

**審核檢查項:**
```
□ 進度計算正確
□ 完工證明齊全
□ 照片記錄完整
□ 測試報告有效
□ 變更單已核准
□ 金額計算無誤
```

### 業主審核

```
Event: CustomerReviewStarted
  requestId: "PAY-2024-04"
  submittedTo: "業主代表"
  submittedDate: "2024-04-28"
  reviewPeriod: "7 days"
  expectedApprovalDate: "2024-05-05"
```

**業主審核結果:**
```
Approved (核准):
  → PaymentApproved Event
  → 進入付款程序
  
ConditionalApproved (有條件核准):
  → 記錄保留意見
  → 部分金額先付
  → 餘額待補件
  
Rejected (退回):
  → PaymentRejected Event
  → 記錄退回原因
  → 補正後重新提交
```

## 請款追蹤

### 狀態追蹤

```
請款狀態流程:
  Draft (草稿)
    ↓
  Submitted (已提交)
    ↓
  InternalReview (內部審核)
    ↓
  CustomerReview (業主審核)
    ↓
  Approved (已核准)
    ↓
  PaymentProcessed (已付款)
    ↓
  Completed (完成)
```

### Event 記錄

```
Event: PaymentStatusChanged
  requestId: "PAY-2024-04"
  fromStatus: "CustomerReview"
  toStatus: "Approved"
  changedBy: "業主代表"
  changedAt: "2024-05-05"
  comments: "進度符合,核准付款"
  nextAction: "ProcessPayment"
```

## 付款執行

### 付款通知

```
Event: PaymentProcessed
  requestId: "PAY-2024-04"
  approvedAmount: 5,234,567
  paymentDate: "2024-05-10"
  paymentMethod: "BankTransfer"
  bankAccount: "XXX-XXX-XXXXX"
  transactionId: "TXN-20240510-001"
  paidBy: "業主財務部"
```

### 收款確認

```
Event: PaymentReceived
  requestId: "PAY-2024-04"
  receivedAmount: 5,234,567
  receivedDate: "2024-05-10"
  confirmedBy: "財務部門"
  matchesRequest: true
```

## 異常處理

### 金額不符

```
Event: PaymentDiscrepancyIdentified
  requestId: "PAY-2024-04"
  requestedAmount: 5,234,567
  receivedAmount: 5,000,000
  discrepancy: -234,567
  reason: "保留部分金額待補件"
  actionRequired: "補齊文件後支付餘額"
```

### 延遲付款

```
Event: PaymentDelayed
  requestId: "PAY-2024-04"
  originalDueDate: "2024-05-10"
  delayedUntil: "2024-05-20"
  delayReason: "業主審核流程延遲"
  notifiedAt: "2024-05-08"
```

## 總結

請款流程的關鍵:
1. **週期管理** - 月結請款流程
2. **自動計算** - 基於 Task 完成度
3. **文件齊全** - 所有證明文件
4. **審核追蹤** - 內部與業主審核
5. **Event 記錄** - 完整請款歷史
