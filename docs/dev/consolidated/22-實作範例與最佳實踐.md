# 實作範例與最佳實踐

## 每日工作流程實例

### 早上 7:00 - 工地主管到場

**場景: 分配今日工作**

```typescript
// 1. 查看今日可用人力
const availableTeams = [
  { team: "張三組", members: 3 },
  { team: "李四組", members: 4 },
  { team: "王五組", members: 2 }
];

// 2. 查看待執行任務
const pendingTasks = await taskService.getPendingTasks({
  workPackageId: "WP-SS-A",
  status: "Pending"
});

// 3. 快速建立今日任務
await taskService.createTask({
  taskId: "task-20240315-01",
  title: "SS-A01 配線完成",
  assignedTo: "張三組",
  expectedPersonCount: 3,
  estimatedDuration: 8  // 小時
});

// 產生 Event: TaskCreated
// 產生 Event: TaskAssigned
```

### 上午 8:00 - 現場開始施工

```typescript
// 張三組開始工作
await taskService.startTask("task-20240315-01", {
  startedBy: "張三",
  actualPersonCount: 3,
  location: "SS-A 區域"
});

// 產生 Event: TaskStarted
```

### 上午 10:30 - 發現問題

```typescript
// 張三發現問題
await taskService.blockTask("task-20240315-01", {
  blockReason: "Relay 規格不符,需要確認",
  blockType: "Material",
  photos: ["photo-issue-001.jpg"],
  blockedBy: "張三"
});

// 產生 Event: TaskBlocked

// 工地主管收到通知,建立新任務
await taskService.createTask({
  taskId: "task-20240315-urgent",
  title: "確認 Relay 規格",
  priority: "High",
  assignedTo: "工地主管",
  relatedTask: "task-20240315-01"
});

// 調派張三組去做其他工作
await taskService.createTask({
  taskId: "task-20240315-02",
  title: "SS-A02 機櫃定位",
  assignedTo: "張三組"
});
```

### 下午 14:30 - 問題解決

```typescript
// Relay 規格確認完成
await taskService.completeTask("task-20240315-urgent", {
  completedBy: "工地主管",
  notes: "已確認正確規格為 Model-X2000",
  resolution: "已通知供應商送貨"
});

// 恢復原任務
await taskService.resumeTask("task-20240315-01", {
  resolvedHow: "已更換正確規格 Relay",
  resumedBy: "張三"
});

// 產生 Event: TaskResumed
```

### 下午 16:00 - 任務完成

```typescript
// 張三組完成配線
await taskService.completeTask("task-20240315-01", {
  completedBy: "張三",
  actualDuration: 6,  // 實際工時 (扣除阻擋時間)
  actualManHours: 18,  // 3人 × 6小時
  completionPhotos: ["photo-result-001.jpg"],
  qualityCheck: "Passed",
  notes: "配線施工完成,已自檢通過"
});

// 產生 Event: TaskCompleted

// 自我檢查
await taskService.performSelfCheck("task-20240315-01", {
  checkedBy: "張三",
  checkResult: "Passed",
  checkItems: [
    { item: "配線整齊度", result: "OK" },
    { item: "接線正確性", result: "OK" },
    { item: "標示清晰度", result: "OK" }
  ]
});

// 產生 Event: TaskSelfChecked
```

### 下午 17:00 - 內部驗收

```typescript
// 工地主管驗收
await taskService.performInternalAcceptance(
  "task-20240315-01", 
  {
    inspector: "工地主管-王五",
    inspectionType: "Visual",
    result: "Approved",
    photos: ["inspection-001.jpg"],
    signature: "Wang-Wu-Sign"
  }
);

// 產生 Event: InternalAcceptancePerformed
```

### 晚上 17:30 - 撰寫日誌

```typescript
// 系統自動彙整今日工作
const dailyReport = await reportService.generateDailyReport({
  date: "2024-03-15",
  workPackageId: "WP-SS-A"
});

/*
自動產生內容:
- 出工人數: 9人 (張三組3人, 李四組4人, 王五組2人)
- 完成任務: 2項
  - SS-A01 配線完成 ✓
  - SS-A02 機櫃定位 ✓
- 進行中: 1項
  - SS-A03 內部組裝 (60%)
- 阻擋/解決: 1項
  - Relay 規格問題 (已解決)
- 總人工: 72 人時
- 附件: 15 張照片
*/

// 主管補充說明
await reportService.addNotes(dailyReport.id, {
  notes: "今日完成 SS-A01 配線與 SS-A02 定位,整體進度良好。" +
         "Relay 規格問題已解決,不影響整體進度。" +
         "明日計畫: 完成 SS-A03 組裝,開始 SS-A04 搬運。"
});

// 產生 Event: DailyReportPublished
```

## 進階場景: Task 分割

### 情境: 發現任務太複雜需要拆分

```typescript
// 原本的粗粒度 Task
const originalTask = {
  taskId: "task-SS-A",
  title: "SS-A 區機櫃安裝",
  estimatedDuration: 336  // 14天 × 24小時
};

// 工地主管決定拆分
await taskService.splitTask("task-SS-A", {
  splitReason: "工作太複雜,需要詳細規劃",
  splitBy: "工地主管",
  childTasks: [
    {
      taskId: "task-SS-A-01",
      title: "SS-A01 機櫃安裝",
      assignedTo: "張三組",
      estimatedDuration: 72  // 3天
    },
    {
      taskId: "task-SS-A-02",
      title: "SS-A02 機櫃安裝",
      assignedTo: "李四組",
      estimatedDuration: 72
    },
    {
      taskId: "task-SS-A-03",
      title: "SS-A03 機櫃安裝",
      assignedTo: "張三組",
      estimatedDuration: 72
    },
    {
      taskId: "task-SS-A-04",
      title: "SS-A04 機櫃安裝",
      assignedTo: "李四組",
      estimatedDuration: 72
    }
  ]
});

// 產生 Events:
// 1. TaskSplit
// 2. TaskCreated × 4 (子任務)
// 3. ParentTaskStatusChanged (父任務變為 InProgress)
```

### 子任務進一步拆分

```typescript
// 張三組發現 SS-A01 還需要更細的規劃
await taskService.splitTask("task-SS-A-01", {
  splitReason: "需要不同專業團隊配合",
  splitBy: "張三",
  childTasks: [
    {
      taskId: "task-SS-A-01-1",
      title: "SS-A01 搬運定位",
      assignedTo: "吊裝專業",
      estimatedDuration: 4
    },
    {
      taskId: "task-SS-A-01-2",
      title: "SS-A01 內部組裝",
      assignedTo: "機電專業",
      estimatedDuration: 8
    },
    {
      taskId: "task-SS-A-01-3",
      title: "SS-A01 配線施工",
      assignedTo: "配線專業",
      estimatedDuration: 8
    },
    {
      taskId: "task-SS-A-01-4",
      title: "SS-A01 測試驗收",
      assignedTo: "儀控專業",
      estimatedDuration: 4
    }
  ]
});

// 形成階層:
// task-SS-A (父)
//   └─ task-SS-A-01 (子)
//       ├─ task-SS-A-01-1 (孫)
//       ├─ task-SS-A-01-2 (孫)
//       ├─ task-SS-A-01-3 (孫)
//       └─ task-SS-A-01-4 (孫)
```

## 協作場景: 多專業團隊

### 順序交接

```typescript
// Task 1: 吊裝完成
await taskService.completeTask("task-SS-A-01-1", {
  completedBy: "吊裝專業-劉師傅"
});

// 交接給下一個專業
await taskService.handoverTask({
  fromTask: "task-SS-A-01-1",
  toTask: "task-SS-A-01-2",
  fromTeam: "吊裝專業",
  toTeam: "機電專業",
  handoverNotes: "機櫃已定位,水平度 OK,已固定",
  handoverPhotos: ["handover-001.jpg"],
  handedOverBy: "劉師傅",
  receivedBy: "機電專業-陳師傅"
});

// 產生 Event: TaskHandedOver

// Task 2 自動變為 Ready 狀態
// 通知機電專業可以開始作業
```

### 並行協作

```typescript
// 需要兩個專業同時作業
await taskService.startCollaboration({
  taskId: "task-SS-A-01-3",
  primaryTeam: "配線專業",
  supportingTeams: ["儀控專業"],
  collaborationReason: "配線與測試需要同步進行",
  coordinator: "工地主管"
});

// 產生 Event: TeamCollaborationStarted
```

## 請款流程實例

### 月底計算可請款金額

```typescript
// 2024-03-31: 月底結算
const monthlyPayment = await paymentService.calculateMonthlyPayment({
  periodStart: "2024-03-01",
  periodEnd: "2024-03-31",
  contractId: "CONTRACT-2024-001"
});

/*
自動計算結果:
{
  totalCompletedAmount: 14,768,021,
  completedItems: [
    {
      itemId: "item-110",
      itemName: "Frontend機櫃",
      totalQuantity: 16,
      completedQuantity: 4,
      completedPercentage: 25,
      itemAmount: 2,639,062,
      completedAmount: 659,765
    },
    // ... 其他項次
  ],
  retentionPercentage: 10,
  retentionAmount: 1,476,802,
  netPaymentAmount: 13,291,219
}
*/

// 產生 Event: PaymentRequestDraftCreated
```

### 準備請款文件

```typescript
// 自動收集證據
const paymentDocuments = await paymentService.prepareDocuments(
  monthlyPayment.id
);

/*
自動產生:
1. 請款明細表 (Excel)
   - 列出所有完成的 Contract Items
   - 計算金額
   
2. 完工證明 (PDF)
   - 收集所有 TaskCompleted Events
   - 包含驗收簽核記錄
   
3. 施工照片集 (ZIP)
   - 從所有 Tasks 收集照片
   - 按項次分類
   
4. 日誌摘要 (PDF)
   - 3月份每日工程日誌
   - 人工統計
*/
```

### 提交審核

```typescript
// 內部審核流程
await paymentService.submitForReview(monthlyPayment.id, {
  reviewers: [
    "工地主管",
    "專案經理",
    "財務部門"
  ]
});

// 每層審核通過後產生 Event
// Event: PaymentRequestReviewedByPM
// Event: PaymentRequestReviewedByManager
// Event: PaymentRequestReviewedByFinance

// 全部通過後提交客戶
await paymentService.submitToClient(monthlyPayment.id, {
  submittedTo: "ABB採購部",
  submissionMethod: "Email + Portal"
});

// 產生 Event: PaymentRequestSubmittedToClient
```

## 最佳實踐總結

### 1. Process 設計原則

**DO (應該這樣做):**
- 定義清晰的標準流程
- 提供建議但不強制
- 支援流程變體
- 記錄所有偏離

**DON'T (不應該這樣做):**
- 過度複雜的流程引擎
- 強制所有情況都走固定流程
- 忽略現場實際狀況
- 沒有彈性空間

### 2. Task 管理原則

**DO:**
- 粒度適中 (半天~2天)
- 清楚的責任歸屬
- 靈活的狀態轉換
- 完整的歷史記錄

**DON'T:**
- 太細導致管理成本高
- 太粗導致無法追蹤
- 狀態轉換過於複雜
- 缺少異常處理機制

### 3. Event 記錄原則

**DO:**
- 記錄所有重要狀態變化
- 包含完整的因果關係
- 附加必要的證據(照片)
- 保持不可變性

**DON'T:**
- 記錄過於瑣碎的事件
- 忽略因果關係
- 缺少證據支持
- 事後修改歷史

### 4. 協作溝通原則

**DO:**
- 明確的交接點
- 清楚的責任界限
- 及時的問題通知
- 完整的交接記錄

**DON'T:**
- 模糊的責任歸屬
- 缺少交接文件
- 延遲問題通報
- 口頭約定不記錄

### 5. 財務管理原則

**DO:**
- 自動化計算
- 完整的證據鏈
- 多重審核機制
- 清晰的追溯能力

**DON'T:**
- 手動計算容易錯誤
- 缺少證據文件
- 單一審核者
- 無法追溯來源

## 開發建議

### TypeScript 實作範例

```typescript
// Domain Event
interface DomainEvent {
  readonly eventId: string;
  readonly eventType: string;
  readonly aggregateId: string;
  readonly causedBy: string[];
  readonly timestamp: Date;
  readonly data: unknown;
}

// Task Aggregate
class Task {
  private events: DomainEvent[] = [];
  
  constructor(
    private taskId: string,
    private title: string
  ) {}
  
  // 狀態變更方法
  start(startedBy: string): void {
    this.addEvent({
      eventType: 'TaskStarted',
      data: { startedBy }
    });
  }
  
  complete(completedBy: string): void {
    this.addEvent({
      eventType: 'TaskCompleted',
      data: { completedBy }
    });
  }
  
  // 取得未提交的事件
  getUncommittedEvents(): DomainEvent[] {
    return [...this.events];
  }
  
  // 清除已提交的事件
  clearEvents(): void {
    this.events = [];
  }
  
  private addEvent(event: Partial<DomainEvent>): void {
    this.events.push({
      eventId: uuid(),
      aggregateId: this.taskId,
      causedBy: this.getLastEventId(),
      timestamp: new Date(),
      ...event
    } as DomainEvent);
  }
}
```

## 總結

實作的核心要點:
1. **簡單實用** - 不過度設計
2. **現場優先** - 尊重實際需求
3. **完整記錄** - Events 保留歷史
4. **自動化** - 減少手動負擔
5. **彈性調整** - 支援動態變化
