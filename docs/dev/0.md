# Task 的階層拆分與 Event-Sourced 系統整合

## 1. Task 的樹狀結構

### 概念模型

```
Contract Item (合約項次)
  項次 110: Frontend 機櫃 16 SET
  ↓
Parent Task (父任務)
  Task-110: Frontend 機櫃安裝工程
  金額: 2,639,062 元
  ↓
Child Tasks (子任務 - 第一層)
  ├─ Task-110-A: SS-A 區機櫃 (4 SET)
  │   金額: 659,765 元
  │   ↓
  │   Grandchild Tasks (孫任務 - 第二層)
  │   ├─ Task-110-A-01: 機櫃搬運定位
  │   ├─ Task-110-A-02: 內部設備組裝
  │   ├─ Task-110-A-03: 配線施工
  │   ├─ Task-110-A-04: 測試調試
  │   └─ Task-110-A-05: 驗收交付
  │
  ├─ Task-110-B: SS-B 區機櫃 (6 SET)
  │   金額: 989,647 元
  │   ↓
  │   ├─ Task-110-B-01: 機櫃搬運定位
  │   ├─ Task-110-B-02: 內部設備組裝
  │   └─ ... (同上結構)
  │
  └─ Task-110-C: SS-C 區機櫃 (6 SET)
      金額: 989,650 元
      ↓
      └─ ... (同上結構)
```

### 為什麼需要拆分?

**管理粒度的需求**:
```
不拆分的問題:
  Task-110: Frontend 機櫃 16 SET
  → 太大,無法追蹤細節
  → 不知道哪個區域卡住
  → 不知道哪個步驟有問題
  → 難以分配給不同團隊

拆分後的好處:
  ├─ 可以按區域分配
  ├─ 可以按工序分配
  ├─ 可以細緻追蹤進度
  └─ 可以明確責任歸屬
```

**協作的需求**:
```
Task-110-A-01: 機櫃搬運定位
  → 指派給: 吊裝專業團隊

Task-110-A-02: 內部設備組裝
  → 指派給: 機電專業團隊

Task-110-A-03: 配線施工
  → 指派給: 配線專業團隊

不同專業,不同團隊,需要拆分才能管理
```

## 2. Task 拆分的 Event 設計

### 拆分動作本身就是 Events

```
Event: TaskCreated
  taskId: "task-110"
  parentTaskId: null  // 頂層任務
  taskType: "Parent"
  title: "Frontend 機櫃安裝工程"
  contractItemId: "item-110"
  totalAmount: 2,639,062
  totalQuantity: 16
  unit: "SET"
  status: "Created"
  timestamp: "2024-03-01 10:00:00"

↓

Event: TaskSplit
  parentTaskId: "task-110"
  splitStrategy: "ByLocation"  // 按區域拆分
  childTasks: [
    {
      taskId: "task-110-A",
      title: "SS-A 區機櫃",
      quantity: 4,
      amount: 659,765
    },
    {
      taskId: "task-110-B", 
      title: "SS-B 區機櫃",
      quantity: 6,
      amount: 989,647
    },
    {
      taskId: "task-110-C",
      title: "SS-C 區機櫃", 
      quantity: 6,
      amount: 989,650
    }
  ]
  splitBy: "PM-王經理"
  timestamp: "2024-03-05 14:30:00"

↓

Event: TaskCreated (自動產生 3 個)
  taskId: "task-110-A"
  parentTaskId: "task-110"
  taskType: "Child"
  ...

Event: TaskCreated
  taskId: "task-110-B"
  parentTaskId: "task-110"
  ...

Event: TaskCreated
  taskId: "task-110-C"
  parentTaskId: "task-110"
  ...

↓

Event: TaskSplit (第二層拆分)
  parentTaskId: "task-110-A"
  splitStrategy: "ByPhase"  // 按工序拆分
  childTasks: [
    { taskId: "task-110-A-01", title: "機櫃搬運定位" },
    { taskId: "task-110-A-02", title: "內部設備組裝" },
    { taskId: "task-110-A-03", title: "配線施工" },
    { taskId: "task-110-A-04", title: "測試調試" },
    { taskId: "task-110-A-05", title: "驗收交付" }
  ]
  timestamp: "2024-03-10 09:00:00"
```

### 拆分的規則與限制

```
拆分規則:

1. 金額守恆
   父任務金額 = 所有子任務金額之和
   2,639,062 = 659,765 + 989,647 + 989,650 ✓

2. 數量守恆 (如果是數量計價)
   父任務數量 = 所有子任務數量之和
   16 SET = 4 + 6 + 6 ✓

3. 只能拆分 Pending/Created 狀態的任務
   如果已經開始執行,不能拆分 (避免混亂)

4. 拆分後父任務變成「容器」
   - 父任務不能直接執行
   - 只能追蹤子任務的總進度
   - 父任務的完成 = 所有子任務完成

5. 可以隨時合併回去
   如果發現拆分不合適,可以 TaskMerge
```

## 3. 父子任務的狀態聯動

### 向上聚合 (Bottom-Up)

```
子任務狀態變化 → 自動更新父任務狀態

範例:
Task-110 (父)
  ├─ Task-110-A (子): Completed ✓
  ├─ Task-110-B (子): In Progress (80%)
  └─ Task-110-C (子): Pending

父任務的狀態計算:
  狀態: In Progress
  進度: (100% + 80% + 0%) / 3 = 60%

當所有子任務都 Completed:
  → Event: TaskCompleted (task-110)
  → 父任務自動標記為完成
```

### 向下傳遞 (Top-Down)

```
父任務的某些變更 → 影響所有子任務

範例 1: 父任務取消
  Event: TaskCancelled (task-110)
  原因: "業主取消此項工程"
  
  → 自動產生子任務取消 Events:
    Event: TaskCancelled (task-110-A)
    Event: TaskCancelled (task-110-B)
    Event: TaskCancelled (task-110-C)
  
  → 子任務的子任務也遞迴取消

範例 2: 父任務期限調整
  Event: TaskDeadlineChanged (task-110)
  原期限: 2024-06-30
  新期限: 2024-07-15
  
  → 子任務期限自動順延
  
範例 3: 父任務預算調整
  Event: TaskBudgetAdjusted (task-110)
  原預算: 2,639,062
  新預算: 2,900,000
  增加: 260,938
  
  → 需要決定如何分配到子任務
    選項 A: 平均分配
    選項 B: 按比例分配
    選項 C: 手動指定分配
```

## 4. Process 如何支持階層化 Task

### Process 定義階層化流程

```
Process: Frontend 機櫃標準安裝流程

Tier 1: 總體流程 (對應父任務)
  Step 1: 規劃與準備
  Step 2: 區域拆分
  Step 3: 各區域執行
  Step 4: 整體驗收

Tier 2: 區域流程 (對應子任務)
  Step 1: 現場勘查
  Step 2: 材料進場
  Step 3: 工序拆分
  Step 4: 各工序執行
  Step 5: 區域驗收

Tier 3: 工序流程 (對應孫任務)
  根據不同工序有不同的詳細步驟
```

### Process 觸發 Task 拆分

```
當父任務到達某個節點時,Process 建議拆分:

Event: TaskCreated (task-110)
  ↓
Process 判斷:
  "這是 Frontend 機櫃安裝,數量 > 10 SET"
  → 建議按區域拆分
  ↓
系統提示專案經理:
  "建議將此任務拆分為 3 個區域任務?"
  [SS-A: 4 SET] [SS-B: 6 SET] [SS-C: 6 SET]
  ↓
專案經理確認或調整
  ↓
產生 TaskSplit Event
  ↓
自動建立子任務
  ↓
每個子任務套用「區域安裝流程」Process
```

### Process 的階層模板

```
TemplateProcess: 機櫃安裝總流程
  適用於: 父任務 (數量 > 5)
  
  階段 1: 規劃
    → 建議拆分策略
    → 等待確認
  
  階段 2: 執行
    → 監控子任務進度
    → 子任務異常時預警
  
  階段 3: 整合
    → 所有子任務完成後
    → 進行整體驗收

TemplateProcess: 單區機櫃安裝流程
  適用於: 子任務 (區域級別)
  
  階段 1: 準備
    → 現場勘查
    → 材料進場
  
  階段 2: 拆分工序
    → 建議拆分為 5 個工序任務
  
  階段 3: 執行
    → 監控工序任務進度
  
  階段 4: 驗收
    → 區域驗收

TemplateProcess: 機櫃搬運定位流程
  適用於: 孫任務 (工序級別)
  
  詳細步驟:
    1. 路線勘查
    2. 吊裝準備
    3. 搬運作業
    4. 定位校正
    5. 固定確認
```

## 5. Causality 因果關係的體現

### 拆分造成的因果鏈

```
Cause: 專案經理決定拆分任務
  Event: TaskSplit (task-110)
  
Effect 1: 建立子任務
  Event: TaskCreated (task-110-A)
  Event: TaskCreated (task-110-B)
  Event: TaskCreated (task-110-C)

Effect 2: 父任務狀態變更
  Event: TaskStatusChanged (task-110)
  from: "Created"
  to: "Decomposed"  // 已拆解,等待子任務執行

Effect 3: 觸發指派流程
  因為有了具體的子任務
  → 可以指派給不同團隊
  Event: TaskAssigned (task-110-A) → Team-A
  Event: TaskAssigned (task-110-B) → Team-B
  Event: TaskAssigned (task-110-C) → Team-C
```

### 子任務執行的因果鏈

```
Cause: 子任務 A 完成
  Event: TaskCompleted (task-110-A)

Effect 1: 更新父任務進度
  Event: TaskProgressUpdated (task-110)
  progress: 0% → 25%  // 假設等權重

Effect 2: 觸發下一步驟
  如果 Process 定義了順序依賴:
  "Task-110-A 完成後才能開始 Task-110-B"
  → Event: TaskUnblocked (task-110-B)
  → 通知 Team-B 可以開始

Effect 3: 檢查里程碑
  如果 Task-110-A 是某個 Milestone 的一部分
  → 更新 Milestone 進度
  → Event: MilestoneProgressUpdated
```

### 異常的因果傳遞

```
Cause: 孫任務驗收失敗
  Event: InternalAcceptanceFailed (task-110-A-02)
  原因: "內部配線不符規範"

Effect 1: 子任務阻擋
  Event: TaskBlocked (task-110-A)
  原因: "等待 task-110-A-02 返工"

Effect 2: 父任務預警
  Event: TaskRiskDetected (task-110)
  風險: "子任務 110-A 阻擋,可能影響整體進度"

Effect 3: 通知相關人員
  → 通知 Team-A: 你的任務有問題
  → 通知專案經理: Task-110 有風險
  → 更新日誌: 記錄異常事件

Effect 4: 觸發應變流程
  Process 判斷:
    "如果阻擋超過 2 天,啟動緊急處理"
  → 安排額外資源
  → 調整後續任務時程
```

## 6. 實際執行場景

### 場景: 完整的拆分與執行過程

```
Day 1: 建立父任務
  Event: TaskCreated (task-110)
  title: "Frontend 機櫃 16 SET"
  amount: 2,639,062
  status: "Created"

Day 3: 現場勘查後決定拆分
  專案經理: "三個區域分開做"
  
  Event: TaskSplit (task-110)
  strategy: "ByLocation"
  children: [110-A, 110-B, 110-C]
  
  Event: TaskStatusChanged (task-110)
  to: "Decomposed"

Day 5: 進一步拆分 SS-A 區
  現場主管: "SS-A 區按工序拆分"
  
  Event: TaskSplit (task-110-A)
  strategy: "ByPhase"
  children: [110-A-01, 110-A-02, 110-A-03, 110-A-04, 110-A-05]

Day 7: 開始執行最底層任務
  Event: TaskStarted (task-110-A-01)
  assignee: "張三組 - 吊裝專業"
  
Day 9: 第一個孫任務完成
  Event: TaskCompleted (task-110-A-01)
  
  → 自動觸發:
    Event: TaskProgressUpdated (task-110-A)
    progress: 0% → 20%
    
    Event: TaskProgressUpdated (task-110)
    progress: 0% → 1.25%  // 1/16 的 1/5
    
Day 10: 開始第二個孫任務
  Event: TaskStarted (task-110-A-02)
  assignee: "李四組 - 機電專業"

... (依序執行)

Day 30: SS-A 區所有孫任務完成
  最後一個:
    Event: TaskCompleted (task-110-A-05)
  
  → 自動觸發:
    Event: TaskCompleted (task-110-A)
    reason: "所有子任務已完成"
    
    Event: TaskProgressUpdated (task-110)
    progress: 25% → 50%  // 假設 A 和 B 都完成

Day 60: 所有區域完成
  Event: TaskCompleted (task-110-C)
  
  → 自動觸發:
    Event: TaskCompleted (task-110)
    reason: "所有子任務已完成"
    
  → 觸發里程碑:
    Event: MilestoneAchieved (Frontend 機櫃安裝完成)
```

## 7. 資料結構設計

### Task 的欄位擴充

```typescript
// 概念模型 (TypeScript 風格)

interface Task {
  // 基本資訊
  taskId: string;
  title: string;
  description: string;
  
  // 階層關係 (關鍵!)
  parentTaskId: string | null;  // null = 頂層任務
  childTaskIds: string[];        // 子任務列表
  taskLevel: number;             // 0=頂層, 1=子任務, 2=孫任務...
  taskPath: string;              // "task-110/task-110-A/task-110-A-01"
  
  // 狀態
  status: TaskStatus;
  isDecomposed: boolean;         // 是否已拆分
  canBeExecuted: boolean;        // 能否直接執行 (有子任務就不能)
  
  // 金額與數量
  totalAmount: number;
  allocatedAmount: number;       // 已分配給子任務的金額
  remainingAmount: number;       // 尚未分配的金額
  quantity?: number;
  unit?: string;
  
  // 進度 (自動計算)
  progress: number;              // 0-100
  progressCalculationMethod: 'Manual' | 'FromChildren';
  
  // 其他欄位...
}
```

### Event Store 查詢

```
查詢 1: 取得任務的所有子任務
  Query: 
    SELECT * FROM events 
    WHERE eventType = 'TaskCreated' 
    AND data.parentTaskId = 'task-110'
  
  Result: [task-110-A, task-110-B, task-110-C]

查詢 2: 取得任務的完整階層樹
  遞迴查詢:
    1. 取得 task-110
    2. 取得 task-110 的所有子任務
    3. 對每個子任務重複步驟 2
  
  Result: 完整的樹狀結構

查詢 3: 取得任務的所有祖先
  向上追溯:
    task-110-A-02 
    → parentTaskId = task-110-A
    → parentTaskId = task-110
    → parentTaskId = null (到頂)
  
  Result: [task-110, task-110-A]

查詢 4: 計算父任務進度
  聚合查詢:
    1. 取得所有子任務
    2. 取得每個子任務的最新進度
    3. 計算平均或加權平均
  
  Result: 父任務進度 = XX%
```

## 8. 拆分策略的預設模板

### 系統內建的拆分策略

```
策略 1: 按區域拆分 (ByLocation)
  適用: 跨多個區域的重複性工作
  範例:
    Parent: 機櫃安裝 16 SET
    → Child: SS-A 區 4 SET
    → Child: SS-B 區 6 SET
    → Child: SS-C 區 6 SET

策略 2: 按工序拆分 (ByPhase)
  適用: 單一位置的多階段工作
  範例:
    Parent: SS-A01 機櫃安裝
    → Child: 搬運定位
    → Child: 內部組裝
    → Child: 配線施工
    → Child: 測試調試
    → Child: 驗收交付

策略 3: 按數量拆分 (ByQuantity)
  適用: 大批量的相同工作
  範例:
    Parent: 配線 200 條
    → Child: 第 1-50 條
    → Child: 第 51-100 條
    → Child: 第 101-150 條
    → Child: 第 151-200 條

策略 4: 按專業拆分 (ByDiscipline)
  適用: 需要不同專業協作的工作
  範例:
    Parent: 變電站整合工程
    → Child: 土建工程
    → Child: 電氣工程
    → Child: 儀控工程
    → Child: 通訊工程

策略 5: 按時間拆分 (ByTime)
  適用: 長期持續性工作
  範例:
    Parent: 監工服務 (6 個月)
    → Child: 第 1 個月
    → Child: 第 2 個月
    → ...
    → Child: 第 6 個月
```

## 9. 重點總結

### Event-Sourced 系統如何支持階層化 Task

**1. 拆分本身就是 Event**
```
TaskSplit Event 記錄:
  - 誰拆分的
  - 什麼時候拆分
  - 為什麼拆分
  - 怎麼拆分的
  
完整可追溯,可重播
```

**2. 父子關係透過 Events 建立**
```
不是在資料庫建立外鍵關係
而是透過 TaskCreated Event 的 parentTaskId 欄位
  → Event Sourcing 的優勢:
    - 可以重播歷史
    - 可以看到拆分的演變過程
```

**3. 狀態聚合透過 Events 計算**
```
父任務的進度不是直接儲存
而是透過讀取所有子任務的 Events 計算出來
  → 保證資料一致性
  → 永遠能回溯計算
```

**4. Causality 自然體現**
```
Event 之間的因果關係清晰:
  TaskSplit → TaskCreated (子任務)
  TaskCompleted (子) → TaskProgressUpdated (父)
  TaskBlocked (孫) → TaskRiskDetected (父)
```

**5. Process 協調階層流程**
```
不同層級的 Task 套用不同的 Process
Process 可以建議拆分時機與策略
Process 監控整體執行狀態
```

這樣的設計讓你的系統能夠:
- ✓ 支持任意深度的任務拆分
- ✓ 保持完整的歷史記錄
- ✓ 自動聚合狀態與進度
- ✓ 靈活應對現場變化
- ✓ 清晰追溯因果關係

# 六大功能模塊設計思路

## 1. 日誌功能 - 自動彙整 Task Events 產生日報

### 核心概念
**日報 = 當日所有 Task Events 的結構化摘要 + 人工補充**

### 自動彙整機制

```
每日 23:50 系統自動執行:

Step 1: 收集當日所有 Events
  - 篩選條件: eventDate = Today
  - 事件類型: Task 相關的所有 Events

Step 2: 按類別分組統計
  ├─ 新建 Tasks: 5 個
  ├─ 完成 Tasks: 3 個
  ├─ 驗收通過: 2 個
  ├─ 驗收失敗: 1 個
  ├─ 阻擋中: 1 個
  └─ 進度更新: 8 個

Step 3: 按工區/分支彙總
  ├─ SS-A 區:
  │   ├─ 進行中: 3 Tasks
  │   ├─ 完成: 1 Task
  │   └─ 人力投入: 12 人 × 8 小時
  ├─ SS-B 區:
  │   ├─ 進行中: 5 Tasks
  │   └─ 人力投入: 8 人 × 8 小時
  └─ 下包商 A:
      ├─ 完成: 2 Tasks
      └─ 等待驗收: 1 Task

Step 4: 計算關鍵指標
  - 總人工: 96 人時
  - 完成工作量: 3,500,000 元
  - 累計完成率: 45.2%
  - 今日完成率: +2.3%

Step 5: 標註異常事項
  - Task-040: 驗收失敗 (需返工)
  - Task-055: 材料延遲 (阻擋中)
  - SS-C 區: 今日無進度 (待查)
```

### 日報的結構

```
工程日誌 - 2024年3月20日 (星期三)

【天氣】晴 23°C
【出工狀況】
  - 宏林自有: 20 人
  - 下包商 A: 12 人
  - 下包商 B: 8 人
  - 總計: 40 人

【今日完成】(系統自動彙整)
  ✓ Task-020: SS-A01 機櫃安裝完成
  ✓ Task-025: SS-A02 配線完成
  ✓ Task-030: SS-A03 測試通過

【今日進度】(系統自動彙整)
  • Task-040: SS-B01 機櫃安裝 (80%)
  • Task-045: SS-B02 配線施工 (50%)
  • Task-050: SS-B03 光纖熔接 (30%)

【驗收記錄】(系統自動彙整)
  ✓ Task-020: 專案經理驗收通過
  ✗ Task-035: 驗收不通過 - 線路標示不清

【異常事項】(系統自動標註 + 人工補充)
  ! Task-055: 材料延遲,預計明日到貨
  ! Task-035: 需返工,已安排明日處理
  ! SS-C 區: 等待業主放行,暫停施工

【主管說明】(人工補充)
  今日 SS-A 區進度良好,預計本週五完成所有安裝。
  SS-B 區受材料延遲影響,整體進度延後一天。
  SS-C 區因業主臨時要求調整設計,等待確認中。

【明日計畫】(人工補充 或 系統建議)
  - 完成 SS-B01, SS-B02
  - 處理 Task-035 返工
  - 材料到貨後立即開始 SS-B03
  - 協調業主確認 SS-C 區設計

【照片記錄】(系統自動附加當日上傳的照片)
  [8 張照片]

【附件文件】
  - Task-020 驗收單
  - Task-035 缺失照片
```

### 特殊日報類型

**周報**: 自動彙整本週 5 天的日報
**月報**: 自動彙整本月所有日報 + 財務數據
**專項報告**: 針對特定工區或里程碑的進度報告

---

## 2. 里程碑機制 - 從 Tasks 推算達成率

### 里程碑的定義

```
Milestone: SS-A 區完工驗收
  
  達成條件:
  ├─ 必須完成的 Tasks (強制):
  │   ├─ Task-001~010: 機櫃安裝 (10個)
  │   ├─ Task-011~020: 配線施工 (10個)
  │   ├─ Task-021~025: 測試驗收 (5個)
  │   └─ 條件: 所有 Tasks 狀態 = Fully Accepted
  │
  ├─ 品質要求:
  │   ├─ 所有 Tasks 驗收通過率 = 100%
  │   └─ 無未解決的缺失項目
  │
  ├─ 文件要求:
  │   ├─ 竣工圖 (1 份)
  │   ├─ 測試報告 (25 份)
  │   └─ 驗收照片 (完整)
  │
  └─ 時間要求:
      └─ 目標日期: 2024-04-15
```

### 達成率計算

```
Milestone 進度計算公式:

進度 = (已完成 Tasks / 總 Tasks) × 權重係數

例如:
SS-A 區完工里程碑
  ├─ 機櫃安裝 (10 Tasks): 
  │   ├─ 已完成: 8 
  │   ├─ 權重: 40%
  │   └─ 貢獻: 8/10 × 40% = 32%
  │
  ├─ 配線施工 (10 Tasks):
  │   ├─ 已完成: 5
  │   ├─ 權重: 40%  
  │   └─ 貢獻: 5/10 × 40% = 20%
  │
  └─ 測試驗收 (5 Tasks):
      ├─ 已完成: 0
      ├─ 權重: 20%
      └─ 貢獻: 0/5 × 20% = 0%

總進度: 32% + 20% + 0% = 52%
```

### 智能預警機制

```
系統每日自動檢查:

預警 Level 1 (黃色):
  - 條件: 進度落後 > 5%
  - 例如: 目標 60%,實際 54%
  - 動作: 通知專案經理

預警 Level 2 (橘色):
  - 條件: 進度落後 > 10% 或 距離目標日期 < 7天
  - 動作: 通知專案經理 + 主管

預警 Level 3 (紅色):
  - 條件: 進度落後 > 15% 或 已逾期
  - 動作: 通知所有相關人員 + 啟動應變計畫

範例:
Milestone: SS-B 區完工
  目標日期: 2024-04-20
  今天: 2024-04-15
  剩餘天數: 5 天
  
  當前進度: 65%
  需要進度: 80% (才能準時完工)
  落後: 15%
  
  系統判斷: 🔴 紅色警示
  建議: 增加人力或調整範圍
```

### 里程碑的依賴關係

```
Milestone A: SS-A 區機櫃安裝完成
  ↓ (依賴)
Milestone B: SS-A 區配線完成
  ↓ (依賴)  
Milestone C: SS-A 區測試驗收
  ↓ (依賴)
Milestone D: SS-A 區整體完工

規則:
- Milestone A 未達成,B 不能開始
- 如果 A 延遲,系統自動推算 B、C、D 的影響
- 關鍵路徑標註 (Critical Path)
```

### 責任追溯

```
如果 Milestone 延誤:

追溯路徑:
Milestone 延誤
  ↓ 查詢
哪些 Tasks 延誤?
  ├─ Task-015: 延誤 3 天
  ├─ Task-018: 延誤 2 天
  └─ Task-022: 阻擋中 5 天
  ↓ 查詢
為什麼延誤?
  ├─ Task-015: 
  │   └─ 原因: 材料延遲 (供應商責任)
  ├─ Task-018:
  │   └─ 原因: 人力不足 (管理責任)  
  └─ Task-022:
      └─ 原因: 業主未放行 (外部因素)
  ↓ 分析
責任歸屬:
  - 供應商責任: 30%
  - 管理責任: 20%
  - 外部因素: 50%
```

---

## 3. 協作者介面 - 下包商看到的畫面

### 分支隔離的視覺設計

```
【下包商 A 登入後的首頁】

頂部資訊:
  歡迎回來,下包商 A (光明機電)
  合約編號: SUB-2024-001
  合約金額: 5,000,000 元
  
我的儀表板:
  ┌─────────────────┐
  │ 待處理 Tasks     │ 8 個
  │ 進行中 Tasks     │ 5 個  
  │ 等待驗收        │ 3 個
  │ 已完成          │ 12 個
  └─────────────────┘
  
  ┌─────────────────┐
  │ 本月已請款      │ 1,200,000
  │ 待收款          │ 800,000
  │ 可請款 (待驗收)  │ 500,000
  └─────────────────┘
```

### Task 列表視圖

```
【我的 Tasks】

篩選: [全部] [待執行] [進行中] [等待驗收] [已完成]
排序: [截止日期] [優先級] [金額]

┌──────────────────────────────────────┐
│ Task-020: SS-A01 機櫃安裝              │
│ 狀態: 🟡 等待驗收                      │
│ 截止: 2024-03-25                      │
│ 金額: 400,000 元                      │
│ ├─ 已請款: 200,000 (50%)              │
│ ├─ 待驗收: 200,000 (50%)              │
│ └─ [查看詳情] [上傳照片]               │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ Task-025: SS-A02 配線施工              │
│ 狀態: 🟢 進行中 (65%)                  │
│ 截止: 2024-03-28                      │
│ 金額: 350,000 元                      │
│ ├─ 已請款: 175,000 (材料到場)         │
│ ├─ 進度: 預計明天完成                  │
│ └─ [更新進度] [上傳照片] [提交自檢]    │
└──────────────────────────────────────┘

┌──────────────────────────────────────┐
│ Task-030: SS-A03 光纖熔接              │
│ 狀態: ⚪ 待執行                        │
│ 截止: 2024-04-05                      │
│ 金額: 450,000 元                      │
│ └─ [開始執行]                          │
└──────────────────────────────────────┘
```

### Task 詳情頁面

```
【Task-020 詳情】

基本資訊:
  Task ID: Task-020
  工作內容: SS-A01 機櫃安裝
  工作地點: SS-A 電氣室
  負責人: 張三 (我方班組長)
  
進度時間軸:
  ✓ 2024-03-10: Task 建立並指派
  ✓ 2024-03-12: 材料進場驗收 → 已請款 50%
  ✓ 2024-03-15: 開始施工
  ✓ 2024-03-18: 安裝完成
  ✓ 2024-03-19: 提交自檢表
  🟡 2024-03-20: 等待專案經理驗收 ← 目前狀態
  
可執行動作:
  [上傳補充照片]
  [查看自檢表]
  [聯繫專案經理]
  
金額資訊:
  合約金額: 400,000
  ├─ 第一次請款 (材料): 200,000 ✓ 已收款
  └─ 第二次請款 (完工): 200,000 🟡 等待驗收
  
施工記錄:
  - 投入人力: 4 人 × 3 天
  - 使用材料: [材料清單]
  - 施工照片: [12 張照片]
  - 自檢表: [查看]
```

### 功能限制與開放

```
下包商 A 可以做的:
  ✓ 查看自己的 Tasks
  ✓ 更新 Task 進度
  ✓ 上傳照片/文件
  ✓ 提交自檢表
  ✓ 提交部分驗收文件 (材料清單、進度報表)
  ✓ 查看自己的請款記錄
  ✓ 與專案經理溝通 (留言功能)

下包商 A 不能做的:
  ✗ 看到其他下包商的 Tasks
  ✗ 看到主合約的金額與細節
  ✗ 看到宏林的成本結構
  ✗ 核准驗收 (只能提交)
  ✗ 直接請款 (需要主包核准)
  ✗ 修改 Task 基本資訊
```

### 通知機制

```
下包商 A 會收到的通知:

即時通知:
  - 新 Task 指派給你
  - 你的 Task 被退回 (驗收失敗)
  - 你的請款已核准
  - 專案經理有留言給你

每日摘要 (早上 8:00):
  - 今日需要執行的 Tasks
  - 逾期或即將逾期的 Tasks
  - 等待你提交文件的 Tasks

每週報告 (週一早上):
  - 上週完成狀況
  - 本週計畫
  - 財務狀況 (請款/收款)
```

---

## 4. 驗收單範本 - 不同類型的 Task

### 範本的動態產生機制

```
概念:
  Task 建立時,根據「工作類型」自動套用對應的驗收範本

工作類型分類:
  ├─ 材料進場類
  ├─ 機櫃安裝類
  ├─ 配線施工類
  ├─ 測試調試類
  ├─ 光纖熔接類
  └─ 其他類
```

### 範本 A: 材料進場驗收單

```
【材料進場驗收單】

Task: Task-010 機櫃材料進場
驗收日期: 2024-03-12
驗收人: 王工

一、數量清點
  項目                預計    實際    結果
  ├─ Frontend 機櫃    10      10      ✓
  ├─ 配件包          10      10      ✓
  └─ 說明書          10      10      ✓

二、外觀檢查
  □ 包裝完整,無破損
  □ 無碰撞、刮傷痕跡
  □ 標籤清晰可讀

三、規格確認
  □ 型號: XXX-2024 ✓ 符合
  □ 尺寸: 800×900×2000 ✓ 符合
  □ 顏色: RAL7035 ✓ 符合

四、文件檢查
  □ 出貨單
  □ 保固書
  □ 檢驗報告
  □ 產地證明 (進口貨)

五、照片記錄
  [6 張照片]

驗收結論:
  ☑ 通過,可入庫
  ☐ 部分通過,缺失: _______
  ☐ 不通過,原因: _______

驗收人簽名: ___________
日期: 2024-03-12
```

### 範本 B: 機櫃安裝驗收單

```
【機櫃安裝驗收單】

Task: Task-020 SS-A01 機櫃安裝
驗收日期: 2024-03-20
驗收人: 王經理

一、定位檢查
  □ 位置符合圖面
  □ 水平度: ±2mm ✓
  □ 垂直度: ±2mm ✓
  □ 間距: 符合規範

二、固定檢查
  □ 地腳螺栓: 已鎖緊
  □ 機櫃連結: 已固定
  □ 防震墊片: 已安裝

三、內部檢查
  □ 設備安裝位置正確
  □ 走線整齊
  □ 接地良好
  □ 無雜物

四、外觀檢查
  □ 表面無刮傷
  □ 門鎖正常
  □ 標示清晰

五、功能測試
  □ 電源測試: 正常
  □ 接地測試: <1Ω
  □ 絕緣測試: >5MΩ

六、安全檢查
  □ 重心標示清楚
  □ 警告標籤完整
  □ 無尖銳邊緣

七、照片記錄
  - 整體照片 [4 張]
  - 內部配置 [3 張]
  - 測試數據 [2 張]

缺失項目 (如有):
  1. _______
  2. _______

驗收結論:
  ☑ 通過,可請款 30%
  ☐ 部分通過,限期改善
  ☐ 不通過,需返工

專案經理簽名: ___________
日期: 2024-03-20

註: 本驗收單視同專案經理承擔責任
```

### 範本 C: 配線施工驗收單

```
【配線施工驗收單】

Task: Task-035 SS-A01 配線施工

一、線路檢查
  迴路            起點    終點    線徑    結果
  ├─ AC-110V-1    RCP     FE01    2.0mm²  ✓
  ├─ DC-110V-1    DC      FE01    2.0mm²  ✓
  ├─ COM-1        RTU     FE01    0.75mm²  ✓
  └─ ...

二、標示檢查
  □ 線路兩端標示清晰
  □ 標示內容正確
  □ 標示材質耐久

三、固定檢查
  □ 配線整齊
  □ 固定牢靠
  □ 轉角圓滑

四、接線檢查
  □ 端子壓接牢固
  □ 極性正確
  □ 無裸露導線

五、測試記錄
  - 導通測試: ✓ 通過
  - 絕緣測試: ✓ >5MΩ
  - 接地測試: ✓ <1Ω

六、照片記錄
  [8 張照片]

驗收結論: ___________
```

### 範本管理機制

```
系統設定:

管理員可以:
  - 建立新範本
  - 修改現有範本
  - 設定範本適用條件
  - 預覽範本效果

範本欄位類型:
  - 文字輸入
  - 數字輸入
  - 勾選框
  - 下拉選單
  - 照片上傳
  - 檔案上傳
  - 簽名欄

範本版本控制:
  - 每次修改都保留歷史版本
  - 舊的 Tasks 使用舊版本
  - 新的 Tasks 使用新版本
```

---

## 5. 請款計算引擎 - 複雜的計價規則

### 基本計價模式

```
模式 A: 數量計價
  公式: 單價 × 數量 = 金額
  
  例如:
  Task: Frontend 機櫃安裝
  單價: 164,941 元/SET
  合約數量: 4 SET
  已完成: 3 SET
  進行中: 0.5 SET
  
  可請款 = (3 + 0.5) × 164,941 = 577,293 元

模式 B: 總價計價
  公式: 總價 × 完成百分比 = 金額
  
  例如:
  Task: 光纖佈建
  總價: 5,000,000 元
  完成進度: 65%
  
  可請款 = 5,000,000 × 65% = 3,250,000 元

模式 C: 工時計價
  公式: 人時單價 × 工時 = 金額
  
  例如:
  Task: 監工服務
  單價: 1,500 元/人時
  本月工時: 160 小時
  
  可請款 = 1,500 × 160 = 240,000 元
```

### 分階段請款規則

```
規則設定:

Task-020 的請款階段:
  階段 1: 材料進場
    ├─ 觸發條件: MaterialReceived Event
    ├─ 請款比例: 50%
    ├─ 需要文件: 材料進場單、照片
    └─ 計算: 總金額 × 50%
    
  階段 2: 安裝完成
    ├─ 觸發條件: InternalAcceptancePassed Event
    ├─ 請款比例: 30%
    ├─ 需要文件: 驗收單、照片
    └─ 計算: 總金額 × 30%
    
  階段 3: 業主驗收
    ├─ 觸發條件: ClientApproved Event
    ├─ 請款比例: 20%
    ├─ 需要文件: 業主驗收單
    └─ 計算: 總金額 × 20%

累計請款限制:
  - 不能超過 100%
  - 每次請款都記錄 Invoice Number
  - 追蹤實際收款狀態
```

### 複雜場景處理

#### 場景 1: 部分驗收的計價

```
Task-110: Frontend 機櫃 16 SET
單價: 164,941 元/SET
總金額: 2,639,056 元

分批驗收:
  第一批: 5 SET 驗收通過
    → 可請款 = 5 × 164,941 = 824,705 元
    
  第二批: 3 SET 驗收通過 (1 SET 退件)
    → 可請款 = 3 × 164,941 = 494,823 元
    
  第三批: 8 SET 驗收通過 (含前次退件)
    → 可請款 = 8 × 164,941 = 1,319,528 元

累計請款: 2,639,056 元 ✓
```

#### 場景 2: 進度型計價 + 預付款

```
Task-200: 光纖佈建 8500M
總金額: 5,911,217 元

特殊條款:
  預付款: 20% = 1,182,243 元 (簽約時)
  
進度請款:
  10% 完成: 5,911,217 × 10% - 預付 = 0 (已預付)
  30% 完成: 5,911,217 × 30% - 已請 = 591,122
  50% 完成: 5,911,217 × 50% - 已請 = 1,182,243
  100% 完成: 5,911,217 × 100% - 已請 = 2,955,609
  
規則:
  - 預付款抵扣前期進度款
  - 需扣除預付後才能再請款
```

#### 場景 3: 主包下包的差價管理

```
Task-070: 光纖熔接

主包視角 (宏林 vs ABB):
  合約金額: 500,000
  已請款: 250,000 (50%)
  待請款: 250,000 (50%)

下包視角 (下包商 C vs 宏林):
  合約金額: 300,000
  已請款: 150,000 (50%)
  待請款: 150,000 (50%)

差價管理:
  宏林利潤: 500,000 - 300,000 = 200,000
  利潤率: 40%
  
注意事項:
  - 主包收到款才付給下包
  - 如果業主不付,下包也收不到
  - 需追蹤兩條金流
```

### 請款狀態追蹤

```
Task-020 的請款記錄:

Invoice-001:
  ├─ 請款日期: 2024-03-12
  ├─ 請款金額: 200,000
  ├─ 發票號碼: AB12345678
  ├─ 依據: 材料進場驗收單
  ├─ 狀態: ✓ 已收款
  ├─ 收款日期: 2024-06-10 (90天後)
  └─ 實收金額: 200,000

Invoice-002:
  ├─ 請款日期: 2024-03-20
  ├─ 請款金額: 120,000
  ├─ 發票號碼: AB12345679
  ├─ 依據: 內部驗收單
  ├─ 狀態: 🟡 待收款
  ├─ 預計收款: 2024-06-18
  └─ 備註: 等待 ABB 付款

Invoice-003:
  ├─ 請款條件: 等待業主驗收
  ├─ 預估金額: 80,000
  ├─ 狀態: ⚪ 尚未請款
  └─ 預計請款: 待驗收通過後

財務總覽:
  合約總額: 400,000
  已請款: 320,000 (80%)
  已收款: 200,000 (50%)
  待收款: 120,000 (30%)
  未請款: 80,000 (20%)
```

### 計價引擎的自動化

```
系統自動觸發請款提醒:

當 Event 發生時:
  MaterialReceived → 檢查階段 1 條件
  InternalAcceptancePassed → 檢查階段2 條件
  ClientApproved → 檢查階段 3 條件

如果條件滿足:
  1. 計算可請款金額
  2. 產生請款通知
  3. 提醒專案經理核准
  4. 準備請款文件清單
  5. 記錄請款申請 Event

防呆機制:
  - 檢查累計請款不超過 100%
  - 檢查必要文件是否齊全
  - 檢查前一階段是否已請款
  - 檢查是否有未解決的缺失
```

---

## 6. 異常處理流程 - 驗收失敗、返工、變更

### 驗收失敗的標準流程

```
Step 1: 驗收不通過
  Event: InternalAcceptanceFailed
  記錄:
    - 驗收人: PM-王經理
    - 驗收日期: 2024-03-20
    - 不通過原因: [詳細描述]
    - 缺失照片: [附件]
    - 要求改善期限: 2024-03-22
    
Step 2: 系統自動動作
  - Task 狀態 → Rework Required
  - 通知執行方 (下包商或自有團隊)
  - 凍結請款 (不能請該階段的款)
  - 記錄到異常清單
  
Step 3: 建立返工 Task (可選)
  選項 A: 在原 Task 上標記返工
  選項 B: 建立新的 Rework Task
    → Task-020-RW: SS-A01 缺失改善
    → 關聯到原 Task-020
    → 指派給原執行方
    → 期限: 2024-03-22
    
Step 4: 返工完成
  - 執行方完成改善
  - 提交改善照片與說明
  - Event: ReworkCompleted
  
Step 5: 重新驗收
  - 專案經理重新檢查
  - 如果通過:
    → Event: InternalAcceptancePassed
    → Task 狀態 → 恢復正常流程
    → 可以請款
  - 如果仍不通過:
    → 重複 Step 1-5
    
Step 6: 記錄與分析
  - 返工次數: 1 次
  - 延誤天數: 2 天
  - 額外成本: (如有)
  - 責任歸屬: 施工方
```

### 業主驗收失敗的處理

```
更嚴重的情況:

Step 1: 業主不接受
  Event: ClientRejected
  影響:
    - 宏林已經內部驗收通過
    - 甚至可能已付款給下包商
    - 但業主不付款給宏林
    
Step 2: 責任判定
  系統追溯:
    - 誰內部驗收的? PM-王經理
    - 驗收時間? 2024-03-20
    - 驗收依據? [查看驗收單]
    
  分析原因:
    □ 驗收標準不一致
    □ 執行品質確實有問題
    □ 業主臨時提高標準
    □ 溝通不足
    
Step 3: 處理策略
  策略 A: 宏林自行處理
    - 不找下包商 (自己吸收)
    - 派自有人力改善
    - 記錄為管理成本
    
  策略 B: 要求下包商改善
    - 如果是下包責任
    - 要求免費返工
    - 可能影響未來合作
    
Step 4: 重新驗收
  - 改善完成
  - 宏林內部驗收
  - 再次提交業主驗收
  - 直到通過為止
  
Step 5: 檢討改善
  - 專案會議討論
  - 更新驗收標準
  - 加強品質管理
  - 預防再次發生
```

### 合約變更的流程

```
輕微變更 (不改合約):

例如: 機櫃顏色從灰色改成白色

  Step 1: 變更申請
    - 提出人: 現場主管
    - 變更內容: 顏色變更
    - 變更原因: 業主要求
    - 預估影響: 無成本影響
    
  Step 2: 內部評估
    - 專案經理審核
    - 判斷: 不影響功能,不加價
    - 決定: 核准
    
  Step 3: 執行變更
    - 更新 Task 說明
    - 通知執行方
    - Event: TaskModified
    
  Step 4: 記錄歸檔
    - 變更記錄
    - 新舊對照
    - 不影響請款

重大變更 (需改合約):

例如: 增加 5 SET 機櫃

  Step 1: 變更申請
    - 提出人: 業主 (ABB)
    - 變更內容: 增加 5 SET
    - 預估金額: + 824,705 元
    
  Step 2: 報價
    - 宏林重新報價
    - 考慮成本變動
    - 提交報價單
    
  Step 3: 合約修訂
    - 雙方協商
    - 簽署變更單
    - 更新合約金額
    
  Step 4: 系統更新
    - 建立新 Tasks
    - 更新總金額
    - Event: ContractAmended
    
  Step 5: 執行新工作
    - 按新 Tasks 執行
    - 獨立請款追蹤
```

### 異常清單管理

```
系統維護一個異常清單:

異常 #001:
  ├─ Task: Task-035
  ├─ 類型: 驗收失敗
  ├─ 發現日期: 2024-03-20
  ├─ 原因: 線路標示不清
  ├─ 責任方: 下包商 A
  ├─ 狀態: 🟡 改善中
  ├─ 期限: 2024-03-22
  └─ 影響: 進度延誤 2 天

異常 #002:
  ├─ Task: Task-055
  ├─ 類型: 材料延遲
  ├─ 發現日期: 2024-03-18
  ├─ 原因: 供應商缺貨
  ├─ 責任方: 外部供應商
  ├─ 狀態: 🔴 阻擋中
  ├─ 預計解決: 2024-03-25
  └─ 影響: Task-055~058 無法執行

異常 #003:
  ├─ Task: Task-070
  ├─ 類型: 設計變更
  ├─ 發現日期: 2024-03-15
  ├─ 原因: 業主臨時需求
  ├─ 狀態: 🟢 已解決
  ├─ 解決方式: 合約變更
  └─ 影響: 增加工作量,已簽變更單

異常統計:
  - 總異常數: 15
  - 已解決: 8
  - 處理中: 5
  - 待處理: 2
```

### 預防機制

```
系統內建預警:

預警 1: 驗收標準不明確
  - 檢測: Task 無驗收範本
  - 提醒: 建議補充驗收標準
  - 時機: Task 建立時

預警 2: 材料未到就開工
  - 檢測: Task 開始但材料未驗收
  - 提醒: 提醒專案經理確認
  - 時機: Task 狀態變更時

預警 3: 長時間無進度更新
  - 檢測: Task 超過 3 天無更新
  - 提醒: 提醒執行方回報進度
  - 時機: 每日自動檢查

預警 4: 即將逾期
  - 檢測: 距離期限 < 3 天
  - 提醒: 提醒所有相關人員
  - 時機: 每日自動檢查

預警 5: 驗收失敗頻繁
  - 檢測: 同一執行方連續 3 次驗收失敗
  - 提醒: 提醒專案經理檢討
  - 時機: 驗收失敗時
```

---

## 總結

這六大功能模塊構成了完整的 Task 執行與管理閉環:

1. **日誌** - 記錄歷史,產生報告
2. **里程碑** - 追蹤進度,預警風險
3. **協作者介面** - 分工協作,權限隔離
4. **驗收範本** - 標準化作業,確保品質
5. **請款引擎** - 自動計算,追蹤金流
6. **異常處理** - 應變機制,持續改善

這些功能都建立在你的 **Event-Sourced** 架構上,所有變更都有完整記錄,可以追溯、分析、改善。
# 很好!讓我做個總結

## Task 系統的核心特徵

你們的 Task 系統是一個 **「重量級的工作執行與計價單元」**,具備:

### 1. 多層級協作架構
- 主包 → 下包 → 再下包 (無限層級)
- 分支隔離,各看各的
- 權限與可見性分層管理

### 2. 完整的驗收鏈
- 執行方自檢 (提交)
- 專案經理驗收 (決策 + 承擔責任)
- 業主核准 (最終決定權)
- 支援分批驗收

### 3. 金流綁定機制
- 數量 × 單價 = 計價基礎
- 驗收數量 = 請款依據
- 主包下包的成本差價管理
- 分階段請款追蹤

### 4. 責任追溯能力
- 所有決策有記錄
- 所有變更有 Event
- 出問題能找到人

### 5. 彈性執行特性
- 計畫會變 (走一步看一步)
- 驗收可退 (不通過就返工)
- 現場主管有自主權

## 與你的 Causality-Driven Event-Sourced Process System 的關係

```
Process (流程定義)
  ↓ 定義標準作業程序
Work Package (工作包)
  ↓ 拆解具體工作
Task (任務)
  ↓ 執行、驗收、計價
Events (事件記錄)
  ↓ 完整追溯歷史
Milestone (里程碑)
  ↑ 匯總進度與責任
```

**Task 是連接「計畫」與「現實」的關鍵橋樑**:
- 往上對應合約承諾
- 往下管理現場執行
- 橫向連結協作者
- 縱向追溯責任

## 下一步可以討論的

當你開始實作時,可能會遇到:

1. **日誌功能** - 如何自動彙整 Task 的 Events 產生日報
2. **里程碑機制** - 如何從 Tasks 推算 Milestone 達成率
3. **協作者介面** - 下包商看到的畫面長什麼樣
4. **驗收單範本** - 不同類型的 Task 需要哪些驗收欄位
5. **請款計算引擎** - 如何處理複雜的計價規則
6. **異常處理流程** - 驗收失敗、返工、變更的標準流程

不過這些等你實作時再討論就好。

**現在你對 Task 在整個系統中的定位應該很清楚了!** 🎯

有需要再隨時討論!
# 理解了!這是一個多層級的協作與驗收系統

## 1. 協作者的分支架構

### 分支派工的概念

```
主合約 (ABB → 宏林)
  合約金額: 73,840,106
  所有工項與 Tasks
  
宏林視角 (主包):
├─ 自己執行的 Tasks
│   └─ Task-001, Task-005, Task-010...
│
├─ 分支 A (下包商 A - 機櫃安裝)
│   ├─ 分支合約金額: 5,000,000
│   ├─ 可見 Tasks: Task-020~Task-050
│   └─ 不可見其他分支的 Tasks
│
├─ 分支 B (下包商 B - 光纖施工)
│   ├─ 分支合約金額: 3,000,000
│   ├─ 可見 Tasks: Task-060~Task-080
│   │
│   └─ 分支 B-1 (下包商 B 再分包給 B-1)
│       ├─ 分支合約金額: 1,000,000
│       ├─ 可見 Tasks: Task-070~Task-075
│       └─ 更下層的分支...
│
└─ 分支 C (臨時工團隊)
    ├─ 分支合約金額: 500,000
    └─ 可見 Tasks: Task-090~Task-095
```

### 分支的權限管理

```
分支 A (下包商 A) 能做什麼:

✓ 可以看到:
  - 自己分支底下的 Tasks
  - 自己分支的進度統計
  - 自己分支的請款記錄

✓ 可以操作:
  - 更新 Task 執行狀態
  - 上傳施工照片
  - 提交自檢表
  - 提交部分驗收文件 (例如材料進場單)

✗ 不能做:
  - 看到其他分支的資訊
  - 看到主合約的總金額
  - 核准驗收 (只能提交等待驗收)
  - 直接請款 (需要主包核准)
```

## 2. Task 的數量與金額計算

### 計價方式

```
Task-020: SS-A 區機櫃安裝

計價基礎:
  方式: 數量計價
  單位: SET (套)
  單價: 164,941 元/SET
  數量: 4 SET
  小計: 659,764 元

執行進度:
  已完成: 3 SET
  進行中: 1 SET (50%)
  未開始: 0 SET
  
可請款金額計算:
  完成數量: 3 SET = 494,823 元
  進行中: 0.5 SET = 82,470 元
  可請款總計: 577,293 元
  
實際請款:
  第一次: 材料進場 4 SET × 50% = 329,882 元
  第二次: 完工 3.5 SET × 30% = 173,225 元
  已請款: 503,107 元
  可再請: 74,186 元 (等剩下 0.5 SET 完工)
```

### 分批驗收的金額處理

```
Task-110: Frontend 機櫃 16 SET

分批驗收記錄:
├─ 第一批驗收 (3/15)
│   ├─ 驗收數量: 5 SET
│   ├─ 驗收結果: 全部通過
│   ├─ 可請金額: 5/16 = 31.25%
│   └─ 累計驗收: 5 SET
│
├─ 第二批驗收 (3/22)
│   ├─ 驗收數量: 4 SET  
│   ├─ 驗收結果: 3 通過, 1 退件
│   ├─ 可請金額: 3/16 = 18.75%
│   └─ 累計驗收: 8 SET
│
└─ 第三批驗收 (3/29)
    ├─ 驗收數量: 8 SET + 1 補件
    ├─ 驗收結果: 全部通過
    ├─ 可請金額: 8/16 = 50%
    └─ 累計驗收: 16 SET ✓ 完成

總驗收進度: 16/16 = 100%
可請款進度: 100%
```

## 3. 驗收與請款的決策鏈

### 三層決策結構

```
層級 1: 執行方自檢
  ├─ 執行者: 施工團隊/下包商
  ├─ 動作: 完成工作後提交自檢表
  ├─ 權限: 只能"提交",不能"核准"
  └─ 系統記錄: TaskSelfInspectionSubmitted

層級 2: 專案經理驗收 (宏林內部)
  ├─ 驗收者: 宏林專案經理
  ├─ 動作: 
  │   - 審查執行成果
  │   - 審查自檢表
  │   - 現場確認 (如需要)
  │   - 決定: 通過 or 退件
  ├─ 責任: 
  │   - 按下「驗收通過」= 承擔責任
  │   - 如果後續業主不驗收,專案經理要負責
  └─ 系統記錄: TaskInternalAcceptancePassed/Failed

層級 3: 業主決定請款 (ABB)
  ├─ 決策者: ABB (William)
  ├─ 動作:
  │   - 審查宏林提交的驗收文件
  │   - 現場抽查 (如需要)
  │   - 決定: 核准請款 or 暫緩 or 拒絕
  ├─ 權限: 最終決定權
  └─ 系統記錄: PaymentApproved/Rejected
```

### 驗收與請款的流程

```
Task-050: SS-B02 配線完成

Step 1: 下包商完成並自檢
  → Event: TaskCompleted (by 下包商 B)
  → Event: TaskSelfInspectionSubmitted
  → 狀態: Pending Internal Acceptance

Step 2: 專案經理驗收
  → 專案經理現場查看
  → 決定: 通過 ✓
  → Event: TaskInternalAcceptancePassed (by PM-王經理)
  → 狀態: Pending Payment Request
  → 宏林內部可以付款給下包商 B

Step 3: 向業主請款
  → 專案經理提交請款申請
  → Event: PaymentRequested
  → 附件: 驗收照片、自檢表、簽核單
  → 狀態: Awaiting Client Approval

Step 4: 業主決定
  → 業主審查
  → 決定: 核准 ✓
  → Event: PaymentApproved (by ABB-William)
  → 狀態: Approved for Payment
  → 財務開立發票

Step 5: 收款
  → 90 天後收到款項
  → Event: PaymentReceived
  → 狀態: Paid & Closed
```

### 部分驗收,部分請款

```
Task-110: Frontend 機櫃 16 SET

驗收不是「全有全無」,而是「驗幾個算幾個」:

第一批 5 SET 驗收通過:
  → Event: TaskPartialAcceptance (5/16)
  → 可請款: 5/16 × 總金額
  → 狀態: Partially Accepted

第二批 3 SET 驗收通過 (1 SET 退件):
  → Event: TaskPartialAcceptance (3/16)
  → 累計: 8/16
  → 可請款: 8/16 × 總金額
  → 狀態: Partially Accepted

最後一批 8 SET 驗收通過:
  → Event: TaskFinalAcceptance (8/16)
  → 累計: 16/16 ✓ 完成
  → 可請款: 16/16 × 總金額
  → 狀態: Fully Accepted & Closed
```

## 4. 專案經理的責任機制

### 為什麼「專案經理敢按就算驗收」?

```
專案經理的決策 = 承擔風險

場景 A: 專案經理驗收通過
  → 向業主請款
  → 業主也驗收通過 ✓
  → 收到款項
  → 皆大歡喜

場景 B: 專案經理驗收通過,但業主不通過
  → 業主: "這個不符合規格"
  → 業主拒絕付款 ✗
  → 需要重做/改善
  → 額外成本由宏林承擔
  → 專案經理要負責任

場景 C: 專案經理不敢驗收
  → 要求下包商修改
  → 下包商抱怨: "明明就符合規格"
  → 延誤工期
  → 專案經理也要負責任
```

### 系統如何記錄責任

```
Event: TaskInternalAcceptancePassed
  eventId: "evt-12345"
  taskId: "task-050"
  timestamp: "2024-03-20 15:30:00"
  approver: "PM-王經理"
  decision: "Approved"
  note: "現場確認配線符合規格,可向業主請款"
  evidence: ["photo-001.jpg", "photo-002.jpg"]
  signature: "數位簽章"
  
如果後續出問題:
  → 可以追溯到是「PM-王經理」在「3/20 15:30」核准的
  → 可以看到當時的「照片證據」
  → 可以看到王經理的「批註說明」
  → 責任歸屬清楚
```

## 5. 分支系統的請款連動

### 主包與下包的請款關係

```
Task-020 的金流:

宏林 (主包) 視角:
  ├─ 對上 (向 ABB 請款):
  │   ├─ Task 驗收通過
  │   ├─ 向 ABB 請款: 500,000
  │   ├─ 90 天後收款
  │   └─ 狀態: 已收款
  │
  └─ 對下 (付款給下包):
      ├─ 下包商 A 完成工作
      ├─ 專案經理驗收通過
      ├─ 付款給下包商 A: 400,000
      ├─ 宏林賺取差價: 100,000
      └─ 狀態: 已付款

下包商 A 視角:
  ├─ 完成 Task-020
  ├─ 提交自檢與驗收文件
  ├─ 等待宏林專案經理驗收
  ├─ 驗收通過
  ├─ 向宏林請款: 400,000
  ├─ 收款 (依合約條件)
  └─ 狀態: 已收款
```

### 分支的獨立請款管理

```
分支 A (下包商 A) 的請款介面:

我的 Tasks:
├─ Task-020: SS-A01 機櫃安裝
│   ├─ 狀態: 已驗收
│   ├─ 分支合約金額: 400,000
│   ├─ 已請款: 200,000 (50%)
│   ├─ 可再請款: 120,000 (30%)
│   └─ 待驗收才能請: 80,000 (20%)
│
├─ Task-025: SS-A02 機櫃安裝  
│   ├─ 狀態: 進行中
│   ├─ 分支合約金額: 400,000
│   ├─ 已請款: 200,000 (材料到場)
│   └─ 待完工驗收
│
└─ 我的總計:
    ├─ 分支總金額: 5,000,000
    ├─ 已請款: 2,500,000
    ├─ 已收款: 2,000,000  
    ├─ 待收款: 500,000
    └─ 未請款: 2,500,000
```

## 6. Task 的狀態機

### 完整的狀態流轉

```
Created (建立)
  ↓
Assigned (已指派)
  ↓ 
Materials Received (材料到場) ← 可部分請款
  ↓
In Progress (執行中)
  ↓
Self Inspection Submitted (自檢提交)
  ↓
┌─→ Internal Acceptance Failed (內部驗收不通過)
│     ↓
│   Rework Required (要求返工)
│     ↓
│   In Progress (重新執行)
│     └─→ 回到上方流程
│
└─→ Internal Acceptance Passed (內部驗收通過)
      ↓
    Payment Requested (請款申請)
      ↓
    ┌─→ Client Rejected (業主拒絕)
    │     ↓
    │   Rework Required
    │     └─→ 回到上方流程
    │
    └─→ Client Approved (業主核准)
          ↓
        Invoice Issued (發票開立)
          ↓
        Payment Received (收款)
          ↓
        Closed (結案)
```

### 部分驗收的狀態

```
如果是分批驗收:

Created
  ↓
... (前面流程相同)
  ↓
Partially Accepted (部分驗收)
  ├─ 已驗收: 8/16
  ├─ 未驗收: 8/16
  └─ 狀態: 持續驗收中
  ↓
Partially Accepted (部分驗收)
  ├─ 已驗收: 13/16
  ├─ 未驗收: 3/16
  └─ 狀態: 接近完成
  ↓
Fully Accepted (全部驗收)
  ├─ 已驗收: 16/16 ✓
  └─ 狀態: 可結案
  ↓
Closed
```

## 7. 實務場景模擬

### 場景: 多層分支的協作

```
2024-03-10: Task-070 建立

Task-070: 跨棟光纖佈建 SM-24C 2000M
  合約金額: 2,500,000
  指派: 分支 B (下包商 B - 光纖專業)
  
下包商 B 決定再分包:
  → 建立 分支 B-1 (專業熔接團隊)
  → 分配金額: 1,500,000
  → 分配 Tasks: Task-070-A ~ Task-070-E

系統中的階層:
宏林 (主包)
  └─ Task-070 (2,500,000)
      ├─ 分支 B 可見
      ├─ 分支 B 自己保留: 1,000,000
      └─ 分支 B-1 (1,500,000)
          ├─ Task-070-A: 路線 A 施工
          ├─ Task-070-B: 路線 B 施工
          └─ ...
```

### 場景: 驗收失敗的金流影響

```
Task-040: SS-A05 配線 (下包商 A 執行)

3/15: 下包商 A 完成,提交自檢
  → Event: TaskSelfInspectionSubmitted

3/16: 專案經理驗收
  → 決定: 通過 ✓
  → Event: TaskInternalAcceptancePassed
  → 宏林付款給下包商 A: 300,000

3/20: 宏林向業主請款
  → Event: PaymentRequested

3/25: 業主現場驗收
  → 發現: 線路標示不符規範
  → 決定: 拒絕 ✗
  → Event: ClientRejected
  → 要求: 重新標示

結果:
  - 宏林已經付給下包商 A
  - 但業主不付款給宏林
  - 宏林自己吸收損失
  - 專案經理被檢討: 為什麼沒發現?

3/26: 重新標示
  → 宏林自己派人處理 (不能再請下包商)
  → 額外成本: 50,000

4/01: 業主重新驗收
  → 決定: 通過 ✓
  → 宏林才能收到款

這個案例的教訓:
  → 專案經理要更謹慎
  → 驗收標準要對齊業主
  → 下包商管理要加強
```

## 8. 核心設計原則

基於你的說明,Task 系統的設計原則是:

### 1. 分層可見性
- 每個分支只看得到自己的 Tasks
- 主包看得到全部
- 權限向下遞減

### 2. 責任可追溯
- 每個決策都有記錄
- 誰核准的?什麼時候?為什麼?
- 出問題能找到負責人

### 3. 金流可計算
- 數量 × 單價 = 金額
- 分批驗收 = 分批請款
- 主包與下包的差價管理

### 4. 驗收分階段
- 自檢 (執行方)
- 內部驗收 (專案經理)
- 業主核准 (最終決定)

### 5. 狀態可回退
- 驗收不通過 → 返工
- 業主拒絕 → 重做
- 所有變更都記錄

這樣的理解正確嗎?還有什麼我沒想到的場景?
# 理解了!這樣設計就清楚了

## 1. 你們的實際狀況

### 規劃的真實面貌
```
合約簽訂: "我們說好要這樣做"
開工後: "現場狀況不同,只能走一步看一步"
結果: 計畫永遠趕不上變化
```

這是傳統工程的常態,所以系統設計不能太僵化。

### 現場主管的角色
- **有決策權** (不用事事請示)
- **有回報義務** (每天匯報進度)
- **遇到大事才上報** (嚴重到要改合約才往上呈)

### 每日進度回報的內容
```
今天的日報:
- 出工人數: 12人
- 完成工作: SS-A01機櫃定位、SS-A02配線50%
- 遭遇問題: 地板不平,需要墊高
- 預計完成: SS-A區預計還需3天
```

## 2. 基於這個理解的 Task 設計

### Task 應該很「輕」

**不需要**:
- 複雜的工作流程引擎
- 嚴格的前後依賴關係
- 精確的時間估算

**需要**:
- 快速建立/修改/取消
- 清楚記錄「誰做了什麼」
- 方便匯總「進度到哪裡」

### Task 的實際使用場景

#### 場景 A: 早上分配工作
```
工地主管早上7點到現場:

看了看今天的狀況:
- 張三組 → 繼續昨天的 SS-A01 配線
- 李四組 → 開始 SS-A02 機櫃安裝
- 王五組 → 材料整理與搬運

在系統快速建立今天的 Tasks:
✓ Task: SS-A01 配線完成 [張三組 3人]
✓ Task: SS-A02 機櫃定位 [李四組 4人]  
✓ Task: 材料整理 [王五組 2人]
```

#### 場景 B: 下午發現問題
```
下午2點,張三發現:
"SS-A01 的 Relay 規格跟現場不符"

張三在系統記錄:
- 更新 Task 狀態 → Blocked
- 註記問題 → "Relay 規格不符,等待確認"
- 拍照上傳

工地主管看到:
- 判斷不嚴重 → 請張三改做其他工作
- 建立新 Task: 確認 Relay 規格

如果嚴重:
- 回報給專案經理
- 專案經理判斷是否需要變更合約
```

#### 場景 C: 晚上寫日報
```
工地主管晚上5點:

系統自動彙整今天的 Tasks:
- 完成: 2項
- 進行中: 1項  
- 阻擋: 1項
- 總人工: 9人 × 8小時 = 72人時

主管補充說明:
"今天完成 SS-A01 配線,SS-A02 因吊車延誤,
預計明天中午才能定位。整體進度延後半天。"

→ 產生每日工程日誌
→ 回報給客戶/公司
```

## 3. Task 與其他概念的關係

### Task vs Contract Item (合約項次)
```
Contract Item: 項次 110 - Frontend機櫃 16 SET
                (這是「承諾要交付的」)
                ↓
         產生多個實際工作
                ↓
Work: SS-A 區 Frontend 機櫃安裝 (4 SET)
      SS-B 區 Frontend 機櫃安裝 (6 SET)
      SS-C 區 Frontend 機櫃安裝 (6 SET)
      (這是「規劃怎麼做的」)
                ↓
         拆解成每日 Tasks
                ↓
Task: 3/15 SS-A01 機櫃定位
Task: 3/15 SS-A01 內部組裝
Task: 3/16 SS-A01 配線
Task: 3/16 SS-A02 機櫃定位
...
(這是「今天做什麼的」)
```

### Task vs Milestone (里程碑)
```
Milestone: SS-A 區完工驗收
            ↓
        檢查依據
            ↓
需要完成的 Tasks:
- SS-A01~A04 所有機櫃安裝
- SS-A 所有配線
- SS-A 測試驗收
            ↓
     當全部完成時
            ↓
Milestone 達成 → 產生 Event
```

**Milestone 的責任追溯**:
```
如果 Milestone 延誤:
- 查看該 Milestone 底下哪些 Tasks 延誤
- 查看這些 Tasks 的負責人
- 查看 Tasks 的 Blocked 原因
→ 就知道是誰的責任,還是外部因素
```

## 4. 每日日誌功能的設計重點

### 日誌應該「自動產生為主,手動補充為輔」

```
系統自動記錄:
├─ 今日 Tasks
│   ├─ 建立了哪些 Task
│   ├─ 完成了哪些 Task
│   ├─ 阻擋了哪些 Task
│   └─ 各 Task 的負責人與人數
├─ 今日 Events
│   ├─ 材料進場
│   ├─ 設備檢驗
│   └─ 問題發生
└─ 今日照片/附件

主管手動補充:
├─ 整體進度評估
├─ 重要決策說明
├─ 明天工作規劃
└─ 需要協調事項
```

### 日誌的多重用途

**對內管理**:
- 工地主管看昨天做了什麼
- 專案經理看整體進度
- 老闆看各工地狀況

**對外回報**:
- 給客戶的每日進度報告
- 給監造單位的施工記錄
- 未來如果有爭議的證據

**結案追溯**:
- 這個專案實際花了多少人工?
- 哪些環節最容易出問題?
- 下次報價可以更準確

## 5. 跟你的 Event-Sourced 系統整合

### Task 的生命週期就是一連串 Events

```
TaskCreated
  → 建立 Task
  → 記錄: 誰建立、為什麼建立、預計誰做

TaskAssigned  
  → 指派給某人/某組
  → 記錄: 指派時間、人數

TaskStarted
  → 開始執行
  → 記錄: 實際開始時間

TaskProgressed
  → 進度更新 (可選)
  → 記錄: 完成百分比、遭遇問題

TaskBlocked
  → 遇到阻礙
  → 記錄: 阻礙原因、照片、預計何時解決

TaskResumed
  → 恢復執行
  → 記錄: 如何解決的

TaskCompleted
  → 完成
  → 記錄: 完成時間、驗收照片、實際人工

TaskCancelled
  → 取消 (計畫改變)
  → 記錄: 取消原因
```

### Process 觸發 Task 產生

```
當某個 Milestone 的 Event 發生時:
→ Process 判斷下一步該做什麼
→ 自動建議產生相關 Tasks

例如:
Event: SS-A01 機櫃定位完成
  ↓
Process 判斷: 接下來要配線
  ↓
系統提示: "是否建立 SS-A01 配線 Task?"
  ↓
主管確認: 是 (或修改後確認)
  ↓
產生 TaskCreated Event
```

但不強制,主管也可以手動建立完全不同的 Task

## 6. 實務上的細節問題

### Task 的粒度該多細?

**建議原則**:
- 一個 Task = 一組人 × 半天~2天的工作量
- 太細(例如「鎖一顆螺絲」) → 管理成本太高
- 太粗(例如「完成整個 SS-A 區」) → 無法追蹤進度

### 如果計畫改變怎麼辦?

**不用怕改,改了就記錄下來**:
```
原本計畫:
Task-001: SS-A01 配線 [3/15]
Task-002: SS-A02 配線 [3/16]

現場發現 SS-A01 有問題:
TaskCancelled: Task-001 (原因: Relay 規格不符)
TaskCreated: Task-003 確認 Relay 規格 [3/15]
TaskCreated: Task-004 SS-A02 配線 [3/15] (提前)
TaskCreated: Task-005 SS-A01 配線 [3/17] (延後)
```

所有改變都有 Event 記錄,未來可以回溯「為什麼改」

### 人員調動怎麼處理?

```
早上分配:
Task-001: SS-A01 配線 [張三組 3人]

下午張三組有人請假:
TaskUpdated: Task-001 
  → 人數改為 2人
  → 註記: 王五請假

如果人力不足:
TaskReassigned: Task-001
  → 從張三組 改派給 李四組
  → 註記: 張三組人力不足
```

## 7. 我的總結建議

基於你們的實際狀況,Task 系統應該:

### 設計理念
1. **輕量彈性** - 不是嚴格的工作流程,是靈活的工作記錄
2. **現場優先** - 相信現場主管的判斷,系統只是輔助
3. **自動為主** - 能自動記錄的就不要手動,減少負擔
4. **事後追溯** - 透過 Events 完整保留歷史,未來可分析

### 實作重點
- Task 是「短期的、可變的、可拋棄的」
- Milestone 是「長期的、穩定的、可追溯的」
- 日誌是「自動彙整、手動補充」
- Event 是「完整記錄、永久保存」

### 給使用者的體驗
- **工地主管**: 早上5分鐘建立今日 Tasks,晚上5分鐘寫日報
- **專案經理**: 隨時看到各工地進度,發現異常才介入
- **老闆**: 看到整體狀況,不用管細節

這樣的理解對嗎?還是有哪些地方需要調整?
# 從這份 SCADA 工程合約看 Task 設計

看完這份合約,我有了更清晰的理解。這是一個很典型的傳統產業工程專案特徵:

## 1. 合約結構的層次性

```
合約總價: 73,840,106 TWD
  ├─ 工項 (一): SCADA站內工程
  │   ├─ 項次 10: 既設161kv RTU (618,530)
  │   ├─ 項次 20: 既設EH盤22.8KV (134,015)
  │   ├─ 項次 30: 新設EH盤22.8KV (134,015)
  │   └─ ...更多細項
  ├─ 工項 (壹): 傳統配電盤搬運定位工程
  ├─ 工項 (貳): 配電盤盤間連結
  └─ ...等等
```

每個項次下還有更細的實際作業內容

## 2. 現場不確定性的本質

你提到「一開始不會知道現場空間」,這很關鍵。這代表:

### 計畫階段的抽象性
- 合約簽訂時只知道「要做什麼」(What)
- 不知道「怎麼做」(How) 的細節
- 不知道「在哪裡做」(Where) 的具體位置

### 執行階段的具象化
- 到現場後才知道實際配置
- 可能發現「喔,原來這個位置這麼窄」
- 可能發現「原來隔壁還有其他廠商在施工」
- 可能發現「原來這個設備已經老舊需要額外處理」

## 3. 對 Task 設計的啟示

基於這份合約,我認為你的 Task 系統應該有這樣的特性:

### 三層架構

**Layer 1: Contract Level (合約層)**
- 對應合約的工項和項次
- 這層是「承諾要交付什麼」
- 金額、交期都在這層定義
- 這層幾乎不會變動(除非正式變更設計)

**Layer 2: Work Package Level (工作包層)**
- 對應實際要執行的工作包
- 例如「項次 10」可能拆成:
  - 現場勘查與測量
  - 材料備料與檢驗
  - 機櫃搬運與定位
  - FrontEnd 配線
  - FO box 安裝
  - Relay 配置
  - 測試與驗收
- 這層是「規劃怎麼做」
- 可能在開工前才確定,也可能邊做邊調整

**Layer 3: Task Level (任務層)**
- 對應現場實際的待辦事項
- 例如「今天要在 SS-A01 安裝 Frontend 機櫃」
- 這層是「今天誰做什麼」
- 完全動態產生,每天都不同

### Task 的動態生成機制

我認為你的系統需要這樣的彈性:

**階段 1: 合約簽訂**
```
系統狀態:
- 有 Contract Items (項次清單)
- 沒有 Work Packages
- 沒有 Tasks
```

**階段 2: 施工規劃**
```
工地經理根據:
- 現場勘查結果
- 施工順序邏輯
- 人力資源配置

手動或半自動產生 Work Packages:
- WP-001: SS-A 區域機櫃安裝
- WP-002: SS-B 區域配線施工
- WP-003: 跨棟光纖佈建
...

每個 WP 關聯到一個或多個 Contract Items
```

**階段 3: 每日執行**
```
根據 Work Package 的進度和現場狀況,
系統或現場主管產生當日 Tasks:

2026-03-15:
- Task-001: [張三] SS-A01 機櫃定位
- Task-002: [李四] SS-A01 配線準備
- Task-003: [王五] 材料搬運至 SS-A

2026-03-16:
- Task-004: [張三] SS-A01 FO box 安裝
- Task-005: [李四] SS-A01 Relay 配置
...
```

## 4. 進度追蹤的關鍵點

從這份合約看,管理層關心的是:

### 對客戶(ABB)的承諾
- 「項次 10 做到哪裡了?」
- 「6/19 交期趕得上嗎?」
- 「如果延誤,罰款是多少?」(千分之五/天)

### 對內部的掌控
- 「SS-A 區域進度多少?」
- 「張三這週做了哪些工作?」
- 「這個月請款能請到多少?」

### 對異常的應變
- 「發現既設設備有問題怎麼辦?」
- 「業主臨時要求調整順序怎麼辦?」
- 「人力不足怎麼調配?」

## 5. 我的建議架構

### Process 定義的是「標準流程」
```
標準 SCADA 安裝流程:
1. 現場勘查
2. 材料進場檢驗
3. 機櫃搬運定位
4. 內部設備組裝
5. 配線施工
6. 測試驗收
```

### Work Package 是「具體實例」
```
WP-SS-A01: SS-A區01號機櫃安裝
- 套用標準流程
- 但根據現場狀況調整:
  - 因為空間狹窄,需要額外吊裝設備
  - 因為電源未就緒,暫時跳過測試階段
```

### Task 是「可執行動作」
```
Task-12345:
- 標題: SS-A01 機櫃定位
- 所屬 WP: WP-SS-A01
- 對應合約項次: 項次 110 (Frontend機櫃)
- 指派給: 張三
- 狀態: In Progress
- 現場照片: [附件]
- 異常記錄: 地板不平,需要墊片
```

## 6. 關鍵問題

基於這份合約,我想確認幾件事:

### 關於規劃彈性
你們的實務上:
- **Work Package 是在開工前就全部規劃好?** 還是邊做邊規劃?
- **現場主管有多少自主權調整?** 還是要回報總部批准?
- **如果發現問題需要變更,流程是什麼?**

### 關於進度回報
- **客戶(ABB)要求什麼頻率回報?** 每週?每月?
- **回報的粒度是什麼?** 報到工項?還是要細到每個機櫃?
- **請款是按什麼方式?** 實際完工量?還是時間進度?

### 關於責任追溯
合約上有很多罰款條款:
- **如果延誤,需要追究到「誰」的責任嗎?**
- **還是只要知道「哪個環節」卡住就好?**
- **驗收文件要詳細到什麼程度?**

這些會影響 Task 系統要記錄多少細節。

## 7. 我的觀察

這種合約最大的特色是:

**「上層很清楚,下層很模糊」**

- 合約金額、交期、罰則 → 非常明確
- 工項、設備規格 → 相對明確
- 但實際「怎麼做、誰來做、什麼時候做」→ 完全不確定

所以你的 Task 系統需要:
- **往上能對應合約項次**(追蹤承諾)
- **往下能靈活調整執行細節**(適應現場)
- **中間有彈性的協調機制**(Work Package)

這樣設計合理嗎?還是你們有其他考量?
# 原來如此!Task 其實蠻重的

## 1. 重新理解 Task 的重量級特性

### Task 不只是「待辦事項」,而是「工作合約的最小執行單位」

```
Task 的完整生命週期:

建立 Task
  ↓
指派協作者 (承包商/下包/人員)
  ↓
執行工作
  ↓
完成自檢
  ↓
質檢 (QC)
  ↓
驗收 (業主/監造)
  ↓
請款 (可能多次,按百分比)
  ↓
收款
```

這跟我之前理解的「輕量 Task」完全不同!

## 2. Task 與金流的綁定關係

### 為什麼 Task 會這麼重?

因為 **Task 是請款的依據**:

```
合約層:
項次 110: Frontend機櫃 16 SET = 2,639,062 元

Work 層:
SS-A 區 Frontend 機櫃 4 SET = 659,765 元

Task 層:
Task-001: SS-A01 機櫃安裝 
  ├─ 預算: 164,941 元
  ├─ 指派: 宏林工程 (下包商)
  ├─ 協作者: 張三、李四
  ├─ 執行狀態: 已完成
  ├─ 質檢: 通過 (QC-王工 3/20)
  ├─ 驗收: 通過 (ABB-William 3/22)
  └─ 請款記錄:
      ├─ 第一次: 50% = 82,470 元 (材料進場)
      ├─ 第二次: 30% = 49,482 元 (安裝完成)
      └─ 第三次: 20% = 32,988 元 (驗收完成)
```

### 協作者的複雜性

從這份合約看,宏林工程本身就是 ABB 的承包商,但宏林可能還有下包:

```
ABB (業主)
  ↓ 合約 73,840,106
宏林工程 (總包)
  ↓ 
  ├─ 自有施工團隊 (直接雇用)
  ├─ 下包商 A (機櫃安裝專業)
  ├─ 下包商 B (配線專業)
  └─ 臨時工 (支援性工作)
```

每個 Task 可能指派給不同的協作者,而且:
- **不同協作者的成本不同**
- **不同協作者的請款方式不同**
- **不同協作者的驗收標準可能不同**

## 3. Task 的協作者管理

### 協作者的類型

```typescript
// 概念模型

Collaborator {
  type: 'Company' | 'Team' | 'Individual'
  
  // 公司層級
  if type === 'Company':
    - 下包商資訊
    - 合約關係
    - 統一發票資訊
    - 保險證明
  
  // 團隊層級  
  if type === 'Team':
    - 班組長
    - 成員清單
    - 專長領域
  
  // 個人層級
  if type === 'Individual':
    - 個人資料
    - 證照資訊
    - 勞健保狀態
}
```

### Task 的指派邏輯

```
建立 Task 時:

1. 選擇主要負責方:
   □ 自有團隊
   □ 下包商 A
   □ 下包商 B

2. 指派具體人員/團隊:
   - 如果是自有: 選擇班組 (張三組)
   - 如果是下包: 選擇下包的負責人

3. 定義協作關係:
   - 主責: 張三組 (宏林自有)
   - 協作: 李四 (下包商 A 的吊裝專家)
   - 監督: 王工 (宏林品管)

4. 定義成本分配:
   - 人工成本: 50,000
   - 外包成本: 80,000  
   - 材料成本: 34,941
   - 總計: 164,941
```

## 4. Task 的驗收與請款流程

### 多階段驗收

```
Task-001: SS-A01 機櫃安裝

階段 1: 材料進場驗收
  ├─ 材料清點 (倉管)
  ├─ 規格確認 (工程師)
  ├─ 照片記錄
  └─ 可請款 50%

階段 2: 安裝完成自檢
  ├─ 施工團隊自檢表
  ├─ 照片記錄
  └─ 通知 QC 來檢

階段 3: 質檢 (QC)
  ├─ QC 工程師現場檢查
  ├─ 檢查項目打勾
  ├─ 缺失記錄 (如果有)
  ├─ 照片記錄
  └─ QC 通過 → 可請款 30%

階段 4: 業主驗收
  ├─ 通知業主 (ABB-William)
  ├─ 業主現場驗收
  ├─ 驗收文件簽署
  ├─ 照片記錄
  └─ 驗收通過 → 可請款 20%
```

### 請款與收款追蹤

```
Task-001 的金流狀態:

預算: 164,941 元

請款記錄:
├─ Invoice-001: 82,470 (50%) 
│   ├─ 請款日期: 3/15
│   ├─ 發票號碼: AB12345678
│   ├─ 依據: 材料進場驗收單
│   ├─ 狀態: 已收款
│   └─ 收款日期: 4/20 (月結 90天)
│
├─ Invoice-002: 49,482 (30%)
│   ├─ 請款日期: 3/25
│   ├─ 發票號碼: AB12345679  
│   ├─ 依據: QC 驗收單
│   ├─ 狀態: 待收款
│   └─ 預計收款: 5/30
│
└─ Invoice-003: 32,988 (20%)
    ├─ 請款日期: 待驗收完成
    ├─ 依據: 業主驗收單
    └─ 狀態: 尚未請款

已請款: 131,952 (80%)
已收款: 82,470 (50%)
待收款: 49,482 (30%)
未請款: 32,988 (20%)
```

## 5. Task 與 Event-Sourced 的關係

### Task 的 Events 變得更複雜

```
TaskCreated
  → 基本資訊建立

TaskBudgetAllocated
  → 預算分配

TaskAssignedToCollaborator
  → 指派給協作者 (可能多個)

TaskStarted
  → 開始執行

TaskMaterialReceived
  → 材料進場
  → 觸發第一次請款資格

TaskSelfInspectionCompleted
  → 自檢完成
  → 通知 QC

TaskQCInspectionPassed / Failed
  → 質檢結果
  → 如果通過,觸發第二次請款資格

TaskClientAcceptancePassed / Failed
  → 業主驗收結果  
  → 如果通過,觸發最終請款資格

TaskInvoiceRequested
  → 請款申請
  → 產生發票

TaskPaymentReceived
  → 收款確認

TaskCompleted
  → 完全結案
```

### Task 與下游的連動

```
當 TaskQCInspectionPassed:
  → 更新 Task 狀態
  → 觸發請款流程
  → 通知承包商可以開發票
  → 如果是下包,觸發內部應付帳款
  → 更新整體專案進度
  → 更新 Milestone 進度
  → 產生每日日誌記錄
```

## 6. 實務上的複雜場景

### 場景 A: 下包商的驗收與請款

```
Task-055: SS-B03 光纖熔接
  ├─ 指派給: 下包商 C (光纖專業)
  ├─ 合約金額: 50,000
  ├─ 請款方式: 完工後一次付清
  
下包商的視角:
1. 收到 Task 指派通知
2. 到現場施工
3. 完成後提交自檢表
4. 等待宏林 QC 驗收
5. QC 通過後,向宏林請款
6. 宏林付款給下包商

宏林的視角:
1. 指派 Task 給下包商 C
2. 下包完成後,派 QC 驗收
3. 驗收通過,核准下包請款
4. 付款給下包商
5. 等待業主驗收
6. 業主驗收後,向業主請款
7. 收款後結案
```

### 場景 B: 驗收失敗的處理

```
Task-102: SS-C05 配線施工
  ├─ 執行: 張三組
  ├─ QC 驗收: 2024-03-20
  └─ 結果: 不通過

QCInspectionFailed Event:
  ├─ 缺失項目:
  │   ├─ 線路標示不清
  │   ├─ 部分接線鬆動
  │   └─ 配線不整齊
  ├─ 照片證據
  └─ 要求期限: 2024-03-22 前改善

產生新的 Tasks:
  └─ Task-102-Rework: SS-C05 缺失改善
      ├─ 指派: 張三組
      ├─ 狀態: Pending
      └─ 說明: 修正 Task-102 的缺失

改善完成後:
  └─ 重新 QC 驗收
      └─ 通過 → 才能請款
```

### 場景 C: 分批驗收的材料管理

```
Task-010: 機櫃材料進場

第一批: 2024-03-10
  ├─ 機櫃 A01-A05 (5台)
  ├─ 驗收: 規格相符
  └─ 請款: 25% (對應 5/16 台)

第二批: 2024-03-15  
  ├─ 機櫃 A06-A10 (5台)
  ├─ 驗收: A08 規格不符,退貨
  └─ 請款: 18.75% (對應 4/16 台)

第三批: 2024-03-20
  ├─ 機櫃 A11-A16, A08補貨 (7台)
  ├─ 驗收: 全部相符
  └─ 請款: 31.25% (對應 7/16 台)

累計請款: 75%
完工請款: 等全部安裝完成
```

## 7. Task 系統的核心需求

### 必須追蹤的資訊

**人員/組織**:
- 指派給誰 (主責)
- 協作者有誰 (協同)
- QC 是誰
- 業主驗收人是誰

**進度狀態**:
- 執行進度
- 驗收階段
- 請款階段
- 收款狀態

**金額管理**:
- 預算金額
- 已請款金額
- 已收款金額
- 待收款金額
- 內部成本 (如果有下包)

**文件記錄**:
- 自檢表
- QC 驗收單
- 業主驗收單
- 發票
- 收據
- 照片證據
- 缺失記錄

## 8. 我的新理解

Task 在你們的系統中是:

### 不是簡單的待辦事項
而是 **「可計價的工作單元」**

### 不只是進度追蹤
而是 **「從執行到收款的完整生命週期管理」**

### 不只記錄工作內容
而是 **「連結人員、金流、驗收的關鍵節點」**

### 核心設計原則

1. **Task 必須可追溯責任**
   - 誰做的?誰驗的?誰付錢?

2. **Task 必須可計算成本**
   - 預算多少?實際多少?差異多少?

3. **Task 必須可證明完成**
   - 有自檢表、有 QC 單、有驗收單、有照片

4. **Task 必須可分階段請款**
   - 材料到了請 50%,安裝完請 30%,驗收過請 20%

5. **Task 必須可管理協作者**
   - 自己做?下包做?誰負責?

## 9. 關鍵問題

### 關於協作者管理

**下包商的視角**:
- 下包商能看到自己的 Tasks 嗎?
- 下包商能在系統裡提交驗收文件嗎?
- 還是都透過宏林的人員代為操作?

**多層下包**:
- 如果宏林包給下包 A,下包 A 又包給下包 B?
- 系統需要追蹤到幾層?

### 關於請款管理

**請款比例**:
- 每個 Task 的請款比例是固定的?還是彈性的?
- 誰決定可以請款? (QC?專案經理?業主?)

**請款與驗收的關係**:
- 一定要驗收通過才能請款?
- 還是「部分驗收,部分請款」?

### 關於驗收標準

**驗收的層次**:
- 自檢 → QC → 業主,是不是每個 Task 都要走完?
- 還是小的 Task 可以簡化流程?

**驗收的粒度**:
- 一個 Task 一次驗收?
- 還是可以分批驗收?

這些細節會影響 Task 的資料結構和狀態機設計。你們實際上是怎麼運作的?