# æ¶æ§‹ç¾æ³èˆ‡ç†æƒ³ç‹€æ…‹å°æ¯”

## ç¾æ³æ¶æ§‹ (Current State) âŒ

```
src/app/
â”œâ”€â”€ core/                       âœ… 100% å®Œæˆ (å„ªç§€)
â”‚   â”œâ”€â”€ foundation/
â”‚   â”œâ”€â”€ governance/
â”‚   â”œâ”€â”€ observability/
â”‚   â”œâ”€â”€ error/
â”‚   â””â”€â”€ result/
â”‚
â”œâ”€â”€ infrastructure/             âœ… 100% å®Œæˆ (å„ªç§€)
â”‚   â”œâ”€â”€ abstractions/
â”‚   â”œâ”€â”€ firebase/
â”‚   â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ providers/
â”‚
â”œâ”€â”€ platform/                   âš ï¸ 30% å®Œæˆ (éª¨æ¶å­˜åœ¨)
â”‚   â”œâ”€â”€ entities/               âš ï¸ ç¼ºå°‘ Events, Decisions, Projections
â”‚   â”‚   â”œâ”€â”€ user/
â”‚   â”‚   â”œâ”€â”€ organization/
â”‚   â”‚   â”œâ”€â”€ team/
â”‚   â”‚   â”œâ”€â”€ collaborator/
â”‚   â”‚   â””â”€â”€ bot/
â”‚   â”œâ”€â”€ events/                 âš ï¸ éƒ¨åˆ†å®Œæˆ
â”‚   â”œâ”€â”€ processes/              âŒ æœªå¯¦ä½œ
â”‚   â””â”€â”€ ui/                     âŒ æœªå®Œæ•´
â”‚
â””â”€â”€ features/
    â””â”€â”€ domains/                âŒ æ¶æ§‹é•è¦ï¼
        â”œâ”€â”€ activity/           âŒ é•å "Task å”¯ä¸€å¯¦é«”" åŸå‰‡
        â”œâ”€â”€ attachment/         âŒ æ‡‰ç‚º Task Events
        â”œâ”€â”€ comment/            âŒ æ‡‰ç‚º Task Events
        â”œâ”€â”€ discussion/         âŒ æ‡‰ç‚º Task Events
        â”œâ”€â”€ issue/              âŒ æ‡‰åˆä½µåˆ° Task
        â”œâ”€â”€ task/               âš ï¸ å­˜åœ¨ä½†ä¸å®Œæ•´
        â””â”€â”€ user/               âŒ æ‡‰åœ¨ Platform Layer
```

**å•é¡Œç¸½çµ**:
- âŒ é•å Task.md æ¶æ§‹åŸå‰‡
- âŒ å¤šå€‹ domain å­˜åœ¨ (æ‡‰è©²åªæœ‰ Task)
- âŒ Event Sourcing æ¶æ§‹ä¸å®Œæ•´
- âŒ ç¼ºå°‘ Projection Engine
- âŒ ç¼ºå°‘ Decision Layer

---

## ç†æƒ³æ¶æ§‹ (Target State) âœ…

### æ ¹æ“š Task.md + SaaS.md + Causality-Driven åŸå‰‡

```
src/app/
â”œâ”€â”€ core/                       âœ… å·²å®Œæˆ - ä¿æŒä¸è®Š
â”‚   â”œâ”€â”€ foundation/
â”‚   â”œâ”€â”€ governance/
â”‚   â”œâ”€â”€ observability/
â”‚   â”œâ”€â”€ error/
â”‚   â”œâ”€â”€ result/
â”‚   â””â”€â”€ projection/             ğŸ†• éœ€æ–°å¢ - Projection Engine
â”‚
â”œâ”€â”€ infrastructure/             âœ… å·²å®Œæˆ - ä¿æŒä¸è®Š
â”‚   â”œâ”€â”€ abstractions/
â”‚   â”œâ”€â”€ firebase/
â”‚   â”œâ”€â”€ supabase/
â”‚   â””â”€â”€ providers/
â”‚
â”œâ”€â”€ platform/                   ğŸ”§ éœ€å®Œå–„
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ user/               ğŸ”§ éœ€å®Œæ•´å¯¦ä½œ
â”‚   â”‚   â”‚   â”œâ”€â”€ events/         ğŸ†• User Events
â”‚   â”‚   â”‚   â”œâ”€â”€ decisions/      ğŸ†• User Decisions (ç´”å‡½æ•¸)
â”‚   â”‚   â”‚   â”œâ”€â”€ projections/    ğŸ†• User Projections
â”‚   â”‚   â”‚   â”œâ”€â”€ commands/       ğŸ†• User Commands
â”‚   â”‚   â”‚   â””â”€â”€ models/         ğŸ†• User Read Models
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ organization/       ğŸ”§ åŒ user/ çµæ§‹
â”‚   â”‚   â”œâ”€â”€ team/               ğŸ”§ åŒ user/ çµæ§‹
â”‚   â”‚   â”œâ”€â”€ collaborator/       ğŸ”§ åŒ user/ çµæ§‹
â”‚   â”‚   â””â”€â”€ bot/                ğŸ”§ åŒ user/ çµæ§‹
â”‚   â”‚
â”‚   â”œâ”€â”€ processes/              ğŸ†• éœ€å¯¦ä½œ
â”‚   â”‚   â”œâ”€â”€ collaboration.process.ts
â”‚   â”‚   â”œâ”€â”€ onboarding.process.ts
â”‚   â”‚   â””â”€â”€ team-formation.process.ts
â”‚   â”‚
â”‚   â””â”€â”€ ui/                     ğŸ”§ éœ€å®Œå–„
â”‚
â””â”€â”€ features/
    â””â”€â”€ domains/
        â””â”€â”€ task/               ğŸ”§ å”¯ä¸€æ¥­å‹™å¯¦é«” - éœ€å®Œæ•´é‡æ§‹
            â”œâ”€â”€ events/         ğŸ†• éœ€å¯¦ä½œ
            â”‚   â”œâ”€â”€ task.events.ts
            â”‚   â”œâ”€â”€ task-lifecycle.events.ts
            â”‚   â”œâ”€â”€ task-comment.events.ts      â† comment æ˜¯ Task çš„äº‹ä»¶
            â”‚   â”œâ”€â”€ task-discussion.events.ts   â† discussion æ˜¯ Task çš„äº‹ä»¶
            â”‚   â””â”€â”€ task-attachment.events.ts   â† attachment æ˜¯ Task çš„äº‹ä»¶
            â”‚
            â”œâ”€â”€ decisions/      ğŸ†• éœ€å¯¦ä½œ (ç´”å‡½æ•¸)
            â”‚   â”œâ”€â”€ task.decisions.ts
            â”‚   â”‚   â”œâ”€â”€ decideStartTask()
            â”‚   â”‚   â”œâ”€â”€ decideCompleteTask()
            â”‚   â”‚   â”œâ”€â”€ decideArchiveTask()
            â”‚   â”‚   â””â”€â”€ decideReopenTask()
            â”‚   â”‚
            â”‚   â”œâ”€â”€ comment.decisions.ts
            â”‚   â”‚   â”œâ”€â”€ decideAddComment()
            â”‚   â”‚   â”œâ”€â”€ decideEditComment()
            â”‚   â”‚   â””â”€â”€ decideDeleteComment()
            â”‚   â”‚
            â”‚   â”œâ”€â”€ discussion.decisions.ts
            â”‚   â”‚   â”œâ”€â”€ decideStartDiscussion()
            â”‚   â”‚   â””â”€â”€ decideReplyToDiscussion()
            â”‚   â”‚
            â”‚   â””â”€â”€ attachment.decisions.ts
            â”‚       â”œâ”€â”€ decideUploadAttachment()
            â”‚       â””â”€â”€ decideDeleteAttachment()
            â”‚
            â”œâ”€â”€ projections/    ğŸ†• éœ€å¯¦ä½œ (å¤šè¦–åœ–)
            â”‚   â”œâ”€â”€ task-list.projection.ts         â† åˆ—è¡¨è¦–åœ–
            â”‚   â”œâ”€â”€ task-board.projection.ts        â† çœ‹æ¿è¦–åœ–
            â”‚   â”œâ”€â”€ task-detail.projection.ts       â† è©³æƒ…è¦–åœ–
            â”‚   â”œâ”€â”€ task-why.projection.ts          â† Whyè¦–åœ– (è§£é‡‹ç‹€æ…‹)
            â”‚   â”œâ”€â”€ task-discussion.projection.ts   â† è¨è«–è¦–åœ–
            â”‚   â”œâ”€â”€ task-comment.projection.ts      â† è©•è«–è¦–åœ–
            â”‚   â”œâ”€â”€ task-attachment.projection.ts   â† é™„ä»¶è¦–åœ–
            â”‚   â””â”€â”€ task-timeline.projection.ts     â† æ™‚é–“ç·šè¦–åœ–
            â”‚
            â”œâ”€â”€ processes/      ğŸ†• éœ€å¯¦ä½œ (Saga)
            â”‚   â”œâ”€â”€ task-lifecycle.process.ts
            â”‚   â””â”€â”€ task-collaboration.process.ts
            â”‚
            â”œâ”€â”€ commands/       ğŸ†• éœ€å¯¦ä½œ
            â”‚   â”œâ”€â”€ task.commands.ts
            â”‚   â”œâ”€â”€ comment.commands.ts
            â”‚   â”œâ”€â”€ discussion.commands.ts
            â”‚   â””â”€â”€ attachment.commands.ts
            â”‚
            â”œâ”€â”€ models/         ğŸ†• éœ€å¯¦ä½œ (Read Models)
            â”‚   â”œâ”€â”€ task.model.ts
            â”‚   â”œâ”€â”€ task-comment.model.ts
            â”‚   â””â”€â”€ task-discussion.model.ts
            â”‚
            â””â”€â”€ ui/             ğŸ†• éœ€å¯¦ä½œ (UI Components)
                â””â”€â”€ components/
                    â”œâ”€â”€ task-list/
                    â”œâ”€â”€ task-board/
                    â”œâ”€â”€ task-detail/
                    â”œâ”€â”€ task-why/
                    â”œâ”€â”€ task-discussion/
                    â”œâ”€â”€ task-comment/
                    â””â”€â”€ task-timeline/
```

---

## Event Sourcing è³‡æ–™æµ

### æ­£ç¢ºçš„ Event-Driven æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Event Sourcing Flow                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Command éšæ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UI Component â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ dispatch
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   Command    â”‚ (CreateTaskCommand)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

2. Decision éšæ®µ (ç´”å‡½æ•¸)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚     Decision Function        â”‚
   â”‚  decideCreateTask(command)   â”‚
   â”‚                              â”‚
   â”‚  - é©—è­‰æ¥­å‹™è¦å‰‡              â”‚
   â”‚  - å¾æ­·å² Events æ¨å°ç‹€æ…‹    â”‚
   â”‚  - è¿”å› Result<Event, Error> â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Event     â”‚ (TaskCreatedEvent)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

3. Persist éšæ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Event Store  â”‚
   â”‚  .append()   â”‚
   â”‚              â”‚
   â”‚  - é©—è­‰å› æœéˆ (causedBy)      â”‚
   â”‚  - æª¢æŸ¥ä¸¦ç™¼è¡çª              â”‚
   â”‚  - è¿½åŠ åˆ°äº‹ä»¶æµ              â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

4. Publish éšæ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Event Bus   â”‚
   â”‚  .publish()  â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                             â”‚
          â–¼                             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Projection     â”‚         â”‚ Process Manager  â”‚
   â”‚ Engine         â”‚         â”‚ (Saga)           â”‚
   â”‚                â”‚         â”‚                  â”‚
   â”‚ - é‡å»ºç‹€æ…‹     â”‚         â”‚ - è§¸ç™¼ä¸‹ä¸€æ­¥      â”‚
   â”‚ - æ›´æ–° Read    â”‚         â”‚ - è·¨å¯¦é«”å”èª¿      â”‚
   â”‚   Model        â”‚         â”‚ - ç™¼é€é€šçŸ¥        â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

5. Query éšæ®µ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Read Model  â”‚ (å¿«å–çš„æŠ•å½±ç‹€æ…‹)
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UI Component â”‚ (é¡¯ç¤ºæœ€æ–°ç‹€æ…‹)
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é—œéµæ¦‚å¿µ

**Event = å”¯ä¸€äº‹å¯¦ä¾†æº**
```typescript
// âŒ éŒ¯èª¤ - CRUD æ¨¡å¼
await taskRepository.update(taskId, { status: 'Completed' });

// âœ… æ­£ç¢º - Event Sourcing
const event: TaskCompletedEvent = {
  type: 'TaskCompleted',
  taskId: taskId,
  completedAt: new Date(),
  completedBy: userId,
  causedBy: [previousEventId]  // å› æœéˆ
};
await eventStore.append(event);
```

**State = replay(events)**
```typescript
// âŒ éŒ¯èª¤ - ç›´æ¥å¾è³‡æ–™åº«è®€å–ç‹€æ…‹
const task = await taskRepository.findById(taskId);

// âœ… æ­£ç¢º - å¾ Events é‡å»ºç‹€æ…‹
const events = await eventStore.getStream(taskId);
const task = taskProjection.project(events);

// æˆ–ä½¿ç”¨ Snapshot å„ªåŒ–
const snapshot = await snapshotStore.getLatest(taskId);
const eventsAfterSnapshot = await eventStore.getStream(
  taskId, 
  snapshot.version + 1
);
const task = taskProjection.project(
  [snapshot.state, ...eventsAfterSnapshot]
);
```

**Decision = ç´”å‡½æ•¸**
```typescript
// âœ… Decision å¿…é ˆæ˜¯ç´”å‡½æ•¸
export function decideCompleteTask(
  events: TaskEvent[],
  command: CompleteTaskCommand
): Result<TaskCompletedEvent, DomainError> {
  // 1. å¾ Events é‡å»ºç•¶å‰ç‹€æ…‹
  const currentState = projectTaskState(events);
  
  // 2. é©—è­‰æ¥­å‹™è¦å‰‡
  if (currentState.status !== 'InProgress') {
    return err(ErrorFactory.domain.businessRule(
      'Task must be in progress to complete'
    ));
  }
  
  if (!currentState.assignedTo) {
    return err(ErrorFactory.domain.businessRule(
      'Task must be assigned before completion'
    ));
  }
  
  // 3. è¿”å›æ–°çš„ Event
  return ok({
    type: 'TaskCompleted',
    taskId: command.taskId,
    completedAt: new Date(),
    completedBy: command.userId,
    causedBy: [events[events.length - 1].eventId]  // å› æœéˆ
  });
}
```

---

## é‡æ§‹è·¯å¾‘

### Step 1: ç§»é™¤é•è¦çµæ§‹

```bash
# ç§»é™¤é€™äº›é•å Task.md åŸå‰‡çš„ç›®éŒ„
features/domains/
â”œâ”€â”€ activity/     â†’ åˆªé™¤ (ç”¨ Task Events è¿½è¹¤æ´»å‹•)
â”œâ”€â”€ attachment/   â†’ åˆªé™¤ (åˆä½µåˆ° task/events/task-attachment.events.ts)
â”œâ”€â”€ comment/      â†’ åˆªé™¤ (åˆä½µåˆ° task/events/task-comment.events.ts)
â””â”€â”€ discussion/   â†’ åˆªé™¤ (åˆä½µåˆ° task/events/task-discussion.events.ts)
```

### Step 2: é‡æ§‹ Task Domain

```bash
# ä¿ç•™ä½†å®Œå…¨é‡æ§‹
features/domains/task/
â”œâ”€â”€ events/        â†’ æ–°å¢å®Œæ•´ Event å®šç¾©
â”œâ”€â”€ decisions/     â†’ æ–°å¢ Decision ç´”å‡½æ•¸
â”œâ”€â”€ projections/   â†’ æ–°å¢å¤šè¦–åœ– Projection
â”œâ”€â”€ processes/     â†’ æ–°å¢ Saga/Process Manager
â”œâ”€â”€ commands/      â†’ æ–°å¢ Command å®šç¾©
â”œâ”€â”€ models/        â†’ æ–°å¢ Read Model
â””â”€â”€ ui/            â†’ æ–°å¢ UI Components
```

### Step 3: ç§»å‹• User åˆ° Platform

```bash
# å¾ features/domains/ ç§»åˆ° platform/entities/
features/domains/user/  â†’ ç§»é™¤
platform/entities/user/ â†’ å®Œå–„å¯¦ä½œ
```

### Step 4: åˆä½µ Issue åˆ° Task

```bash
# Issue å¯¦éš›ä¸Šå°±æ˜¯ Task
features/domains/issue/  â†’ åˆä½µåˆ° task/
```

---

## æª”æ¡ˆè®Šå‹•çµ±è¨ˆ

| éšæ®µ | åˆªé™¤ | æ–°å¢ | ä¿®æ”¹ | ç§»å‹• | ç¸½è¨ˆ |
|------|------|------|------|------|------|
| **é‡æ§‹** | 20 | 10 | 10 | 10 | **50** |
| **Task Domain** | 0 | 90 | 10 | 0 | **100** |
| **Platform** | 0 | 150 | 20 | 0 | **170** |
| **æ•´åˆæ¸¬è©¦** | 0 | 40 | 10 | 0 | **50** |
| **ç¸½è¨ˆ** | **20** | **290** | **50** | **10** | **370** |

---

## é—œéµæˆåŠŸæŒ‡æ¨™

### æ¶æ§‹åˆè¦æ€§

- [ ] âœ… Task æ˜¯å”¯ä¸€æ¥­å‹™å¯¦é«”
- [ ] âœ… Events æ˜¯å”¯ä¸€äº‹å¯¦ä¾†æº
- [ ] âœ… æ‰€æœ‰ Decision éƒ½æ˜¯ç´”å‡½æ•¸
- [ ] âœ… State = replay(events)
- [ ] âœ… å®Œæ•´çš„ Causality è¿½è¹¤
- [ ] âœ… å¤šè¦–åœ–é€é Projection å¯¦ç¾
- [ ] âœ… Process Manager è™•ç†è·¨å¯¦é«”å”èª¿

### Event Sourcing æª¢æŸ¥

- [ ] âœ… Event Store å®Œæ•´å¯¦ä½œ
- [ ] âœ… Projection Engine å»ºç«‹
- [ ] âœ… Snapshot æ©Ÿåˆ¶å„ªåŒ–
- [ ] âœ… Event Replay åŠŸèƒ½
- [ ] âœ… Event Versioning ç­–ç•¥
- [ ] âœ… Read Model Updater

### æ¸¬è©¦è¦†è“‹

- [ ] âœ… Decision å±¤ Unit Tests (>90%)
- [ ] âœ… Projection å±¤ Unit Tests (>90%)
- [ ] âœ… Event Store Integration Tests
- [ ] âœ… Process Manager Integration Tests
- [ ] âœ… Platform â†” Task E2E Tests

---

**æœ€å¾Œæ›´æ–°**: 2025-12-31  
**ç‰ˆæœ¬**: 1.0
