# Security Agent Configuration
# 安全性代理配置

name: security
description: "Specialized agent for security auditing and vulnerability detection with MCP tools"

# MCP 工具用於安全性
mcp_tools:
  primary:
    - supabase  # RLS policies 檢查
    - sequential-thinking  # 安全性分析
    - filesystem  # 掃描檔案
    - git  # 查看變更
  
  secondary:
    - context7  # 安全性最佳實踐
    - github  # 安全性告警
    - memory  # 記錄安全性模式

# 安全性檢查類別
security_checks:
  authentication:
    checks:
      - "JWT token 驗證"
      - "Session 管理"
      - "密碼強度要求"
      - "多因素認證"
      - "OAuth 流程安全性"
    
    mcp_workflow:
      - tool: filesystem.grep
        params:
          pattern: "(jwt|token|auth|session)"
      
      - tool: sequential-thinking.sequentialthinking
        description: "分析認證流程"
      
      - tool: supabase.get_advisors
        params:
          type: "security"
  
  authorization:
    checks:
      - "RLS policies 正確性"
      - "Role-based access control"
      - "API 端點權限"
      - "資源所有權驗證"
      - "權限提升防護"
    
    mcp_workflow:
      - tool: supabase.list_tables
        description: "列出所有資料表"
      
      - tool: supabase.execute_sql
        params:
          query: "SELECT * FROM pg_policies;"
        description: "檢查 RLS policies"
      
      - tool: supabase.get_advisors
        params:
          type: "security"
        description: "安全性建議"
  
  input_validation:
    checks:
      - "XSS 防護"
      - "SQL injection 防護"
      - "CSRF token"
      - "輸入長度限制"
      - "型別驗證"
      - "格式驗證"
    
    mcp_workflow:
      - tool: filesystem.grep
        params:
          pattern: "(innerHTML|dangerouslySetInnerHTML|eval)"
        description: "搜尋危險模式"
      
      - tool: sequential-thinking.sequentialthinking
        description: "分析輸入處理"
  
  data_protection:
    checks:
      - "敏感資料加密"
      - "資料傳輸加密 (HTTPS)"
      - "資料庫加密"
      - "Secrets 管理"
      - "PII 資料處理"
    
    mcp_workflow:
      - tool: filesystem.grep
        params:
          pattern: "(password|secret|api_key|private_key)"
        description: "搜尋硬編碼 secrets"
      
      - tool: git.log
        description: "檢查 git 歷史"
  
  api_security:
    checks:
      - "Rate limiting"
      - "API key 驗證"
      - "CORS 設定"
      - "Input sanitization"
      - "Output encoding"
    
    mcp_workflow:
      - tool: filesystem.grep
        params:
          pattern: "(cors|rate-limit|api-key)"
      
      - tool: sequential-thinking.sequentialthinking
        description: "分析 API 安全性"

# 漏洞模式
vulnerability_patterns:
  xss:
    pattern: "innerHTML|dangerouslySetInnerHTML|document.write"
    severity: "high"
    description: "Cross-Site Scripting (XSS) 風險"
    mitigation:
      - "使用 Angular 的 DomSanitizer"
      - "使用 [textContent] 而非 innerHTML"
      - "避免直接操作 DOM"
    mcp_tool: "context7.get-library-docs"
    params:
      context7CompatibleLibraryID: "/angular/angular"
      topic: "security"
  
  sql_injection:
    pattern: "\\+.*sql|string.*query|exec.*sql"
    severity: "critical"
    description: "SQL Injection 風險"
    mitigation:
      - "使用參數化查詢"
      - "使用 Supabase client methods"
      - "避免字串拼接 SQL"
    mcp_tool: "supabase.execute_sql"
    example: |
      // ❌ 錯誤
      const query = `SELECT * FROM users WHERE id = ${userId}`;
      
      // ✅ 正確
      const { data } = await supabase
        .from('users')
        .select('*')
        .eq('id', userId);
  
  secrets_exposure:
    pattern: "(password|api[_-]?key|secret|token)\\s*=\\s*['\"]\\w+"
    severity: "critical"
    description: "硬編碼 secrets"
    mitigation:
      - "使用環境變數"
      - "使用 GitHub Secrets"
      - "使用 Supabase Vault"
    mcp_tool: "filesystem.grep"
  
  insecure_dependencies:
    pattern: "package.json"
    severity: "medium"
    description: "不安全的相依套件"
    mitigation:
      - "定期執行 npm audit"
      - "更新套件版本"
      - "使用 Snyk 或類似工具"
    mcp_tool: "filesystem.read_text_file"
  
  missing_rls:
    pattern: "CREATE TABLE.*(?!.*ENABLE ROW LEVEL SECURITY)"
    severity: "high"
    description: "缺少 RLS policies"
    mitigation:
      - "啟用 RLS: ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;"
      - "建立適當的 policies"
    mcp_tool: "supabase.get_advisors"
    params:
      type: "security"

# 安全性掃描流程
security_scan:
  steps:
    - name: "檔案掃描"
      description: "掃描所有原始碼檔案"
      tools:
        - filesystem.directory_tree
        - filesystem.search_files
      patterns:
        - "**/*.ts"
        - "**/*.js"
        - "**/*.html"
    
    - name: "模式匹配"
      description: "搜尋漏洞模式"
      tools:
        - filesystem.grep
      patterns: "vulnerability_patterns"
    
    - name: "資料庫檢查"
      description: "檢查 RLS policies"
      tools:
        - supabase.list_tables
        - supabase.execute_sql
        - supabase.get_advisors
    
    - name: "Git 歷史檢查"
      description: "檢查 secrets 洩漏"
      tools:
        - git.log
        - git.diff
    
    - name: "深度分析"
      description: "邏輯漏洞分析"
      tools:
        - sequential-thinking.sequentialthinking
    
    - name: "記錄發現"
      description: "記錄安全性問題"
      tools:
        - memory.create_entities

# RLS Policy 模板
rls_policy_templates:
  user_isolation:
    description: "使用者只能存取自己的資料"
    template: |
      CREATE POLICY "Users can only access own data"
      ON {table_name}
      FOR ALL
      USING (auth.uid() = user_id);
  
  role_based:
    description: "基於角色的存取控制"
    template: |
      CREATE POLICY "Role-based access"
      ON {table_name}
      FOR ALL
      USING (
        EXISTS (
          SELECT 1 FROM user_roles
          WHERE user_roles.user_id = auth.uid()
          AND user_roles.role IN ({allowed_roles})
        )
      );
  
  organization_isolation:
    description: "組織隔離"
    template: |
      CREATE POLICY "Organization isolation"
      ON {table_name}
      FOR ALL
      USING (
        organization_id IN (
          SELECT organization_id
          FROM user_organizations
          WHERE user_id = auth.uid()
        )
      );

# 安全性最佳實踐
best_practices:
  angular:
    - "使用 Angular 內建的 DomSanitizer"
    - "啟用 Content Security Policy"
    - "使用 HttpOnly cookies"
    - "實作 CSRF protection"
    - "驗證所有使用者輸入"
    - "避免使用 eval() 和 Function()"
  
  supabase:
    - "啟用所有資料表的 RLS"
    - "使用最小權限原則"
    - "定期審查 RLS policies"
    - "使用 service_role key 時要特別小心"
    - "實作 rate limiting"
    - "記錄所有資料庫操作"
  
  authentication:
    - "使用強密碼策略"
    - "實作多因素認證"
    - "使用安全的 session 管理"
    - "定期輪替 tokens"
    - "實作登入失敗限制"
  
  deployment:
    - "使用 HTTPS"
    - "設定適當的 CORS"
    - "隱藏錯誤詳情"
    - "定期更新相依套件"
    - "使用 secrets 管理服務"

# 安全性檢查清單
security_checklist:
  - name: "認證與授權"
    items:
      - "[ ] JWT token 正確驗證"
      - "[ ] Session 安全管理"
      - "[ ] RLS policies 完整"
      - "[ ] 權限檢查到位"
  
  - name: "輸入驗證"
    items:
      - "[ ] XSS 防護"
      - "[ ] SQL injection 防護"
      - "[ ] CSRF token"
      - "[ ] 輸入消毒"
  
  - name: "資料保護"
    items:
      - "[ ] 敏感資料加密"
      - "[ ] HTTPS 啟用"
      - "[ ] 無硬編碼 secrets"
      - "[ ] PII 資料保護"
  
  - name: "API 安全性"
    items:
      - "[ ] Rate limiting"
      - "[ ] API 認證"
      - "[ ] CORS 設定正確"
      - "[ ] 錯誤處理適當"
  
  - name: "相依套件"
    items:
      - "[ ] 無已知漏洞"
      - "[ ] 定期更新"
      - "[ ] 審核新套件"

# 報告格式
security_report:
  sections:
    - summary:
        total_issues: 0
        critical: 0
        high: 0
        medium: 0
        low: 0
    
    - findings:
        - category: ""
          severity: ""
          description: ""
          location: ""
          mitigation: ""
    
    - recommendations:
        - priority: ""
          action: ""
          impact: ""
