# GitHub Copilot è‡ªå‹•æ¸¬è©¦ã€Lint å’Œå»ºç½®é…ç½®
# Auto Test, Lint, and Build Configuration for GitHub Copilot
#
# æ­¤é…ç½®è®“ GitHub Copilot åœ¨æ¯æ¬¡ç¨‹å¼ç¢¼è®Šæ›´å¾Œè‡ªå‹•åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦æµç¨‹
# This configuration enables GitHub Copilot to automatically run full test suite after code changes

name: auto-test-lint-build
version: "1.0"
description: "è‡ªå‹•åŸ·è¡Œ yarn test + yarn lint + yarn build çš„å®Œæ•´æ¸¬è©¦æµç¨‹"

# ==========================================
# ğŸ¯ è§¸ç™¼æ¢ä»¶ (Trigger Conditions)
# ==========================================
triggers:
  # æ¢ä»¶ 1: ç¨‹å¼ç¢¼æäº¤å‰
  before_commit:
    enabled: true
    description: "åœ¨ Git commit å‰è‡ªå‹•åŸ·è¡Œæª¢æŸ¥"
    run_commands:
      - command: "yarn lint"
        description: "åŸ·è¡Œ ESLint å’Œ Stylelint æª¢æŸ¥"
        timeout: 120
        required: true
        on_failure: "block_commit"
      
      - command: "yarn test --watch=false --browsers=ChromeHeadless"
        description: "åŸ·è¡Œå–®å…ƒæ¸¬è©¦ (ä¸å•Ÿç”¨ watch æ¨¡å¼)"
        timeout: 300
        required: true
        on_failure: "block_commit"
      
      - command: "yarn build"
        description: "åŸ·è¡Œç”Ÿç”¢å»ºç½®æª¢æŸ¥"
        timeout: 600
        required: false
        on_failure: "warn_only"

  # æ¢ä»¶ 2: æª”æ¡ˆå„²å­˜å¾Œ
  after_file_save:
    enabled: true
    description: "å„²å­˜æª”æ¡ˆå¾Œè‡ªå‹•åŸ·è¡Œç›¸é—œæª¢æŸ¥"
    file_patterns:
      - "src/**/*.ts"
      - "src/**/*.html"
      - "src/**/*.less"
      - "src/**/*.spec.ts"
    
    run_commands:
      - command: "yarn lint:ts --fix"
        description: "è‡ªå‹•ä¿®å¾© TypeScript lint å•é¡Œ"
        timeout: 60
        auto_fix: true
      
      - command: "yarn lint:style --fix"
        description: "è‡ªå‹•ä¿®å¾©æ¨£å¼ lint å•é¡Œ"
        timeout: 60
        auto_fix: true

  # æ¢ä»¶ 3: PR å»ºç«‹æˆ–æ›´æ–°æ™‚
  on_pull_request:
    enabled: true
    description: "PR å»ºç«‹æˆ–æ›´æ–°æ™‚åŸ·è¡Œå®Œæ•´æª¢æŸ¥"
    events:
      - opened
      - synchronize
      - reopened
    
    run_commands:
      - command: "yarn lint"
        description: "å®Œæ•´ Lint æª¢æŸ¥"
        timeout: 120
        required: true
      
      - command: "yarn test-coverage"
        description: "åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š"
        timeout: 300
        required: true
        coverage_threshold:
          statements: 80
          branches: 75
          functions: 80
          lines: 80
      
      - command: "yarn build"
        description: "ç”Ÿç”¢ç’°å¢ƒå»ºç½®"
        timeout: 600
        required: true
      
      - command: "yarn analyze"
        description: "åˆ†æ bundle å¤§å°"
        timeout: 300
        required: false

  # æ¢ä»¶ 4: Copilot ç·¨è¼¯å®Œæˆå¾Œ
  after_copilot_edit:
    enabled: true
    description: "Copilot å®Œæˆç¨‹å¼ç¢¼ç·¨è¼¯å¾Œè‡ªå‹•é©—è­‰"
    run_commands:
      - command: "yarn lint --fix"
        description: "è‡ªå‹•ä¿®å¾© lint å•é¡Œ"
        timeout: 120
        auto_fix: true
      
      - command: "yarn test --watch=false --browsers=ChromeHeadless"
        description: "åŸ·è¡Œå—å½±éŸ¿çš„æ¸¬è©¦"
        timeout: 300
        required: true

# ==========================================
# ğŸ”§ å‘½ä»¤é…ç½® (Command Configuration)
# ==========================================
commands:
  lint:
    command: "yarn lint"
    description: "åŸ·è¡Œ ESLint å’Œ Stylelint"
    working_directory: "."
    environment:
      NODE_ENV: "development"
    
    steps:
      - name: "TypeScript Lint"
        command: "yarn lint:ts"
        error_patterns:
          - "error"
          - "âœ–"
      
      - name: "Style Lint"
        command: "yarn lint:style"
        error_patterns:
          - "error"
          - "âœ–"
    
    on_success:
      action: "continue"
      message: "âœ… Lint æª¢æŸ¥é€šé"
    
    on_failure:
      action: "retry_with_fix"
      retry_command: "yarn lint --fix"
      message: "âŒ Lint æª¢æŸ¥å¤±æ•—ï¼Œå˜—è©¦è‡ªå‹•ä¿®å¾©..."
      max_retries: 1

  test:
    command: "yarn test --watch=false --browsers=ChromeHeadless"
    description: "åŸ·è¡Œå–®å…ƒæ¸¬è©¦"
    working_directory: "."
    environment:
      NODE_ENV: "test"
      CI: "true"
    
    on_success:
      action: "continue"
      message: "âœ… æ¸¬è©¦é€šé"
    
    on_failure:
      action: "report_details"
      message: "âŒ æ¸¬è©¦å¤±æ•—"
      extract_failures: true
      show_stack_trace: true

  test_coverage:
    command: "yarn test-coverage"
    description: "åŸ·è¡Œæ¸¬è©¦ä¸¦ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š"
    working_directory: "."
    environment:
      NODE_ENV: "test"
      CI: "true"
    
    coverage_report:
      format: "lcov"
      output_directory: "coverage"
      thresholds:
        statements: 80
        branches: 75
        functions: 80
        lines: 80
    
    on_success:
      action: "continue"
      message: "âœ… æ¸¬è©¦è¦†è“‹ç‡é”æ¨™"
      save_report: true
    
    on_failure:
      action: "report_details"
      message: "âš ï¸ æ¸¬è©¦è¦†è“‹ç‡æœªé”æ¨™"
      show_coverage_diff: true

  build:
    command: "yarn build"
    description: "åŸ·è¡Œç”Ÿç”¢å»ºç½®"
    working_directory: "."
    environment:
      NODE_ENV: "production"
    
    on_success:
      action: "continue"
      message: "âœ… å»ºç½®æˆåŠŸ"
      save_artifacts:
        - "dist/**/*"
    
    on_failure:
      action: "report_details"
      message: "âŒ å»ºç½®å¤±æ•—"
      extract_errors: true
      show_compilation_errors: true

  analyze:
    command: "yarn analyze"
    description: "åˆ†æ bundle å¤§å°"
    working_directory: "."
    
    bundle_size_limits:
      initial:
        warning: "2mb"
        error: "6mb"
      anyComponentStyle:
        warning: "6kb"
        error: "10kb"
    
    on_success:
      action: "continue"
      message: "âœ… Bundle å¤§å°ç¬¦åˆé™åˆ¶"
      generate_report: true
    
    on_failure:
      action: "warn"
      message: "âš ï¸ Bundle å¤§å°è¶…éé™åˆ¶"

# ==========================================
# ğŸ”„ åŸ·è¡Œæµç¨‹ (Execution Flow)
# ==========================================
workflows:
  # æµç¨‹ 1: å¿«é€Ÿæª¢æŸ¥ (Quick Check)
  quick_check:
    name: "å¿«é€Ÿæª¢æŸ¥"
    description: "é©ç”¨æ–¼å°å‹è®Šæ›´ï¼Œå¿«é€Ÿé©—è­‰"
    parallel: true
    steps:
      - name: "Lint"
        command: "lint"
        required: true
      
      - name: "Type Check"
        command: "tsc --noEmit"
        required: true

  # æµç¨‹ 2: æ¨™æº–æª¢æŸ¥ (Standard Check)
  standard_check:
    name: "æ¨™æº–æª¢æŸ¥"
    description: "é©ç”¨æ–¼ä¸€èˆ¬é–‹ç™¼ï¼ŒåŒ…å«æ¸¬è©¦"
    parallel: false
    steps:
      - name: "Lint"
        command: "lint"
        required: true
      
      - name: "Test"
        command: "test"
        required: true
      
      - name: "Build"
        command: "build"
        required: true

  # æµç¨‹ 3: å®Œæ•´æª¢æŸ¥ (Full Check)
  full_check:
    name: "å®Œæ•´æª¢æŸ¥"
    description: "é©ç”¨æ–¼ PR æˆ–é‡è¦è®Šæ›´ï¼ŒåŒ…å«æ‰€æœ‰æª¢æŸ¥"
    parallel: false
    steps:
      - name: "Lint"
        command: "lint"
        required: true
      
      - name: "Test with Coverage"
        command: "test_coverage"
        required: true
      
      - name: "Build"
        command: "build"
        required: true
      
      - name: "Analyze Bundle"
        command: "analyze"
        required: false

  # æµç¨‹ 4: Pre-commit Hook
  pre_commit:
    name: "æäº¤å‰æª¢æŸ¥"
    description: "Git commit å‰åŸ·è¡Œ"
    parallel: false
    steps:
      - name: "Lint and Fix"
        command: "yarn lint --fix"
        required: true
        auto_fix: true
      
      - name: "Test Changed Files"
        command: "yarn test --watch=false --browsers=ChromeHeadless"
        required: true

# ==========================================
# âš™ï¸ è‡ªå‹•åŒ–è¨­å®š (Automation Settings)
# ==========================================
automation:
  # è‡ªå‹•ä¿®å¾©
  auto_fix:
    enabled: true
    fix_on_save: true
    commands:
      - "yarn lint:ts --fix"
      - "yarn lint:style --fix"
  
  # è‡ªå‹•æ¸¬è©¦
  auto_test:
    enabled: true
    test_on_save: false
    test_on_commit: true
    watch_mode: false
  
  # è‡ªå‹•å»ºç½®
  auto_build:
    enabled: false
    build_on_commit: false
    build_on_pr: true
  
  # é€šçŸ¥è¨­å®š
  notifications:
    enabled: true
    show_success: true
    show_failure: true
    show_warnings: true
    channels:
      - "terminal"
      - "notification_center"

# ==========================================
# ğŸ“Š å ±å‘Šé…ç½® (Reporting Configuration)
# ==========================================
reporting:
  # æ¸¬è©¦å ±å‘Š
  test_report:
    enabled: true
    format: "html"
    output_path: "test-results"
    include_stack_traces: true
  
  # è¦†è“‹ç‡å ±å‘Š
  coverage_report:
    enabled: true
    format: "lcov"
    output_path: "coverage"
    show_uncovered_files: true
  
  # Lint å ±å‘Š
  lint_report:
    enabled: true
    format: "json"
    output_path: "lint-results"
    include_warnings: true
  
  # Bundle åˆ†æå ±å‘Š
  bundle_report:
    enabled: true
    format: "html"
    output_path: "bundle-analysis"

# ==========================================
# ğŸ® Copilot æ•´åˆ (Copilot Integration)
# ==========================================
copilot_integration:
  # åœ¨ Copilot å®Œæˆç·¨è¼¯å¾Œ
  after_edit:
    run_workflow: "standard_check"
    wait_for_completion: true
    show_progress: true
  
  # åœ¨ Copilot å»ºè­°ç¨‹å¼ç¢¼æ™‚
  before_suggestion:
    validate_syntax: true
    check_linting: true
  
  # åœ¨ä½¿ç”¨è€…æ¥å—å»ºè­°å¾Œ
  after_accept:
    format_code: true
    organize_imports: true
    run_quick_check: true

# ==========================================
# ğŸš¨ éŒ¯èª¤è™•ç† (Error Handling)
# ==========================================
error_handling:
  # Lint éŒ¯èª¤
  lint_errors:
    action: "auto_fix_if_possible"
    show_details: true
    suggest_solutions: true
  
  # æ¸¬è©¦éŒ¯èª¤
  test_errors:
    action: "report_details"
    show_stack_trace: true
    suggest_fixes: true
    run_debugger: false
  
  # å»ºç½®éŒ¯èª¤
  build_errors:
    action: "report_details"
    show_compilation_errors: true
    suggest_type_fixes: true

# ==========================================
# ğŸ“ ä½¿ç”¨æ–¹å¼ (Usage)
# ==========================================
usage:
  description: |
    æ­¤é…ç½®æª”æ¡ˆæœƒè‡ªå‹•åœ¨ä»¥ä¸‹æƒ…å¢ƒåŸ·è¡Œæ¸¬è©¦æµç¨‹ï¼š
    
    1. **æª”æ¡ˆå„²å­˜æ™‚** (File Save):
       - è‡ªå‹•åŸ·è¡Œ lint --fix
       - è‡ªå‹•æ ¼å¼åŒ–ç¨‹å¼ç¢¼
    
    2. **Git Commit å‰** (Pre-commit):
       - åŸ·è¡Œ yarn lint
       - åŸ·è¡Œ yarn test
       - åŸ·è¡Œ yarn build (å¯é¸)
    
    3. **PR å»ºç«‹/æ›´æ–°æ™‚** (Pull Request):
       - åŸ·è¡Œå®Œæ•´çš„æ¸¬è©¦å¥—ä»¶
       - ç”¢ç”Ÿè¦†è“‹ç‡å ±å‘Š
       - åˆ†æ bundle å¤§å°
    
    4. **Copilot ç·¨è¼¯å¾Œ** (After Copilot Edit):
       - é©—è­‰èªæ³•
       - åŸ·è¡Œç›¸é—œæ¸¬è©¦
       - æª¢æŸ¥ lint è¦å‰‡
  
  examples:
    - name: "æ‰‹å‹•åŸ·è¡Œå¿«é€Ÿæª¢æŸ¥"
      command: "@copilot run quick_check"
    
    - name: "æ‰‹å‹•åŸ·è¡Œå®Œæ•´æª¢æŸ¥"
      command: "@copilot run full_check"
    
    - name: "åªåŸ·è¡Œ lint"
      command: "@copilot run lint"
    
    - name: "åªåŸ·è¡Œæ¸¬è©¦"
      command: "@copilot run test"

# ==========================================
# ğŸ”— ç›¸é—œæª”æ¡ˆ (Related Files)
# ==========================================
related_files:
  - ".github/workflows/ci.yml"
  - ".github/copilot/agents/tests.yml"
  - ".github/copilot/agents/lint.yml"
  - ".github/copilot/agents/ci.yml"
  - "package.json"
  - "eslint.config.mjs"
  - "stylelint.config.mjs"
  - "angular.json"
  - "karma.conf.js"

# ==========================================
# ğŸ“Œ æ³¨æ„äº‹é … (Notes)
# ==========================================
notes:
  - "æ­¤é…ç½®éœ€è¦ GitHub Copilot Workspace æ”¯æ´"
  - "å»ºè­°åœ¨ .husky/pre-commit ä¸­æ•´åˆ pre_commit workflow"
  - "æ¸¬è©¦åŸ·è¡Œæ™‚é–“å¯èƒ½è¼ƒé•·ï¼Œå»ºè­°æ ¹æ“šå°ˆæ¡ˆè¦æ¨¡èª¿æ•´ timeout"
  - "è¦†è“‹ç‡é–¾å€¼å¯æ ¹æ“šå°ˆæ¡ˆéœ€æ±‚èª¿æ•´"
  - "Bundle å¤§å°é™åˆ¶å·²è¨­å®šæ–¼ angular.json ä¸­"
