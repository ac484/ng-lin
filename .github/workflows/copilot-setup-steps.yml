name: "Copilot Setup Steps"

# This workflow customizes the GitHub Copilot Coding Agent environment
# Reference: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment
#
# IMPORTANT: The job name MUST be "copilot-setup-steps" for Copilot to recognize it
#
# This workflow:
# 1. Sets up the Node.js environment matching the project's .nvmrc
# 2. Installs project dependencies using Yarn
# 3. Makes repository secrets available to Copilot Coding Agent
# 4. Configures environment variables for MCP servers (Model Context Protocol)
#
# Required Secrets (configured in Repository Settings > Secrets and variables > Actions):
# - COPILOT_MCP_CONTEXT7: API key for Context7 MCP server (documentation access)
# - SUPABASE_PROJECT_REF: Supabase project reference ID
# - SUPABASE_MCP_TOKEN: Supabase MCP authentication token
# - POSTGRES_CONNECTION_STRING: PostgreSQL connection string for MCP server
# - REDIS_CONNECTION_STRING: Redis connection string for MCP server
# - MCP_MEMORY_FILE_PATH: Memory file path for MCP memory server
# - CI_TOKEN: GitHub token for CI operations
# - SURGE_LOGIN: Surge.sh login for preview deployments
# - SURGE_TOKEN: Surge.sh token for preview deployments
#
# These secrets are referenced in:
# - .github/copilot/mcp-servers.yml (MCP server configuration)
# - .github/copilot/agents/config.yml (agent configuration)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/copilot-setup-steps.yml"
      - ".github/copilot/**"
      - "package.json"
      - "yarn.lock"
  pull_request:
    paths:
      - ".github/workflows/copilot-setup-steps.yml"
      - ".github/copilot/**"
      - "package.json"
      - "yarn.lock"

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    
    # Minimal permissions for security best practices
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          
      - name: Enable Corepack for Yarn
        run: corepack enable
        
      - name: Install dependencies
        run: yarn install --immutable
        
      - name: Verify installation
        run: |
          echo "Node version: $(node --version)"
          echo "Yarn version: $(yarn --version)"
          echo "Angular CLI version:"
          npx ng version
          
    # Environment variables for Copilot Coding Agent
    # These are available during the setup steps
    env:
      NODE_ENV: development
      
      # MCP Server Secrets
      # These secrets are used by .github/copilot/mcp-servers.yml
      COPILOT_MCP_CONTEXT7: ${{ secrets.COPILOT_MCP_CONTEXT7 }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_MCP_TOKEN: ${{ secrets.SUPABASE_MCP_TOKEN }}
      POSTGRES_CONNECTION_STRING: ${{ secrets.POSTGRES_CONNECTION_STRING }}
      REDIS_CONNECTION_STRING: ${{ secrets.REDIS_CONNECTION_STRING }}
      MCP_MEMORY_FILE_PATH: ${{ secrets.MCP_MEMORY_FILE_PATH }}
      
      # CI/CD Secrets
      CI_TOKEN: ${{ secrets.CI_TOKEN }}
      SURGE_LOGIN: ${{ secrets.SURGE_LOGIN }}
      SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
